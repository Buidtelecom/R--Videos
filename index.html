<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Videos Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body, html { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background-color: black; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overscroll-behavior-y: contain; }
        .snap-y-mandatory { scroll-snap-type: y mandatory; }
        .snap-start { scroll-snap-align: start; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-spin-slow { animation: spin 4s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .like-animation { animation: pop 0.3s ease-in-out; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; z-index: 10; background: black; }
        .screen.active { display: flex; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; width: 100%; height: 75%; background: #111; border-t-left-radius: 16px; border-t-right-radius: 16px; z-index: 60; transform: translateY(100%); transition: transform 0.3s ease-out; display: flex; flex-direction: column; }
        .bottom-sheet.open { transform: translateY(0); }
        .full-screen-modal { position: fixed; inset: 0; background: #000; z-index: 70; transform: translateX(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .full-screen-modal.open { transform: translateX(0); }
        .liked svg { fill: #ef4444; color: #ef4444; }
        .favorited svg { fill: #eab308; color: #eab308; }
        .text-shadow { text-shadow: 1px 1px 2px rgba(0,0,0,0.8); }
        .icon-shadow { filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.5)); }
        .auth-input { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; }
        .msg-bubble { max-width: 75%; padding: 8px 12px; border-radius: 16px; margin-bottom: 2px; font-size: 14px; position: relative; word-break: break-word; }
        .msg-me { align-self: flex-end; background-color: #ef4444; color: white; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background-color: #333; color: white; border-bottom-left-radius: 4px; }
        .msg-status { align-self: flex-end; margin-bottom: 8px; margin-right: 4px; display: flex; align-items: center; }
        .verified-badge { fill: #3b82f6; color: white; display: inline-block; vertical-align: middle; margin-left: 4px; }
        .custom-checkbox { accent-color: #ef4444; width: 16px; height: 16px; cursor: pointer; }
        
        /* Watermark Style */
        .app-watermark { position: absolute; top: 16px; left: 16px; z-index: 30; font-weight: 900; font-size: 16px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); pointer-events: none; font-family: sans-serif; }

        /* Pull to refresh styles */
        #ptr-loader { transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); z-index: 9999; }
        .ptr-icon { transition: transform 0.2s; }
        .body-content { transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); height: 100%; width: 100%; }

        .big-heart { position: absolute; transform: translate(-50%, -50%) scale(0); animation: bigHeartAnim 0.8s ease-out forwards; pointer-events: none; z-index: 50; }
        @keyframes bigHeartAnim {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-15deg); opacity: 1; }
            15% { transform: translate(-50%, -50%) scale(1.5) rotate(0deg); opacity: 1; }
            30% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 0; }
        }
    </style>
</head>
<body class="relative overflow-hidden">
    <!-- LOADER ACTUALISATION -->
    <div id="ptr-loader" class="fixed top-0 left-0 w-full flex justify-center pt-4 -translate-y-16 pointer-events-none">
        <div class="bg-white rounded-full p-2 shadow-xl border border-gray-200">
            <svg id="ptr-spinner" class="w-6 h-6 text-red-600 animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <i id="ptr-arrow" data-lucide="arrow-down" class="w-6 h-6 text-black"></i>
        </div>
    </div>

    <!-- TOAST DE TELECHARGEMENT -->
    <div id="download-toast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-4 rounded-xl flex flex-col items-center gap-2 z-[100] hidden transition-opacity">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"></div>
        <span class="text-sm font-bold">Téléchargement...</span>
    </div>

    <div id="main-app-container" class="body-content relative">
        <!-- CONFIGURATION -->
        <script>
            const CLOUDINARY_CLOUD_NAME = "dh68eblab"; 
            const CLOUDINARY_UPLOAD_PRESET = "uxyhxrib"; 
            const VIP_EMAIL = "virgulemili@gmail.com"; 
        </script>

        <!-- AUTH -->
        <div id="auth-screen" class="screen active justify-center items-center p-8 bg-gradient-to-br from-gray-900 to-black relative">
            <div class="absolute top-12 w-full text-center">
                <p class="text-[10px] text-gray-500 uppercase tracking-[0.2em] font-medium">
                    Application créée par <br>
                    <span class="text-gray-400 font-bold">"Le Studio Ralph Nyamè"</span>. 2025
                </p>
            </div>
            <div class="w-full max-w-sm text-center mt-10">
                <h1 class="text-4xl font-black mb-2 text-red-500 tracking-tighter">R-VIDEOS</h1>
                <p class="text-gray-400 mb-8 text-sm">Réseau Social Vidéo</p>

                <div id="auth-success" class="hidden mb-4 p-3 bg-green-900/50 border border-green-500 text-green-200 rounded-lg text-sm">Compte créé ! Connectez-vous.</div>
                
                <div id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="auth-input">
                    <div class="relative">
                        <input type="password" id="login-pass" placeholder="Mot de passe" class="auth-input pr-10">
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 cursor-pointer" onclick="togglePassword('login-pass', this)">
                            <i data-lucide="eye" class="w-5 h-5 eye"></i>
                            <i data-lucide="eye-off" class="w-5 h-5 eye-off hidden"></i>
                        </div>
                    </div>
                    <button id="btn-login" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition flex justify-center items-center h-12">Se connecter</button>
                    <p class="text-xs text-gray-400 mt-4">Pas encore de compte ? <span onclick="toggleAuthMode()" class="text-white font-bold cursor-pointer underline">S'inscrire</span></p>
                </div>

                <div id="register-form" class="space-y-4 hidden">
                    <input type="text" id="reg-username" placeholder="Nom d'utilisateur" class="auth-input">
                    <input type="email" id="reg-email" placeholder="Email (Gmail requis)" class="auth-input">
                    <div class="relative">
                        <input type="password" id="reg-pass" placeholder="Mot de passe" class="auth-input pr-10">
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 cursor-pointer" onclick="togglePassword('reg-pass', this)">
                            <i data-lucide="eye" class="w-5 h-5 eye"></i>
                            <i data-lucide="eye-off" class="w-5 h-5 eye-off hidden"></i>
                        </div>
                    </div>
                    <div class="flex items-start gap-2 text-left mt-2">
                        <input type="checkbox" id="reg-privacy" class="custom-checkbox mt-1">
                        <label for="reg-privacy" class="text-xs text-gray-400 leading-tight">En cochant cette case, j'accepte la <span onclick="openPrivacyPolicy()" class="text-blue-500 underline cursor-pointer">Politique de Confidentialité</span> de R-Videos.</label>
                    </div>
                    <button id="btn-register" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-lg transition mt-2 flex justify-center items-center h-12">Créer mon compte</button>
                    <p class="text-xs text-gray-400 mt-4">Déjà un compte ? <span onclick="toggleAuthMode()" class="text-white font-bold cursor-pointer underline">Se connecter</span></p>
                </div>
                
                <p id="auth-error" class="text-red-500 text-sm mt-4 hidden bg-red-900/30 p-2 rounded border border-red-800"></p>
            </div>
        </div>

        <!-- FEED -->
        <div id="feed-screen" class="screen relative">
            <div class="absolute top-0 left-0 w-full z-20 pt-4 pb-2 bg-gradient-to-b from-black/60 to-transparent pointer-events-none">
                <div class="flex justify-center items-center gap-4 text-base font-semibold pointer-events-auto">
                    <span id="tab-following" class="text-gray-400 cursor-pointer transition-colors" onclick="switchFeed('following')">Abonnements</span>
                    <span id="tab-foryou" class="text-white border-b-2 border-white pb-0.5 cursor-pointer shadow-lg transition-colors" onclick="switchFeed('foryou')">Pour toi</span>
                </div>
            </div>
            <div id="feed-container" class="h-full w-full overflow-y-scroll snap-y-mandatory no-scrollbar relative bg-black">
                <div id="loading-feed" class="flex items-center justify-center h-full text-gray-500"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div></div>
            </div>
        </div>
        
        <!-- FULL SCREEN VIDEO OVERLAY -->
        <div id="fullscreen-video-overlay" class="fixed inset-0 z-50 bg-black hidden flex-col">
            <div class="absolute top-0 left-0 w-full z-20 p-4">
                <i data-lucide="chevron-left" class="w-8 h-8 text-white cursor-pointer drop-shadow-md" onclick="closeFullVideo()"></i>
            </div>
            <div id="fullscreen-video-container" class="w-full h-full relative"></div>
        </div>

        <!-- DECOUVRIR -->
        <div id="discover-screen" class="screen bg-black pt-4 px-4 pb-20">
            <h2 class="font-bold text-xl mb-4">Découvrir</h2>
            <div class="relative mb-6">
                <i data-lucide="search" class="absolute left-3 top-3 text-gray-400 w-5 h-5"></i>
                <input type="text" id="search-input" placeholder="Rechercher des utilisateurs..." class="w-full bg-gray-900 rounded-lg py-3 pl-10 pr-4 text-white outline-none focus:ring-1 focus:ring-gray-700" oninput="searchUsers(this.value)">
            </div>
            <div id="search-results" class="space-y-4 overflow-y-auto h-full pb-20">
                <div class="text-gray-500 text-center text-sm mt-10">Tapez un nom pour chercher...</div>
            </div>
        </div>

        <!-- BOITE (INBOX) -->
        <div id="inbox-screen" class="screen bg-black pt-4 px-0 pb-20">
            <h2 class="font-bold text-xl mb-4 px-4">Boîte de réception</h2>
            <div class="flex border-b border-gray-800 px-4 mb-4">
                <div onclick="switchInboxTab('activities')" id="tab-activities" class="pb-2 border-b-2 border-white font-semibold mr-6 cursor-pointer">Activités</div>
                <div onclick="switchInboxTab('messages')" id="tab-messages" class="pb-2 text-gray-500 font-semibold cursor-pointer">Messages</div>
            </div>
            <div id="inbox-content" class="px-4 space-y-4 overflow-y-auto h-full pb-20"></div>
        </div>

        <!-- PROFIL -->
        <div id="profile-screen" class="screen bg-black pt-10 px-4 overflow-y-auto pb-20">
            <div class="flex justify-between items-center mb-6">
                <i data-lucide="chevron-left" class="w-6 h-6 text-white cursor-pointer" onclick="navigateTo('feed')"></i>
                <h2 class="font-bold text-lg" id="profile-header-name">Profil</h2>
                <i data-lucide="more-horizontal" class="w-6 h-6 text-white cursor-pointer" onclick="confirmLogout()"></i>
            </div>
            <div class="flex flex-col items-center mb-8">
                <div id="profile-avatar-container" class="w-24 h-24 rounded-full border-2 border-gray-700 flex items-center justify-center mb-4 overflow-hidden bg-gray-800"></div>
                <div class="flex items-center gap-1 mb-1">
                    <h1 id="profile-handle" class="text-xl font-bold">@utilisateur</h1>
                    <span id="profile-badge-container"></span>
                </div>
                <p id="profile-bio" class="text-gray-400 text-sm mb-4 text-center max-w-xs">...</p>
                <div class="flex gap-6 mt-2 text-center">
                    <div><div class="font-bold text-lg" id="profile-followers">0</div><div class="text-xs text-gray-400">Abonnés</div></div>
                    <div><div class="font-bold text-lg" id="profile-likes">0</div><div class="text-xs text-gray-400">J'aime</div></div>
                </div>
                
                <div id="my-profile-actions" class="flex gap-2 mt-6 w-full px-8 hidden">
                    <button onclick="openEditProfile()" class="flex-1 bg-gray-800 py-2 rounded text-sm font-semibold border border-gray-600">Modifier le profil</button>
                </div>
                <div id="other-profile-actions" class="flex gap-2 mt-6 w-full px-8 hidden">
                    <button id="btn-follow" onclick="toggleFollow()" class="flex-1 bg-red-600 text-white py-2 rounded text-sm font-semibold transition-colors">S'abonner</button>
                    <button onclick="startChat()" class="flex-1 bg-gray-800 text-white py-2 rounded text-sm font-semibold border border-gray-600">Message</button>
                    <!-- BOUTON BLOQUER -->
                    <button id="btn-block" onclick="toggleBlock()" class="bg-gray-900 border border-red-900 text-red-500 py-2 px-3 rounded text-sm font-semibold"><i data-lucide="shield-off" class="w-4 h-4"></i></button>
                </div>
            </div>
            
            <!-- TABS PROFIL -->
            <div class="flex border-b border-gray-800 mb-1">
                <div id="tab-profile-videos" class="flex-1 py-3 text-center border-b-2 border-white cursor-pointer transition-colors" onclick="switchProfileTab('videos')">
                    <i data-lucide="grid-3x3" class="mx-auto w-5 h-5"></i>
                </div>
                <div id="tab-profile-favs" class="flex-1 py-3 text-center border-b-2 border-transparent text-gray-500 cursor-pointer transition-colors" onclick="switchProfileTab('favs')">
                    <i data-lucide="bookmark" class="mx-auto w-5 h-5"></i>
                </div>
            </div>

            <div id="profile-videos-grid" class="grid grid-cols-3 gap-0.5 mt-1"></div>
        </div>

        <!-- CHAT SCREEN -->
        <div id="chat-screen" class="full-screen-modal">
            <div class="flex items-center p-4 border-b border-gray-800 bg-gray-900">
                <i data-lucide="chevron-left" class="w-6 h-6 cursor-pointer mr-4" onclick="closeChat()"></i>
                <div class="flex items-center gap-3">
                    <div id="chat-avatar" class="w-8 h-8 rounded-full bg-gray-700 overflow-hidden"></div>
                    <div class="flex items-center gap-1">
                        <div id="chat-username" class="font-bold">Utilisateur</div>
                        <span id="chat-badge-container"></span>
                    </div>
                </div>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col bg-black"></div>
            <div class="p-3 bg-gray-900 flex items-center gap-2">
                <input type="text" id="chat-input" placeholder="Envoyer..." class="flex-1 bg-gray-800 border-none rounded-full px-4 py-2 text-sm text-white outline-none">
                <button onclick="sendMessage()" class="bg-red-600 p-2 rounded-full"><i data-lucide="send" class="w-4 h-4 text-white"></i></button>
            </div>
        </div>

        <!-- MODALS -->
        <div id="privacy-modal" class="modal-overlay">
            <div class="bg-gray-900 w-11/12 max-w-lg p-6 rounded-xl border border-gray-700 max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                    <h3 class="text-lg font-bold">Politique de Confidentialité</h3>
                    <i data-lucide="x" class="cursor-pointer" onclick="closeModal('privacy-modal')"></i>
                </div>
                <div class="overflow-y-auto text-sm text-gray-300 space-y-4 pr-2">
                    <p class="font-bold text-white">Dernière mise à jour : 2025</p>
                    <p>Bienvenue sur R-Videos. Votre confidentialité est notre priorité.</p>
                    <h4 class="font-bold text-white">1. Informations Collectées</h4>
                    <ul class="list-disc pl-5"><li>Informations de profil (Nom, Email, Photo, Bio).</li><li>Contenu utilisateur (Vidéos, Commentaires, Messages).</li></ul>
                    <h4 class="font-bold text-white">2. Utilisation des Données</h4>
                    <p>Pour fournir et améliorer nos services.</p>
                    <h4 class="font-bold text-white">3. Vos Droits</h4>
                    <p>Vous avez le droit d'accéder à vos données ou de supprimer votre compte.</p>
                </div>
                <button onclick="closeModal('privacy-modal')" class="mt-4 w-full bg-gray-800 py-2 rounded text-white font-bold">Fermer</button>
            </div>
        </div>

        <div id="edit-modal" class="modal-overlay">
            <div class="bg-gray-900 w-11/12 max-w-md p-6 rounded-xl border border-gray-700">
                <h3 class="text-lg font-bold mb-4">Modifier le profil</h3>
                <label class="block text-xs text-gray-400 mb-1">Photo de profil</label>
                <input type="file" id="edit-file-input" accept="image/*" class="block w-full text-sm text-gray-400 file:bg-gray-800 file:text-white mb-4"/>
                <input type="text" id="edit-username" placeholder="Nom d'utilisateur" class="auth-input mb-3">
                <textarea id="edit-bio" placeholder="Bio" class="auth-input mb-4" rows="3"></textarea>
                <div class="flex gap-2 mb-4">
                    <button onclick="closeModal('edit-modal')" class="flex-1 py-2 bg-gray-800 rounded">Annuler</button>
                    <button id="btn-save-profile" onclick="saveProfileChanges()" class="flex-1 py-2 bg-white text-black font-bold rounded flex justify-center items-center">Enregistrer</button>
                </div>
                <div class="border-t border-gray-800 pt-4">
                    <button onclick="confirmDeleteAccount()" class="w-full text-red-500 font-bold text-sm py-2 hover:bg-red-900/20 rounded">Supprimer mon compte</button>
                </div>
            </div>
        </div>

        <!-- MODAL CONFIRMATION SUPPRESSION -->
        <div id="delete-confirm-modal" class="modal-overlay">
            <div class="bg-gray-900 w-10/12 max-w-sm p-6 rounded-xl border border-gray-700 text-center">
                <h3 class="text-lg font-bold mb-2 text-white text-red-500" id="delete-modal-title">Supprimer ?</h3>
                <p class="text-gray-400 text-sm mb-6">Cette action est irréversible.</p>
                <div class="flex gap-3">
                    <button onclick="closeModal('delete-confirm-modal')" class="flex-1 py-2 bg-gray-800 text-white rounded font-semibold text-sm">Annuler</button>
                    <button id="btn-confirm-delete" class="flex-1 py-2 bg-red-600 text-white rounded font-semibold text-sm">Supprimer</button>
                </div>
            </div>
        </div>

        <div id="logout-modal" class="modal-overlay">
            <div class="bg-gray-900 w-10/12 max-w-sm p-6 rounded-xl border border-gray-700 text-center">
                <h3 class="text-lg font-bold mb-2 text-white">Déconnexion</h3>
                <div class="flex gap-3">
                    <button onclick="closeModal('logout-modal')" class="flex-1 py-2 bg-gray-800 text-white rounded font-semibold text-sm">Non</button>
                    <button onclick="logout()" class="flex-1 py-2 bg-red-600 text-white rounded font-semibold text-sm">Oui</button>
                </div>
            </div>
        </div>

        <div id="upload-modal" class="modal-overlay">
            <div class="bg-gray-900 w-full h-full md:h-auto md:w-11/12 max-w-md p-6 md:rounded-xl flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">Nouvelle Publication</h3>
                    <i data-lucide="x" class="cursor-pointer" onclick="closeModal('upload-modal')"></i>
                </div>
                <div class="flex-1 flex flex-col gap-4">
                    <div class="border-2 border-dashed border-gray-700 rounded-lg h-64 flex flex-col items-center justify-center relative bg-black overflow-hidden" id="upload-preview-area">
                        <i data-lucide="upload-cloud" class="w-12 h-12 text-gray-500 mb-2"></i>
                        <p class="text-gray-500 text-sm">Sélectionner une vidéo</p>
                        <input type="file" id="video-file-input" accept="video/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="previewVideoUpload(this)">
                        <video id="video-preview" class="absolute inset-0 w-full h-full object-cover hidden" loop playsinline></video>
                    </div>
                    <textarea id="video-desc" placeholder="Décris ta vidéo..." class="auth-input h-24 resize-none"></textarea>
                </div>
                <div id="upload-status" class="text-xs text-center text-gray-400 h-4"></div>
                <button onclick="uploadVideo()" id="btn-publish" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg mt-2 flex justify-center items-center">Publier</button>
            </div>
        </div>

        <div id="comments-sheet" class="bottom-sheet">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900 rounded-t-xl">
                <div class="text-sm font-bold mx-auto">Commentaires</div>
                <i data-lucide="x" class="w-5 h-5 cursor-pointer absolute right-4" onclick="closeComments()"></i>
            </div>
            <div id="comments-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
            <div class="p-3 border-t border-gray-800 bg-black flex items-center gap-2">
                <input type="text" id="comment-input" placeholder="Ajouter un commentaire..." class="flex-1 bg-gray-900 border-none rounded-full px-4 py-2 text-sm text-white outline-none">
                <button onclick="sendComment()" class="text-cyan-500 font-bold text-sm px-2">Publier</button>
            </div>
        </div>

        <!-- NAVBAR PERSONNALISÉE -->
        <div id="bottom-nav" class="fixed bottom-0 left-0 w-full bg-black border-t border-gray-800 h-14 z-30 flex justify-around items-center text-white px-2 hidden">
            <div onclick="navigateTo('feed')" class="flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-100" id="nav-feed"><i data-lucide="home" class="w-6 h-6 fill-white"></i><span class="text-[10px]">Accueil</span></div>
            <div onclick="navigateTo('discover')" class="flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-50" id="nav-discover"><i data-lucide="search" class="w-6 h-6"></i><span class="text-[10px]">Découvrir</span></div>
            <div onclick="openUploadModal()" class="cursor-pointer hover:scale-105 transition duration-200 flex items-center justify-center"><div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg shadow-white/20"><i data-lucide="plus" class="w-6 h-6 text-black font-bold"></i></div></div>
            <div onclick="navigateTo('inbox')" class="relative flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-50" id="nav-inbox"><div class="relative"><i data-lucide="message-square" class="w-6 h-6"></i><div id="inbox-badge" class="absolute -top-1 -right-2 bg-red-600 text-white text-[9px] font-bold px-1 py-0.5 rounded-full hidden border border-black min-w-[18px] text-center">0</div></div><span class="text-[10px]">Boîte</span></div>
            <div onclick="openMyProfile()" class="flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-50" id="nav-profile"><i data-lucide="user" class="w-6 h-6"></i><span class="text-[10px]">Profil</span></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, deleteUser } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, updateDoc, limit, arrayUnion, arrayRemove, increment, where, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCfiExPZwsF53-Ix3cCeIa3tq1MJ5359RU", authDomain: "nanofinance-9192a.firebaseapp.com", projectId: "nanofinance-9192a", storageBucket: "nanofinance-9192a.firebasestorage.app", messagingSenderId: "376434082116", appId: "1:376434082116:web:838ef702670608bc959711", measurementId: "G-9455DCWCNL" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserData = null;
        let videoObserver = null;
        let unreadObserver = null;
        let isRegistering = false;
        let currentVideoIdForComments = null;
        let currentVideoAuthorId = null; 
        let currentProfileUid = null;
        let currentChatId = null;
        let currentChatReceiver = null;
        let viewedVideos = new Set();
        let isInitialLoad = true;
        let inboxUnsubscribe = null;
        let profileVideosData = {};
        let currentProfileTab = 'videos'; 
        let currentFeedMode = 'foryou';
        
        let totalUnreadNotifications = 0;
        let totalUnreadChats = 0;
        
        window.feedUnsubscribe = null;

        // --- XSS HELPER ---
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        window.togglePassword = (inputId, iconContainer) => {
            const input = document.getElementById(inputId);
            const eye = iconContainer.querySelector('.eye');
            const eyeOff = iconContainer.querySelector('.eye-off');
            if (input.type === "password") { input.type = "text"; eye.classList.add('hidden'); eyeOff.classList.remove('hidden'); } 
            else { input.type = "password"; eye.classList.remove('hidden'); eyeOff.classList.add('hidden'); }
        };

        function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }
        
        function updateGlobalBadge() {
            const total = totalUnreadNotifications + totalUnreadChats;
            const badge = document.getElementById('inbox-badge');
            if (total > 0) {
                badge.classList.remove('hidden');
                badge.innerText = total > 99 ? "+99" : total;
            } else {
                badge.classList.add('hidden');
            }
        }

        function getBadgeHtml(isVerified) {
            if (!isVerified) return '';
            return `<svg class="w-4 h-4 ml-1 inline-block align-middle" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.5 12.5C22.5 14.08 21.625 15.45 20.352 16.1C20.372 16.27 20.384 16.44 20.384 16.614C20.384 18.824 18.676 20.614 16.566 20.614C16.096 20.614 15.646 20.528 15.231 20.365C14.61 21.698 13.304 22.614 11.792 22.614C10.28 22.614 8.974 21.698 8.353 20.365C7.938 20.528 7.488 20.614 7.018 20.614C4.908 20.614 3.2 18.824 3.2 16.614C3.2 16.44 3.212 16.27 3.232 16.1C1.959 15.45 1.084 14.08 1.084 12.5C1.084 10.92 1.959 9.55 3.232 8.9C3.212 8.73 3.2 8.56 3.2 8.386C3.2 6.176 4.908 4.386 7.018 4.386C7.488 4.386 7.938 4.472 8.353 4.635C8.974 3.302 10.28 2.386 11.792 2.386C13.304 2.386 14.61 3.302 15.231 4.635C15.646 4.472 16.096 4.386 16.566 4.386C18.676 4.386 20.384 6.176 20.384 8.386C20.384 8.56 20.372 8.73 20.352 8.9C21.625 9.55 22.5 10.92 22.5 12.5Z" fill="#20D5EC"/><path d="M10.09 17.1L5.39 12.4L6.8 10.99L10.09 14.28L17.19 7.18005L18.6 8.59005L10.09 17.1Z" fill="white"/></svg>`;
        }

        function getAvatarHTML(photoURL, sizeClass = "w-full h-full") {
            if (photoURL && photoURL.length > 5) {
                const optimizedUrl = photoURL.includes('cloudinary') ? photoURL.replace('/upload/', '/upload/w_200,c_fill,q_auto,f_auto/') : photoURL;
                return `<img src="${optimizedUrl}" class="${sizeClass} rounded-full object-cover border border-white">`;
            }
            return `<div class="${sizeClass} rounded-full bg-gray-700 flex items-center justify-center border border-white"><i data-lucide="user" class="text-gray-400 w-1/2 h-1/2"></i></div>`;
        }

        function formatCount(num) {
            if(!num) return "0";
            if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
            if(num >= 1000) return (num/1000).toFixed(1) + 'k';
            return num;
        }

        function getOptimizedVideoUrl(url, width = 720) {
            if (!url) return "";
            if (url.includes("cloudinary.com")) return url.replace('/upload/', `/upload/q_auto,f_auto,w_${width}/`);
            return url;
        }

        // --- DOWNLOAD VIDEO LOGIC (WITH WATERMARK) ---
        window.downloadVideo = async (url, videoId, username) => {
            let downloadUrl = url;
            if (url.includes("cloudinary")) {
                const safeUser = username ? username.replace(/[^a-zA-Z0-9_.-]/g, '') : 'User';
                // Filigrane: R-VIDEOS (Haut Droite) + @Username (Bas Droite)
                const watermark = `l_text:Arial_40_bold:R-VIDEOS,g_north_east,x_20,y_20,co_white,o_60/l_text:Arial_25_bold:@${safeUser},g_south_east,x_20,y_20,co_white,o_80`;
                downloadUrl = url.replace('/upload/', `/upload/${watermark}/f_mp4/`);
            }

            const toast = document.getElementById('download-toast');
            toast.classList.remove('hidden');

            try {
                const response = await fetch(downloadUrl);
                const blob = await response.blob();
                
                // Force MIME type to video/mp4
                const newBlob = new Blob([blob], { type: 'video/mp4' });
                const blobUrl = window.URL.createObjectURL(newBlob);
                
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = `R-Videos_${videoId}.mp4`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(blobUrl);
            } catch (e) {
                alert("Erreur téléchargement: " + e.message);
            } finally {
                toast.classList.add('hidden');
            }
        }

        function getVideoThumbnail(url) {
            if (!url) return "";
            if (url.includes("cloudinary.com")) {
                let newUrl = url.replace('/upload/', '/upload/w_300,q_auto,f_jpg,so_0/');
                return newUrl.replace(/\.[^/.]+$/, ".jpg"); 
            }
            return url;
        }

        async function uploadToCloudinary(file) {
            const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, { method: 'POST', body: formData });
            const data = await response.json(); return data.secure_url;
        }

        async function sendNotification(targetUid, type, text) {
            if(targetUid === auth.currentUser.uid) return;
            try {
                const targetUser = await getDoc(doc(db, "users", targetUid));
                if (targetUser.exists()) {
                    const data = targetUser.data();
                    if (data.blockedBy && data.blockedBy.includes(auth.currentUser.uid)) return; 
                    if (data.blockedUsers && data.blockedUsers.includes(auth.currentUser.uid)) return;
                }
                await addDoc(collection(db, "users", targetUid, "notifications"), { type, text, fromUid: auth.currentUser.uid, fromUsername: currentUserData.username, fromPhoto: currentUserData.photoURL, createdAt: serverTimestamp(), read: false });
            } catch(e) { console.log("Notif error:", e); }
        }

        function subscribeToUnreadCount() {
            if (unreadObserver) unreadObserver();
            const qChats = query(collection(db, "chats"), where("participants", "array-contains", auth.currentUser.uid));
            onSnapshot(qChats, (snapshot) => {
                let chatsUnread = 0;
                snapshot.forEach(d => {
                    const c = d.data();
                    const myUnread = (c.unreadCounts && c.unreadCounts[auth.currentUser.uid]) ? c.unreadCounts[auth.currentUser.uid] : 0;
                    chatsUnread += myUnread;
                });
                totalUnreadChats = chatsUnread;
                updateGlobalBadge();

                if (!isInitialLoad) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified' || change.type === 'added') {
                            const data = change.doc.data();
                            const myUnread = (data.unreadCounts && data.unreadCounts[auth.currentUser.uid]) ? data.unreadCounts[auth.currentUser.uid] : 0;
                            if (myUnread > 0 && data.lastMessage && currentChatId !== change.doc.id) {
                                const otherId = data.participants.find(p => p !== auth.currentUser.uid);
                                const senderName = data.names ? data.names[otherId] : "Quelqu'un";
                                if ("Notification" in window && Notification.permission === "granted") {
                                    try {
                                        const notif = new Notification("Nouveau message", { body: `@${senderName}: ${data.lastMessage}`, icon: data.photos ? data.photos[otherId] : "", tag: 'chat-msg' });
                                        notif.onclick = function() { window.focus(); this.close(); };
                                    } catch(e) {}
                                }
                            }
                        }
                    });
                }
            });

            const q = query(collection(db, "users", auth.currentUser.uid, "notifications"), limit(100));
            unreadObserver = onSnapshot(q, (snapshot) => {
                let notifUnread = 0;
                snapshot.forEach(doc => { if (doc.data().read === false) notifUnread++; });
                totalUnreadNotifications = notifUnread;
                updateGlobalBadge();

                if (!isInitialLoad) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const data = change.doc.data();
                            if (data.read === false) {
                                if ("Notification" in window && Notification.permission === "granted") {
                                    try {
                                        const notif = new Notification("R-Videos", { body: `@${data.fromUsername} ${data.text}`, icon: data.fromPhoto || "", tag: 'r-videos-alert', vibrate: [200, 100, 200] });
                                        notif.onclick = function() { window.focus(); this.close(); };
                                    } catch(e) {}
                                }
                            }
                        }
                    });
                }
                isInitialLoad = false;
            });
        }

        let deleteAction = null;
        window.confirmAction = (title, action) => {
            document.getElementById('delete-modal-title').innerText = title;
            deleteAction = action;
            document.getElementById('delete-confirm-modal').classList.add('open');
        };
        document.getElementById('btn-confirm-delete').onclick = () => {
            if (deleteAction) deleteAction();
            window.closeModal('delete-confirm-modal');
        };

        // --- DELETE ACCOUNT LOGIC ---
        window.confirmDeleteAccount = () => {
            window.closeModal('edit-modal');
            window.confirmAction("SUPPRIMER COMPTE ?", window.deleteAccount);
        };
        window.deleteAccount = async () => {
            const user = auth.currentUser;
            if (!user) return;
            try {
                // Delete user data doc
                await deleteDoc(doc(db, "users", user.uid));
                // Delete auth
                await deleteUser(user);
                alert("Compte supprimé avec succès.");
                window.location.reload();
            } catch (error) {
                if (error.code === 'auth/requires-recent-login') {
                    alert("Pour des raisons de sécurité, veuillez vous reconnecter avant de supprimer votre compte.");
                    await signOut(auth);
                } else {
                    alert("Erreur: " + error.message);
                }
            }
        };

        window.confirmDeleteVideo = (docId) => { 
            window.confirmAction("Supprimer la vidéo ?", async () => {
                try { await deleteDoc(doc(db, "videos", docId)); if(document.getElementById('profile-screen').classList.contains('active')) renderProfile(currentUserData, true); } catch(e) { alert("Erreur: " + e.message); }
            });
        };

        window.shareVideo = (url) => { if (navigator.share) navigator.share({ title: 'R-Videos', text: 'Regarde cette vidéo incroyable !', url: url }).catch(e=>{}); else navigator.clipboard.writeText(url).then(() => alert("Lien copié !")).catch(()=>{}); };
        window.toggleFavorite = async (docId, el) => { if(!auth.currentUser) return; const isFav = el.classList.contains('favorited'); const ref = doc(db, "videos", docId); if(isFav) { el.classList.remove('favorited'); el.querySelector('svg').classList.remove('fill-yellow-500', 'text-yellow-500'); await updateDoc(ref, { favorites: arrayRemove(auth.currentUser.uid) }); } else { el.classList.add('favorited'); el.querySelector('svg').classList.add('fill-yellow-500', 'text-yellow-500'); await updateDoc(ref, { favorites: arrayUnion(auth.currentUser.uid) }); } };
        window.toggleAuthMode = () => { document.getElementById('login-form').classList.toggle('hidden'); document.getElementById('register-form').classList.toggle('hidden'); document.getElementById('auth-error').classList.add('hidden'); };
        function showAuthError(msg) { const err = document.getElementById('auth-error'); err.innerText = msg; err.classList.remove('hidden'); }
        window.openPrivacyPolicy = () => document.getElementById('privacy-modal').classList.add('open');

        document.getElementById('btn-register').addEventListener('click', async () => {
            const email = document.getElementById('reg-email').value, pass = document.getElementById('reg-pass').value, username = document.getElementById('reg-username').value;
            const privacyChecked = document.getElementById('reg-privacy').checked;
            document.getElementById('auth-error').classList.add('hidden');
            if (!email || !pass || !username) { showAuthError("Veuillez remplir tous les champs."); return; }
            if (!email.toLowerCase().endsWith('@gmail.com')) { showAuthError("Adresse Gmail (@gmail.com) obligatoire."); return; }
            if (!privacyChecked) { showAuthError("Veuillez accepter la politique de confidentialité."); return; }
            
            requestNotificationPermission();

            const btn = document.getElementById('btn-register'); const originalText = btn.innerText; btn.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mx-auto"></div>`; btn.disabled = true;
            try {
                isRegistering = true; const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const isVerified = email === VIP_EMAIL;
                
                await setDoc(doc(db, "users", cred.user.uid), { 
                    username: escapeHtml(username), email, photoURL: "", bio: "Nouveau membre", 
                    followers: [], following: [], blockedUsers: [], blockedBy: [], uid: cred.user.uid, 
                    isVerified: isVerified, 
                    createdAt: serverTimestamp() 
                });
                await updateProfile(cred.user, { displayName: username });
                
                if (email !== VIP_EMAIL) {
                    const qAdmin = query(collection(db, "users"), where("email", "==", VIP_EMAIL));
                    const snapAdmin = await getDocs(qAdmin);
                    snapAdmin.forEach(async (docAdmin) => {
                        await addDoc(collection(db, "users", docAdmin.id, "notifications"), {
                            type: 'info', text: `vient de rejoindre l'application !`,
                            fromUid: cred.user.uid, fromUsername: username, fromPhoto: "", 
                            createdAt: serverTimestamp(), read: false
                        });
                    });
                }

                await signOut(auth); isRegistering = false; window.toggleAuthMode();
                document.getElementById('auth-success').classList.remove('hidden'); document.getElementById('login-email').value = email;
            } catch (e) { 
                isRegistering = false; showAuthError(e.message); 
            } finally { btn.innerHTML = originalText; btn.disabled = false; }
        });

        document.getElementById('btn-login').addEventListener('click', async () => { 
            document.getElementById('auth-error').classList.add('hidden');
            requestNotificationPermission();
            const btn = document.getElementById('btn-login'); const originalText = btn.innerText; btn.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mx-auto"></div>`; btn.disabled = true;
            try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); } 
            catch(e) { let msg = "Erreur de connexion."; if(e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') msg = "Email ou mot de passe incorrect."; showAuthError(msg); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        });

        window.confirmLogout = () => { document.getElementById('logout-modal').classList.add('open'); };
        window.logout = () => { document.getElementById('logout-modal').classList.remove('open'); if(unreadObserver) unreadObserver(); signOut(auth); };
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');

        onAuthStateChanged(auth, async (user) => {
            if (isRegistering) return;
            if (user) {
                requestNotificationPermission();
                document.getElementById('auth-screen').classList.remove('active'); document.getElementById('bottom-nav').classList.remove('hidden'); document.getElementById('bottom-nav').classList.add('flex');
                if (!currentUserData) {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if(userDoc.exists()) currentUserData = userDoc.data();
                    if(currentUserData && currentUserData.email === VIP_EMAIL) currentUserData.isVerified = true;
                }
                subscribeToUnreadCount();
                const currentActive = document.querySelector('.screen.active');
                if(!currentActive || currentActive.id === 'auth-screen') { window.navigateTo('feed'); loadFeed(); }
            } else {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById('auth-screen').classList.add('active'); document.getElementById('bottom-nav').classList.add('hidden'); document.getElementById('bottom-nav').classList.remove('flex'); currentUserData = null; isInitialLoad = true;
            }
        });

        window.navigateTo = (screen) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.querySelectorAll('video').forEach(v => v.pause());
            document.getElementById(screen + '-screen').classList.add('active');
            if (screen === 'feed') setTimeout(handleVideoPlayback, 100);
            if (screen === 'inbox') switchInboxTab('activities');
            updateNavUI(screen);
        };

        function updateNavUI(screen) {
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.add('opacity-50'); el.classList.remove('opacity-100'); el.querySelector('svg')?.classList.remove('fill-white'); });
            const active = document.getElementById('nav-' + screen);
            if(active) { active.classList.remove('opacity-50'); active.classList.add('opacity-100'); if(screen==='feed') active.querySelector('svg')?.classList.add('fill-white'); }
        }

        window.switchProfileTab = (tab) => {
            currentProfileTab = tab;
            const tabVideos = document.getElementById('tab-profile-videos');
            const tabFavs = document.getElementById('tab-profile-favs');
            if (tab === 'videos') { tabVideos.classList.add('border-white'); tabVideos.classList.remove('text-gray-500', 'border-transparent'); tabFavs.classList.remove('border-white'); tabFavs.classList.add('text-gray-500', 'border-transparent'); } else { tabFavs.classList.add('border-white'); tabFavs.classList.remove('text-gray-500', 'border-transparent'); tabVideos.classList.remove('border-white'); tabVideos.classList.add('text-gray-500', 'border-transparent'); }
            if (currentProfileUid) viewUserProfile(currentProfileUid);
        };

        window.switchFeed = (mode) => {
            currentFeedMode = mode;
            const tabFollowing = document.getElementById('tab-following');
            const tabForyou = document.getElementById('tab-foryou');
            if (mode === 'following') { tabFollowing.classList.add('text-white', 'border-b-2', 'border-white', 'pb-0.5', 'shadow-lg'); tabFollowing.classList.remove('text-gray-400'); tabForyou.classList.remove('text-white', 'border-b-2', 'border-white', 'pb-0.5', 'shadow-lg'); tabForyou.classList.add('text-gray-400'); } else { tabForyou.classList.add('text-white', 'border-b-2', 'border-white', 'pb-0.5', 'shadow-lg'); tabForyou.classList.remove('text-gray-400'); tabFollowing.classList.remove('text-white', 'border-b-2', 'border-white', 'pb-0.5', 'shadow-lg'); tabFollowing.classList.add('text-gray-400'); }
            loadFeed();
        };

        window.handleRewatch = async (docId, authorId) => {
            if (!auth.currentUser) return;
            if (auth.currentUser.uid === authorId) return; // Ne pas compter ses propres rewatchs comme likes +11

            // Update likes + 11
            const ref = doc(db, "videos", docId);
            await updateDoc(ref, { likes: increment(11) }).catch(e => console.log(e));

            // Send notification
            sendNotification(authorId, "rewatch", "vient de rewach votre vidéo");
        };

        function loadFeed() {
            const container = document.getElementById('feed-container');
            
            // Clean up previous listener
            if (window.feedUnsubscribe) {
                window.feedUnsubscribe();
                window.feedUnsubscribe = null;
                // If switching tabs or reloading, show loader
                container.innerHTML = '<div id="loading-feed" class="flex items-center justify-center h-full text-gray-500"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div></div>';
            }

            const q = query(collection(db, "videos"), orderBy("createdAt", "desc"), limit(50));
            
            window.feedUnsubscribe = onSnapshot(q, (snapshot) => {
                if (!auth.currentUser) return;
                
                // Remove loader
                const loader = document.getElementById('loading-feed');
                if(loader) loader.remove();
                
                if(snapshot.empty && container.children.length === 0) {
                    container.innerHTML = '<div class="h-full flex items-center justify-center text-gray-500">Aucune vidéo.</div>';
                    return;
                }

                snapshot.docChanges().forEach((change) => {
                    const docSnap = change.doc;
                    const data = docSnap.data();
                    const docId = docSnap.id;
                    
                    if (currentFeedMode === 'following') {
                        if (!currentUserData || !currentUserData.following || !currentUserData.following.includes(data.userId)) {
                            const ex = container.querySelector(`[data-id="${docId}"]`);
                            if(ex) {
                                if(videoObserver) videoObserver.unobserve(ex);
                                ex.remove();
                            }
                            return;
                        }
                    }

                    if (change.type === "added") {
                        if(container.querySelector(`[data-id="${docId}"]`)) return;

                        const iLiked = data.likedBy?.includes(auth.currentUser.uid);
                        const iFav = data.favorites?.includes(auth.currentUser.uid);
                        const optimizedUrl = getOptimizedVideoUrl(data.url, 720);
                        const badge = getBadgeHtml(data.isVerified);
                        const safeDesc = escapeHtml(data.description);
                        const safeUsername = escapeHtml(data.username);

                        const div = document.createElement('div');
                        div.className = "video-card w-full h-full relative snap-start bg-gray-900 border-b border-gray-800";
                        div.setAttribute('data-id', docId);
                        // NOTE: "loop" attribute removed to handle rewatch manually
                        div.innerHTML = `
                            <div class="app-watermark">R-VIDEOS</div>
                            <video class="w-full h-full object-cover pointer-events-none" playsinline preload="metadata" src="${optimizedUrl}"></video>
                            <div class="play-overlay absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-200 opacity-0"><div class="bg-black/40 rounded-full p-4 backdrop-blur-sm"><i data-lucide="play" class="w-12 h-12 text-white fill-white"></i></div></div>
                            <div class="absolute inset-0 z-10" onclick="togglePlay(this)" ondblclick="handleDoubleTap(event, '${docId}', '${data.userId}')"></div>
                            <div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-black/60 pointer-events-none"></div>
                            <div class="absolute right-2 bottom-32 flex flex-col items-center gap-6 z-20 pb-4">
                                <div class="relative mb-4 cursor-pointer" onclick="viewUserProfile('${data.userId}')"><div class="w-12 h-12 rounded-full border-2 border-white overflow-hidden bg-black transition transform hover:scale-110">${getAvatarHTML(data.userPhotoURL, "w-full h-full object-cover")}</div></div>
                                
                                <div class="flex flex-col items-center gap-1 cursor-pointer group ${iLiked ? 'liked' : ''}" onclick="toggleLike('${docId}', this, '${data.userId}')">
                                    <i data-lucide="heart" class="w-9 h-9 icon-shadow like-icon ${iLiked ? 'fill-red-500 text-red-500' : 'text-white fill-white'} transition-all"></i>
                                    <span class="text-xs font-bold text-shadow like-count">${formatCount(data.likes)}</span>
                                </div>
                                <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="openComments('${docId}')">
                                    <i data-lucide="message-circle" class="w-9 h-9 icon-shadow text-white fill-white"></i>
                                    <span class="text-xs font-bold text-shadow comment-count">${formatCount(data.commentCount)}</span>
                                </div>
                                <div class="flex flex-col items-center gap-1 cursor-pointer ${iFav ? 'favorited' : ''}" onclick="toggleFavorite('${docId}', this)">
                                    <i data-lucide="bookmark" class="w-9 h-9 icon-shadow fav-icon ${iFav ? 'fill-yellow-500 text-yellow-500' : 'text-white fill-white'} transition-all"></i>
                                    <span class="text-xs font-bold text-shadow fav-text">${iFav ? 'Fav' : 'Fav'}</span>
                                </div>
                                <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="downloadVideo('${data.url}', '${docId}', '${safeUsername}')">
                                    <i data-lucide="download" class="w-9 h-9 icon-shadow text-white fill-white"></i>
                                    <span class="text-[10px] font-bold text-shadow">Télec.</span>
                                </div>
                                <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="shareVideo('${data.url}')">
                                    <i data-lucide="share-2" class="w-9 h-9 icon-shadow text-white fill-white"></i>
                                    <span class="text-[10px] font-bold text-shadow">Partager</span>
                                </div>
                                <div class="mt-4 relative animate-spin-slow"><div class="w-10 h-10 bg-gray-800 rounded-full border-4 border-gray-900 flex items-center justify-center overflow-hidden">${getAvatarHTML(data.userPhotoURL, "w-full h-full")}</div></div>
                            </div>
                            <div class="absolute bottom-20 left-4 right-20 z-20 text-left pointer-events-none">
                                <div class="flex items-center"><h3 class="font-bold text-lg text-shadow mb-1">@${safeUsername}</h3>${badge}</div>
                                <p class="text-sm mb-2 text-shadow text-gray-100 line-clamp-3">${safeDesc}</p>
                            </div>`;
                        
                        if (change.newIndex === 0 && container.children.length > 0) {
                            container.insertBefore(div, container.firstChild);
                        } else {
                            container.appendChild(div);
                        }

                        const v = div.querySelector('video');
                        const overlay = div.querySelector('.play-overlay');
                        
                        // EVENT: REWATCH LOGIC
                        v.addEventListener('ended', () => {
                            v.currentTime = 0;
                            v.play().catch(()=>{});
                            handleRewatch(docId, data.userId);
                        });

                        v.addEventListener('play', () => { clearTimeout(v.playOverlayTimeout); overlay.classList.add('opacity-0'); overlay.classList.remove('opacity-100'); });
                        v.addEventListener('pause', () => { v.playOverlayTimeout = setTimeout(() => { if (v.paused) { overlay.classList.remove('opacity-0'); overlay.classList.add('opacity-100'); } }, 300); });
                        if (v.paused) { v.playOverlayTimeout = setTimeout(() => { overlay.classList.remove('opacity-0'); overlay.classList.add('opacity-100'); }, 300); }
                        
                        if(videoObserver) videoObserver.observe(div);
                        lucide.createIcons();
                    }

                    if (change.type === "modified") {
                        const card = container.querySelector(`[data-id="${docId}"]`);
                        if (card) {
                            const iLiked = data.likedBy?.includes(auth.currentUser.uid);
                            const iFav = data.favorites?.includes(auth.currentUser.uid);
                            
                            const likeIcon = card.querySelector('.like-icon');
                            const likeCount = card.querySelector('.like-count');
                            const likeGroup = likeIcon.closest('.group');
                            
                            likeCount.innerText = formatCount(data.likes);
                            if(iLiked) {
                                likeGroup.classList.add('liked');
                                likeIcon.classList.remove('text-white', 'fill-white');
                                likeIcon.classList.add('fill-red-500', 'text-red-500');
                            } else {
                                likeGroup.classList.remove('liked');
                                likeIcon.classList.add('text-white', 'fill-white');
                                likeIcon.classList.remove('fill-red-500', 'text-red-500');
                            }
                            
                            const commCount = card.querySelector('.comment-count');
                            commCount.innerText = formatCount(data.commentCount);
                            
                            const favIcon = card.querySelector('.fav-icon');
                            const favText = card.querySelector('.fav-text');
                            const favGroup = favIcon.parentElement;
                            
                            if(iFav) {
                                favGroup.classList.add('favorited');
                                favIcon.classList.remove('text-white', 'fill-white');
                                favIcon.classList.add('fill-yellow-500', 'text-yellow-500');
                                favText.innerText = "Fav";
                            } else {
                                favGroup.classList.remove('favorited');
                                favIcon.classList.add('text-white', 'fill-white');
                                favIcon.classList.remove('fill-yellow-500', 'text-yellow-500');
                                favText.innerText = "Fav";
                            }
                        }
                    }

                    if (change.type === "removed") {
                        const card = container.querySelector(`[data-id="${docId}"]`);
                        if(card) {
                            if(videoObserver) videoObserver.unobserve(card);
                            card.remove();
                        }
                    }
                });
                
                if (!videoObserver) {
                    handleVideoPlayback();
                }
            });
        }
        
        window.togglePlay = (el) => { const v = el.parentElement.querySelector('video'); v.paused ? v.play().catch(()=>{}) : v.pause(); };
        window.handleDoubleTap = (e, docId, authorId) => { e.stopPropagation(); const rect = e.target.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; const heart = document.createElement('div'); heart.innerHTML = `<i data-lucide="heart" class="w-24 h-24 fill-red-500 text-red-500"></i>`; heart.className = 'big-heart'; heart.style.left = x + 'px'; heart.style.top = y + 'px'; e.target.parentElement.appendChild(heart); lucide.createIcons(); setTimeout(() => heart.remove(), 800); const card = e.target.closest('.video-card'); const likeBtn = card.querySelector('.group'); if (!likeBtn.classList.contains('liked')) toggleLike(docId, likeBtn, authorId); };
        function handleVideoPlayback() { if(videoObserver) videoObserver.disconnect(); const options = { root: document.getElementById('feed-container'), threshold: 0.6 }; videoObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { const v = entry.target.querySelector('video'); if (!v) return; if(entry.isIntersecting) { v.play().catch(e=>{}); const vidId = entry.target.getAttribute('data-id'); if(vidId && !viewedVideos.has(vidId)) { viewedVideos.add(vidId); updateDoc(doc(db, "videos", vidId), { views: increment(1) }).catch(e=>{}); } } else { v.currentTime = 0; v.pause(); } }); }, options); document.querySelectorAll('.video-card').forEach(c => videoObserver.observe(c)); }
        window.toggleLike = async (docId, el, authorId) => { if(!auth.currentUser) return; const isLiked = el.classList.contains('liked'); const ref = doc(db, "videos", docId); if(isLiked) { el.classList.remove('liked'); el.querySelector('svg').classList.remove('fill-red-500','text-red-500'); el.querySelector('svg').classList.add('text-white', 'fill-white'); await updateDoc(ref, {likes: increment(-1), likedBy: arrayRemove(auth.currentUser.uid)}); } else { el.classList.add('liked'); el.querySelector('svg').classList.add('fill-red-500','text-red-500','like-animation'); el.querySelector('svg').classList.remove('text-white', 'fill-white'); setTimeout(()=>el.querySelector('svg').classList.remove('like-animation'),300); await updateDoc(ref, {likes: increment(1), likedBy: arrayUnion(auth.currentUser.uid)}); sendNotification(authorId, "like", "a aimé votre vidéo"); } };

        window.openComments = async (id) => { 
            currentVideoIdForComments = id; 
            const vidSnap = await getDoc(doc(db, "videos", id));
            if (vidSnap.exists()) {
                currentVideoAuthorId = vidSnap.data().userId;
            }
            document.getElementById('comments-sheet').classList.add('open'); 
            loadComments(id); 
        };
        window.closeComments = () => { document.getElementById('comments-sheet').classList.remove('open'); currentVideoIdForComments = null; currentVideoAuthorId = null; };
        
        function loadComments(id) { 
            const list = document.getElementById('comments-list'); 
            list.innerHTML = "<div class='text-center text-sm py-4'>Chargement...</div>"; 
            onSnapshot(query(collection(db, `videos/${id}/comments`), orderBy("createdAt", "asc")), (snap) => { 
                let html = ""; 
                snap.forEach(d => { 
                    const c = d.data(); 
                    const isLiked = c.likedBy?.includes(auth.currentUser.uid); 
                    const canDelete = (c.userId === auth.currentUser.uid) || (currentVideoAuthorId === auth.currentUser.uid);
                    html += `<div class="flex gap-3 mb-4 w-full group relative">
                        <div class="flex-shrink-0 cursor-pointer" onclick="window.viewUserProfile('${c.userId}'); window.closeComments()">${getAvatarHTML(c.userPhotoURL, "w-8 h-8")}</div>
                        <div class="flex-1 pr-6">
                            <div class="text-xs font-bold text-gray-400 cursor-pointer" onclick="window.viewUserProfile('${c.userId}'); window.closeComments()">@${escapeHtml(c.username)}</div>
                            <div class="text-sm break-words">${escapeHtml(c.text)}</div>
                        </div>
                        <div class="flex flex-col items-center justify-center cursor-pointer" onclick="toggleCommentLike('${id}', '${d.id}', '${c.userId}')">
                            <i data-lucide="heart" class="w-4 h-4 ${isLiked ? 'fill-red-500 text-red-500' : 'text-gray-500'}"></i>
                            <span class="text-[10px] text-gray-500">${c.likes || 0}</span>
                        </div>
                        ${canDelete ? `<div onclick="deleteComment('${id}', '${d.id}')" class="absolute top-0 right-10 p-1 text-gray-500 hover:text-red-500 cursor-pointer"><i data-lucide="trash-2" class="w-4 h-4"></i></div>` : ''}
                    </div>`; 
                }); 
                list.innerHTML = html || "<div class='text-center text-sm py-4 text-gray-500'>Aucun commentaire.</div>"; 
                lucide.createIcons(); 
            }); 
        }

        window.deleteComment = (vidId, cId) => {
            window.confirmAction("Supprimer le commentaire ?", async () => {
                await deleteDoc(doc(db, `videos/${vidId}/comments`, cId));
                await updateDoc(doc(db, "videos", vidId), { commentCount: increment(-1) });
            });
        };
        window.toggleCommentLike = async (vidId, cId, aId) => { const ref = doc(db, `videos/${vidId}/comments`, cId); const snap = await getDoc(ref); if(!snap.exists()) return; if(snap.data().likedBy?.includes(auth.currentUser.uid)) { await updateDoc(ref, { likes: increment(-1), likedBy: arrayRemove(auth.currentUser.uid) }); } else { await updateDoc(ref, { likes: increment(1), likedBy: arrayUnion(auth.currentUser.uid) }); sendNotification(aId, "comment_like", "a aimé votre commentaire"); } };
        window.sendComment = async () => { const inp = document.getElementById('comment-input'); const txt = inp.value.trim(); if(!txt || !currentVideoIdForComments) return; inp.value = ""; await addDoc(collection(db, `videos/${currentVideoIdForComments}/comments`), { text: escapeHtml(txt), userId: auth.currentUser.uid, username: currentUserData.username, userPhotoURL: currentUserData.photoURL||"", likes: 0, likedBy: [], createdAt: serverTimestamp() }); await updateDoc(doc(db, "videos", currentVideoIdForComments), { commentCount: increment(1) }); const vidSnap = await getDoc(doc(db, "videos", currentVideoIdForComments)); if(vidSnap.exists()) sendNotification(vidSnap.data().userId, "comment", "a commenté: " + txt); };

        window.switchInboxTab = (tab) => {
            if(inboxUnsubscribe) { inboxUnsubscribe(); inboxUnsubscribe = null; }
            document.getElementById('tab-activities').classList.toggle('border-b-2', tab==='activities'); document.getElementById('tab-activities').classList.toggle('text-gray-500', tab!=='activities'); document.getElementById('tab-messages').classList.toggle('border-b-2', tab==='messages'); document.getElementById('tab-messages').classList.toggle('text-gray-500', tab!=='messages'); if(tab === 'activities') loadActivities(); else loadConversations();
        };

        function loadActivities() { const list = document.getElementById('inbox-content'); list.innerHTML = "Chargement..."; inboxUnsubscribe = onSnapshot(query(collection(db, "users", auth.currentUser.uid, "notifications"), orderBy("createdAt", "desc"), limit(20)), (snap) => { if(snap.empty) return list.innerHTML = "<div class='text-center text-gray-500 mt-4'>Aucune activité.</div>"; let html = ""; snap.forEach(d => { const n = d.data(); if(!n.read) updateDoc(doc(db, "users", auth.currentUser.uid, "notifications", d.id), {read: true}).catch(e=>{}); let icon = "bell"; let color = "text-yellow-500"; if(n.type === 'like') { icon = "heart"; color = "text-red-500"; } if(n.type === 'follow') { icon = "user-plus"; color = "text-blue-500"; } if(n.type === 'comment') { icon = "message-circle"; color = "text-green-500"; } if(n.type === 'info') { icon = "info"; color = "text-blue-400"; } if(n.type === 'rewatch') { icon = "repeat"; color = "text-purple-500"; } html += `<div onclick="viewUserProfile('${n.fromUid}')" class="flex items-center gap-3 py-2 border-b border-gray-800 cursor-pointer hover:bg-gray-900 transition"><div class="relative w-12 h-12">${getAvatarHTML(n.fromPhoto, "w-full h-full")}<div class="absolute -bottom-1 -right-1 bg-gray-900 rounded-full p-1"><i data-lucide="${icon}" class="w-4 h-4 ${color}"></i></div></div><div><p class="text-sm"><span class="font-bold">@${escapeHtml(n.fromUsername)}</span> ${escapeHtml(n.text)}</p></div></div>`; }); list.innerHTML = html; lucide.createIcons(); }); }
        
        function loadConversations() { 
            const list = document.getElementById('inbox-content'); list.innerHTML = "Chargement..."; 
            const q = query(collection(db, "chats"), where("participants", "array-contains", auth.currentUser.uid)); 
            inboxUnsubscribe = onSnapshot(q, (snap) => { 
                if(snap.empty) return list.innerHTML = "<div class='text-center text-gray-500 mt-4'>Aucun message.</div>"; 
                let chats = []; snap.forEach(d => chats.push({id: d.id, ...d.data()})); 
                chats.sort((a, b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0)); 
                let html = ""; 
                chats.forEach(c => { 
                    const oId = c.participants.find(p => p !== auth.currentUser.uid); 
                    if (currentUserData.blockedUsers && currentUserData.blockedUsers.includes(oId)) return;
                    const unread = (c.unreadCounts && c.unreadCounts[auth.currentUser.uid]) || 0;
                    if(oId && c.names) {
                        html += `<div class="flex items-center gap-3 py-3 border-b border-gray-800 hover:bg-gray-900 relative">
                                <div onclick="startChatWith('${oId}', '${c.names[oId]}', '${c.photos[oId]}')" class="w-12 h-12 flex-shrink-0 cursor-pointer">${getAvatarHTML(c.photos[oId], "w-full h-full")}</div>
                                <div onclick="startChatWith('${oId}', '${c.names[oId]}', '${c.photos[oId]}')" class="flex-1 min-w-0 cursor-pointer">
                                    <div class="flex justify-between">
                                        <div class="font-bold truncate">@${escapeHtml(c.names[oId])}</div>
                                        ${unread > 0 ? `<div class="bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[20px] text-center">${unread > 99 ? '+99' : unread}</div>` : ''}
                                    </div>
                                    <div class="text-sm text-gray-400 truncate">${escapeHtml(c.lastMessage)}</div>
                                </div>
                                <div onclick="deleteConversation('${c.id}')" class="p-2 text-gray-500 hover:text-red-500 cursor-pointer"><i data-lucide="trash-2" class="w-4 h-4"></i></div>
                        </div>`; 
                    }
                }); 
                list.innerHTML = html; lucide.createIcons();
            }); 
        }

        window.deleteConversation = (chatId) => {
            window.confirmAction("Supprimer la conversation ?", async () => {
                await deleteDoc(doc(db, "chats", chatId));
            });
        };
        
        window.startChat = () => { if(currentProfileUid) startChatWith(currentProfileUid, document.getElementById('profile-handle').innerText.substring(1), document.getElementById('profile-avatar-container').querySelector('img')?.src || ""); };
        window.startChatWith = async (uid, name, photo) => { 
            currentChatReceiver = uid; 
            document.getElementById('chat-username').innerText = name; 
            document.getElementById('chat-avatar').innerHTML = getAvatarHTML(photo, "w-full h-full"); 
            const ids = [auth.currentUser.uid, uid].sort(); 
            currentChatId = ids[0] + "_" + ids[1]; 
            document.getElementById('chat-screen').classList.add('open'); 
            loadMessages(currentChatId); 
            
            // Reset unread count for me
            const cref = doc(db, "chats", currentChatId);
            const updateMap = {};
            updateMap[`unreadCounts.${auth.currentUser.uid}`] = 0;
            await updateDoc(cref, updateMap).catch(()=>{});
        };
        
        window.closeChat = () => document.getElementById('chat-screen').classList.remove('open');
        
        function loadMessages(cId) { 
            const box = document.getElementById('chat-messages'); box.innerHTML = ""; 
            onSnapshot(query(collection(db, "chats", cId, "messages"), orderBy("createdAt", "asc")), (snap) => { 
                let html = ""; 
                const batch = writeBatch(db);
                let needsCommit = false;
                snap.forEach(d => { 
                    const m = d.data(); 
                    const isMe = m.senderId === auth.currentUser.uid;
                    if (!isMe && !m.read) {
                        batch.update(doc(db, "chats", cId, "messages", d.id), { read: true });
                        needsCommit = true;
                    }
                    const checkIcon = isMe ? (m.read ? `<i data-lucide="check-check" class="w-3 h-3 text-blue-500 ml-1"></i>` : `<i data-lucide="check" class="w-3 h-3 text-gray-400 ml-1"></i>`) : '';
                    html += `<div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                        <div class="msg-bubble ${isMe ? 'msg-me' : 'msg-other'} cursor-pointer" ondblclick="deleteMessage('${cId}', '${d.id}', ${isMe})">${escapeHtml(m.text)}</div>
                        ${isMe ? `<div class="msg-status">${checkIcon}</div>` : ''}
                    </div>`; 
                }); 
                box.innerHTML = html; 
                box.scrollTop = box.scrollHeight; 
                lucide.createIcons();
                if (needsCommit) batch.commit().catch(e => console.log(e));
            }); 
        }

        window.deleteMessage = (cId, mId, isMe) => {
            if (!isMe) return; 
            window.confirmAction("Supprimer le message ?", async () => {
                await deleteDoc(doc(db, "chats", cId, "messages", mId));
            });
        }
        
        window.sendMessage = async () => { 
            const inp = document.getElementById('chat-input'); const txt = inp.value.trim(); if(!txt || !currentChatId) return; inp.value = ""; 
            
            // Check blocking
            const receiverDoc = await getDoc(doc(db, "users", currentChatReceiver));
            if (receiverDoc.exists()) {
                const rData = receiverDoc.data();
                if (rData.blockedUsers && rData.blockedUsers.includes(auth.currentUser.uid)) {
                    alert("Vous ne pouvez pas envoyer de message à cet utilisateur.");
                    return;
                }
            }
            // Add Message
            await addDoc(collection(db, "chats", currentChatId, "messages"), { text: escapeHtml(txt), senderId: auth.currentUser.uid, createdAt: serverTimestamp(), read: false }); 
            
            const cref = doc(db, "chats", currentChatId); 
            const csnap = await getDoc(cref); 
            
            const updateData = { lastMessage: escapeHtml(txt), lastUpdated: serverTimestamp() };
            updateData[`unreadCounts.${currentChatReceiver}`] = increment(1);
            if(!csnap.exists()) { 
                const n={}; n[auth.currentUser.uid]=currentUserData.username; n[currentChatReceiver]=document.getElementById('chat-username').innerText; 
                const p={}; p[auth.currentUser.uid]=currentUserData.photoURL; p[currentChatReceiver]=document.getElementById('chat-avatar').querySelector('img')?.src||""; 
                const unread = {}; unread[auth.currentUser.uid]=0; unread[currentChatReceiver]=1;
                await setDoc(cref, {participants:[auth.currentUser.uid, currentChatReceiver], names:n, photos:p, lastMessage:escapeHtml(txt), lastUpdated:serverTimestamp(), unreadCounts: unread}); 
            } else {
                await updateDoc(cref, updateData); 
            }
        };
        
        // --- BLOCK USER LOGIC ---
        window.toggleBlock = async () => {
            if (!currentProfileUid || !auth.currentUser) return;
            const myRef = doc(db, "users", auth.currentUser.uid);
            const otherRef = doc(db, "users", currentProfileUid);
            
            const myData = (await getDoc(myRef)).data();
            const isBlocked = myData.blockedUsers && myData.blockedUsers.includes(currentProfileUid);
            
            if (isBlocked) {
                await updateDoc(myRef, { blockedUsers: arrayRemove(currentProfileUid) });
                await updateDoc(otherRef, { blockedBy: arrayRemove(auth.currentUser.uid) });
                document.getElementById('btn-block').innerHTML = '<i data-lucide="shield-off" class="w-4 h-4"></i>';
                document.getElementById('btn-block').classList.remove('bg-red-900', 'text-white');
                document.getElementById('btn-block').classList.add('text-red-500');
                alert("Utilisateur débloqué.");
            } else {
                window.confirmAction("Bloquer cet utilisateur ?", async () => {
                    await updateDoc(myRef, { blockedUsers: arrayUnion(currentProfileUid), following: arrayRemove(currentProfileUid) });
                    await updateDoc(otherRef, { blockedBy: arrayUnion(auth.currentUser.uid), followers: arrayRemove(auth.currentUser.uid) });
                    document.getElementById('btn-block').innerHTML = '<i data-lucide="shield" class="w-4 h-4"></i>';
                    document.getElementById('btn-block').classList.add('bg-red-900', 'text-white');
                    alert("Utilisateur bloqué.");
                    renderProfile(currentUserData, true); // Refresh my view
                });
            }
            lucide.createIcons();
        };

        // FUNCTIONS TO HANDLE FULL SCREEN VIDEO FROM PROFILE
        window.openFullVideo = (id) => {
            const data = profileVideosData[id];
            if (!data) return;
            
            const overlay = document.getElementById('fullscreen-video-overlay');
            const container = document.getElementById('fullscreen-video-container');
            
            const iLiked = data.likedBy?.includes(auth.currentUser.uid);
            const iFav = data.favorites?.includes(auth.currentUser.uid);
            const optimizedUrl = getOptimizedVideoUrl(data.url, 720);
            const badge = getBadgeHtml(data.isVerified);
             const html = `
                <div class="video-card w-full h-full relative bg-black flex items-center justify-center">
                    <video class="w-full h-full object-contain" loop playsinline autoplay src="${optimizedUrl}"></video>
                    <div class="absolute inset-0 z-10" onclick="togglePlay(this)" ondblclick="handleDoubleTap(event, '${id}', '${data.userId}')"></div>
                    
                    <div class="absolute right-2 bottom-32 flex flex-col items-center gap-6 z-20 pb-4">
                        <div class="relative mb-4 cursor-pointer" onclick="viewUserProfile('${data.userId}'); closeFullVideo()">
                            <div class="w-12 h-12 rounded-full border-2 border-white overflow-hidden bg-black transition transform hover:scale-110">
                                ${getAvatarHTML(data.userPhotoURL, "w-full h-full object-cover")}
                            </div>
                        </div>
                        
                         <div class="flex flex-col items-center gap-1 cursor-pointer group ${iLiked ? 'liked' : ''}" onclick="toggleLike('${id}', this, '${data.userId}')">
                            <i data-lucide="heart" class="w-9 h-9 icon-shadow ${iLiked ? 'fill-red-500 text-red-500' : 'text-white fill-white'} transition-all"></i>
                            <span class="text-xs font-bold text-shadow">${formatCount(data.likes)}</span>
                        </div>
                        <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="openComments('${id}')">
                            <i data-lucide="message-circle" class="w-9 h-9 icon-shadow text-white fill-white"></i>
                            <span class="text-xs font-bold text-shadow">${formatCount(data.commentCount)}</span>
                        </div>
                         <div class="flex flex-col items-center gap-1 cursor-pointer ${iFav ? 'favorited' : ''}" onclick="toggleFavorite('${id}', this)">
                            <i data-lucide="bookmark" class="w-9 h-9 icon-shadow ${iFav ? 'fill-yellow-500 text-yellow-500' : 'text-white fill-white'} transition-all"></i>
                            <span class="text-xs font-bold text-shadow">${iFav ? 'Fav' : 'Fav'}</span>
                        </div>
                         <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="downloadVideo('${data.url}', '${id}', '${data.username}')">
                            <i data-lucide="download" class="w-9 h-9 icon-shadow text-white fill-white"></i>
                            <span class="text-[10px] font-bold text-shadow">Télec.</span>
                        </div>
                         <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="shareVideo('${data.url}')">
                            <i data-lucide="share-2" class="w-9 h-9 icon-shadow text-white fill-white"></i>
                            <span class="text-[10px] font-bold text-shadow">Partager</span>
                        </div>
                    </div>

                    <div class="absolute bottom-10 left-4 right-20 z-20 text-left pointer-events-none">
                        <div class="flex items-center">
                            <h3 class="font-bold text-lg text-shadow mb-1">@${escapeHtml(data.username)}</h3>
                            ${badge}
                        </div>
                        <p class="text-sm mb-2 text-shadow text-gray-100 line-clamp-3">${escapeHtml(data.description)}</p>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            lucide.createIcons();
        };

        window.closeFullVideo = () => {
            const overlay = document.getElementById('fullscreen-video-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            document.getElementById('fullscreen-video-container').innerHTML = "";
        };

        window.openMyProfile = () => { if(!auth.currentUser) return; renderProfile(currentUserData, true); navigateTo('profile'); };
        window.viewUserProfile = async (uid) => { if(!auth.currentUser) return; if(uid === auth.currentUser.uid) return openMyProfile(); const snap = await getDoc(doc(db, "users", uid)); if(snap.exists()) { renderProfile(snap.data(), false); navigateTo('profile'); } };
        window.searchUsers = async (term) => { const container = document.getElementById('search-results'); if(!term || term.length < 2) { container.innerHTML = "<div class='text-gray-500 text-center text-sm mt-10'>Tapez un nom...</div>"; return; } const snap = await getDocs(query(collection(db, "users"), where('username', '>=', term), where('username', '<=', term + '\uf8ff'), limit(10))); if(snap.empty) { container.innerHTML = "<div class='text-gray-500 text-center text-sm mt-10'>Aucun utilisateur.</div>"; return; } let html = ""; snap.forEach(doc => { const u = doc.data(); const badge = getBadgeHtml(u.isVerified); html += `<div onclick="viewUserProfile('${u.uid}')" class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-800"><div class="w-10 h-10">${getAvatarHTML(u.photoURL, "w-full h-full")}</div><div><div class="font-bold flex items-center">@${escapeHtml(u.username)} ${badge}</div><div class="text-xs text-gray-400">${escapeHtml(u.bio || '')}</div></div></div>`; }); container.innerHTML = html; lucide.createIcons(); };

        async function renderProfile(data, isMe) { 
            currentProfileUid = data.uid; document.getElementById('profile-handle').textContent = "@" + data.username; document.getElementById('profile-bio').textContent = data.bio || "Pas de bio"; document.getElementById('profile-avatar-container').innerHTML = getAvatarHTML(data.photoURL, "w-full h-full"); 
            const isCertif = data.isVerified || (data.email === VIP_EMAIL);
            document.getElementById('profile-badge-container').innerHTML = getBadgeHtml(isCertif); 
            document.getElementById('my-profile-actions').classList.toggle('hidden', !isMe); document.getElementById('other-profile-actions').classList.toggle('hidden', isMe); document.getElementById('profile-followers').innerText = data.followers ? data.followers.length : 0; 
            if(!isMe) { 
                const btn = document.getElementById('btn-follow'); const isF = data.followers?.includes(auth.currentUser.uid); updateFollowButtonUI(btn, isF); 
                const isBlocked = currentUserData.blockedUsers && currentUserData.blockedUsers.includes(data.uid);
                const blockBtn = document.getElementById('btn-block');
                if (isBlocked) {
                    blockBtn.innerHTML = '<i data-lucide="shield" class="w-4 h-4"></i>';
                    blockBtn.classList.add('bg-red-900', 'text-white');
                    blockBtn.classList.remove('text-red-500');
                } else {
                    blockBtn.innerHTML = '<i data-lucide="shield-off" class="w-4 h-4"></i>';
                    blockBtn.classList.remove('bg-red-900', 'text-white');
                    blockBtn.classList.add('text-red-500');
                }
            } 
            
            const grid = document.getElementById('profile-videos-grid'); 
            grid.innerHTML = "<div class='col-span-3 text-center text-gray-500'>Chargement...</div>"; 
            profileVideosData = {}; 
            let likes = 0; const snap = await getDocs(query(collection(db, "videos"), orderBy("createdAt", "desc"))); 
            grid.innerHTML = ""; 
            
            let count = 0;
            snap.forEach(d => { 
                const v = d.data(); 
                if (v.userId === data.uid) likes += (v.likes || 0);
                let shouldShow = false;
                if (currentProfileTab === 'videos') {
                    if (v.userId === data.uid) shouldShow = true;
                } else if (currentProfileTab === 'favs') {
                    if (v.favorites && v.favorites.includes(data.uid)) shouldShow = true;
                }
                if (shouldShow) {
                    count++;
                    profileVideosData[d.id] = v;
                    const delBtn = (isMe && v.userId === auth.currentUser.uid) ? `<div class="absolute top-1 right-1 bg-black/50 p-1 rounded-full cursor-pointer z-10" onclick="event.stopPropagation(); confirmDeleteVideo('${d.id}')"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></div>` : ''; 
                    const div = document.createElement('div'); 
                    div.className = "bg-gray-800 aspect-[3/4] relative border border-black group cursor-pointer"; 
                    div.onclick = () => openFullVideo(d.id);
                    div.innerHTML = `${delBtn}<img src="${getVideoThumbnail(v.url)}" class="w-full h-full object-cover"><div class="absolute bottom-1 left-1 flex items-center gap-1 text-[10px] font-bold text-white drop-shadow-md"><i data-lucide="play" class="w-3 h-3 fill-white"></i> ${formatCount(v.views)}</div>`; 
                    grid.appendChild(div); 
                } 
            }); 
            if(count === 0) grid.innerHTML = "<div class='col-span-3 text-center text-gray-500 text-sm mt-4'>Aucune vidéo.</div>";
            document.getElementById('profile-likes').innerText = formatCount(likes); lucide.createIcons(); 
        }

        function updateFollowButtonUI(btn, isFollowing) { btn.innerText = isFollowing ? "Abonné" : "S'abonner"; btn.className = isFollowing ? "flex-1 bg-gray-200 text-black py-2 rounded text-sm font-semibold" : "flex-1 bg-red-600 text-white py-2 rounded text-sm font-semibold"; }

        window.toggleFollow = async () => { if (!currentProfileUid || !auth.currentUser) return; const tRef = doc(db, "users", currentProfileUid); const mRef = doc(db, "users", auth.currentUser.uid); const snap = await getDoc(tRef); const isF = snap.data().followers?.includes(auth.currentUser.uid); const btn = document.getElementById('btn-follow'); const cnt = document.getElementById('profile-followers'); let n = parseInt(cnt.innerText); if (isF) { await updateDoc(tRef, {followers:arrayRemove(auth.currentUser.uid)}); await updateDoc(mRef, {following:arrayRemove(currentProfileUid)}); updateFollowButtonUI(btn, false); cnt.innerText = n-1; } else { await updateDoc(tRef, {followers:arrayUnion(auth.currentUser.uid)}); await updateDoc(mRef, {following:arrayUnion(currentProfileUid)}); updateFollowButtonUI(btn, true); cnt.innerText = n+1; sendNotification(currentProfileUid, "follow", "a commencé à vous suivre"); } };

        window.openEditProfile = () => { document.getElementById('edit-username').value = currentUserData.username; document.getElementById('edit-bio').value = currentUserData.bio; document.getElementById('edit-modal').classList.add('open'); };
        window.saveProfileChanges = async () => { const btn = document.getElementById('btn-save-profile'); const originalText = btn.innerText; btn.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-black border-t-transparent rounded-full mx-auto"></div>`; btn.disabled = true; try { const file = document.getElementById('edit-file-input').files[0]; let url = currentUserData.photoURL; if(file) url = await uploadToCloudinary(file); await updateDoc(doc(db, "users", auth.currentUser.uid), { username: escapeHtml(document.getElementById('edit-username').value), bio: escapeHtml(document.getElementById('edit-bio').value), photoURL: url }); currentUserData = (await getDoc(doc(db, "users", auth.currentUser.uid))).data(); if(file) { const vidSnap = await getDocs(query(collection(db, "videos"), where("userId", "==", auth.currentUser.uid))); vidSnap.forEach(async (v) => { await updateDoc(doc(db, "videos", v.id), { userPhotoURL: url }); }); } window.closeModal('edit-modal'); renderProfile(currentUserData, true); } catch(e) { alert("Erreur: " + e.message); } finally { btn.innerHTML = originalText; btn.disabled = false; } };

        window.openUploadModal = () => document.getElementById('upload-modal').classList.add('open');
        window.previewVideoUpload = (i) => { if(i.files[0]) { const v=document.getElementById('video-preview'); v.src=URL.createObjectURL(i.files[0]); v.classList.remove('hidden'); v.play(); document.getElementById('upload-preview-area').querySelector('i').classList.add('hidden'); document.getElementById('upload-preview-area').querySelector('p').classList.add('hidden'); } };
        
        window.uploadVideo = async () => {
            const f = document.getElementById('video-file-input').files[0];
            if(!f) { alert("Veuillez sélectionner une vidéo avant de publier."); return; }
            const btn = document.getElementById('btn-publish');
            const originalText = btn.innerText;
            btn.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mx-auto"></div>`;
            btn.disabled = true;
            try {
                const url = await uploadToCloudinary(f);
                await addDoc(collection(db, "videos"), { userId: auth.currentUser.uid, username: currentUserData.username, userPhotoURL: currentUserData.photoURL||"", url, description: escapeHtml(document.getElementById('video-desc').value), likes: 0, likedBy: [], favorites: [], commentCount: 0, views: 0, isVerified: currentUserData.isVerified || false, createdAt: serverTimestamp() });
                
                // RESET FORM
                document.getElementById('video-file-input').value = "";
                document.getElementById('video-desc').value = "";
                const vPreview = document.getElementById('video-preview');
                vPreview.src = "";
                vPreview.classList.add('hidden');
                const area = document.getElementById('upload-preview-area');
                const icon = area.querySelector('i') || area.querySelector('svg');
                if(icon) icon.classList.remove('hidden');
                const text = area.querySelector('p');
                if(text) text.classList.remove('hidden');
                
                window.closeModal('upload-modal'); 
                navigateTo('feed');
            } catch(e) { alert(e.message); } finally { btn.disabled=false; btn.innerHTML=originalText; }
        };

        async function refreshCurrentScreen() {
            if (!auth.currentUser) return;
            const activeScreenEl = document.querySelector('.screen.active');
            if (!activeScreenEl) return;
            const activeScreen = activeScreenEl.id;
            
            const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
            if(userDoc.exists()) currentUserData = userDoc.data();
            if (activeScreen === 'feed-screen') {
                loadFeed();
            } else if (activeScreen === 'profile-screen') {
                if (currentProfileUid) viewUserProfile(currentProfileUid);
            } else if (activeScreen === 'inbox-screen') {
                const isActivity = document.getElementById('tab-activities').classList.contains('border-b-2');
                switchInboxTab(isActivity ? 'activities' : 'messages');
            } else if (activeScreen === 'discover-screen') {
                const term = document.getElementById('search-input').value;
                searchUsers(term);
            }
        }

        // --- PULL TO REFRESH LOGIC ---
        (function() {
            let startY = 0;
            let currentY = 0;
            let isPulling = false;
            const threshold = 120;
            const bodyContent = document.getElementById('main-app-container');
            const loader = document.getElementById('ptr-loader');
            const spinner = document.getElementById('ptr-spinner');
            const arrow = document.getElementById('ptr-arrow');

            document.addEventListener('touchstart', (e) => {
                const activeScreen = document.querySelector('.screen.active');
                if (!activeScreen) return;
                let scrollContainer = activeScreen.querySelector('.overflow-y-scroll, .overflow-y-auto');
                if (!scrollContainer) scrollContainer = activeScreen;

                if (scrollContainer.scrollTop <= 0) {
                    startY = e.touches[0].clientY;
                    currentY = startY; 
                    isPulling = true;
                } else {
                    isPulling = false;
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (!isPulling) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                if (diff > 0) {
                    const translateVal = Math.min(diff * 0.4, 150); 
                    loader.style.transform = `translateY(${translateVal - 64}px)`; 
                    bodyContent.style.transform = `translateY(${translateVal}px)`;
                    if (translateVal > 60) {
                        arrow.style.transform = "rotate(180deg)";
                    } else {
                        arrow.style.transform = "rotate(0deg)";
                    }
                }
            }, { passive: true });

            document.addEventListener('touchend', (e) => {
                if (!isPulling) return;
                isPulling = false;
                const diff = currentY - startY;
                if (diff > threshold) {
                    bodyContent.style.transform = `translateY(80px)`;
                    loader.style.transform = `translateY(20px)`;
                    arrow.classList.add('hidden');
                    spinner.classList.remove('hidden');
                    
                    refreshCurrentScreen().then(() => {
                        setTimeout(() => {
                            bodyContent.style.transform = '';
                            loader.style.transform = '';
                            arrow.classList.remove('hidden');
                            arrow.style.transform = "rotate(0deg)";
                            spinner.classList.add('hidden');
                        }, 800);
                    });
                } else {
                    bodyContent.style.transform = '';
                    loader.style.transform = '';
                }
            });
        })();
        lucide.createIcons();
    </script>
</body>
</html>
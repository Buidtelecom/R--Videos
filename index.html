<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Videos Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Force le plein écran sans défilement parasite */
        body, html { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background-color: black; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* Configuration Scroll Snap Stricte */
        .snap-y-mandatory { scroll-snap-type: y mandatory; }
        .snap-start { scroll-snap-align: start; }
        
        /* Cacher la barre de scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-spin-slow { animation: spin 4s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .like-animation { animation: pop 0.3s ease-in-out; }
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; z-index: 10; background: black; }
        .screen.active { display: flex; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; width: 100%; height: 75%; background: #111; border-t-left-radius: 16px; border-t-right-radius: 16px; z-index: 60; transform: translateY(100%); transition: transform 0.3s ease-out; display: flex; flex-direction: column; }
        .bottom-sheet.open { transform: translateY(0); }
        .full-screen-modal { position: fixed; inset: 0; background: #000; z-index: 70; transform: translateX(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .full-screen-modal.open { transform: translateX(0); }
        .liked svg { fill: #ef4444; color: #ef4444; }
        .favorited svg { fill: #eab308; color: #eab308; }
        
        .text-shadow { text-shadow: 1px 1px 2px rgba(0,0,0,0.8); }
        .icon-shadow { filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.5)); }
        .auth-input { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; }
        .msg-bubble { max-width: 75%; padding: 8px 12px; border-radius: 16px; margin-bottom: 8px; font-size: 14px; }
        .msg-me { align-self: flex-end; background-color: #ef4444; color: white; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background-color: #333; color: white; border-bottom-left-radius: 4px; }
    </style>
</head>
<body class="relative">

    <!-- CONFIGURATION -->
    <script>
        const CLOUDINARY_CLOUD_NAME = "dh68eblab"; 
        const CLOUDINARY_UPLOAD_PRESET = "uxyhxrib"; 
    </script>

    <!-- AUTH -->
    <div id="auth-screen" class="screen active justify-center items-center p-8 bg-gradient-to-br from-gray-900 to-black">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-4xl font-black mb-2 text-red-500 tracking-tighter">R-VIDEOS</h1>
            <p class="text-gray-400 mb-8 text-sm">Réseau Social Vidéo</p>
            <div id="auth-success" class="hidden mb-4 p-3 bg-green-900/50 border border-green-500 text-green-200 rounded-lg text-sm">Compte créé ! Connectez-vous.</div>
            <div id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email" class="auth-input">
                <input type="password" id="login-pass" placeholder="Mot de passe" class="auth-input">
                <button id="btn-login" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition">Se connecter</button>
                <p class="text-xs text-gray-400 mt-4">Pas encore de compte ? <span onclick="toggleAuthMode()" class="text-white font-bold cursor-pointer underline">S'inscrire</span></p>
            </div>
            <div id="register-form" class="space-y-4 hidden">
                <input type="text" id="reg-username" placeholder="Nom d'utilisateur" class="auth-input">
                <input type="email" id="reg-email" placeholder="Email" class="auth-input">
                <input type="password" id="reg-pass" placeholder="Mot de passe" class="auth-input">
                <button id="btn-register" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-lg transition">Créer mon compte</button>
                <p class="text-xs text-gray-400 mt-4">Déjà un compte ? <span onclick="toggleAuthMode()" class="text-white font-bold cursor-pointer underline">Se connecter</span></p>
            </div>
            <p id="auth-error" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- FEED -->
    <div id="feed-screen" class="screen relative">
        <div class="absolute top-0 left-0 w-full z-20 pt-4 pb-2 bg-gradient-to-b from-black/60 to-transparent pointer-events-none">
            <div class="flex justify-center items-center gap-4 text-base font-semibold pointer-events-auto">
                <span class="text-gray-400 cursor-pointer">Abonnements</span>
                <span class="text-white border-b-2 border-white pb-0.5 cursor-pointer shadow-lg">Pour toi</span>
            </div>
        </div>
        <!-- IMPORTANT: h-full et pas de padding bottom pour que la vidéo prenne tout l'écran derrière le menu -->
        <div id="feed-container" class="h-full w-full overflow-y-scroll snap-y-mandatory no-scrollbar relative bg-black">
            <div id="loading-feed" class="flex items-center justify-center h-full text-gray-500"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div></div>
        </div>
    </div>

    <!-- DECOUVRIR -->
    <div id="discover-screen" class="screen bg-black pt-4 px-4 pb-20">
        <h2 class="font-bold text-xl mb-4">Découvrir</h2>
        <div class="relative mb-6">
            <i data-lucide="search" class="absolute left-3 top-3 text-gray-400 w-5 h-5"></i>
            <input type="text" id="search-input" placeholder="Rechercher des utilisateurs..." class="w-full bg-gray-900 rounded-lg py-3 pl-10 pr-4 text-white outline-none focus:ring-1 focus:ring-gray-700" oninput="searchUsers(this.value)">
        </div>
        <div id="search-results" class="space-y-4 overflow-y-auto h-full pb-20">
            <div class="text-gray-500 text-center text-sm mt-10">Tapez un nom pour chercher...</div>
        </div>
    </div>

    <!-- BOITE (INBOX) -->
    <div id="inbox-screen" class="screen bg-black pt-4 px-0 pb-20">
        <h2 class="font-bold text-xl mb-4 px-4">Boîte de réception</h2>
        <div class="flex border-b border-gray-800 px-4 mb-4">
            <div onclick="switchInboxTab('activities')" id="tab-activities" class="pb-2 border-b-2 border-white font-semibold mr-6 cursor-pointer">Activités</div>
            <div onclick="switchInboxTab('messages')" id="tab-messages" class="pb-2 text-gray-500 font-semibold cursor-pointer">Messages</div>
        </div>
        <div id="inbox-content" class="px-4 space-y-4 overflow-y-auto h-full pb-20"></div>
    </div>

    <!-- PROFIL -->
    <div id="profile-screen" class="screen bg-black pt-10 px-4 overflow-y-auto pb-20">
        <div class="flex justify-between items-center mb-6">
            <i data-lucide="chevron-left" class="w-6 h-6 text-white cursor-pointer" onclick="navigateTo('feed')"></i>
            <h2 class="font-bold text-lg" id="profile-header-name">Profil</h2>
            <i data-lucide="more-horizontal" class="w-6 h-6 text-white cursor-pointer" onclick="confirmLogout()"></i>
        </div>
        <div class="flex flex-col items-center mb-8">
            <div id="profile-avatar-container" class="w-24 h-24 rounded-full border-2 border-gray-700 flex items-center justify-center mb-4 overflow-hidden bg-gray-800"></div>
            <h1 id="profile-handle" class="text-xl font-bold mb-1">@utilisateur</h1>
            <p id="profile-bio" class="text-gray-400 text-sm mb-4 text-center max-w-xs">...</p>
            <div class="flex gap-6 mt-2 text-center">
                <div><div class="font-bold text-lg" id="profile-followers">0</div><div class="text-xs text-gray-400">Abonnés</div></div>
                <div><div class="font-bold text-lg" id="profile-likes">0</div><div class="text-xs text-gray-400">J'aime</div></div>
            </div>
            
            <div id="my-profile-actions" class="flex gap-2 mt-6 w-full px-8 hidden">
                <button onclick="openEditProfile()" class="flex-1 bg-gray-800 py-2 rounded text-sm font-semibold border border-gray-600">Modifier le profil</button>
            </div>
            <div id="other-profile-actions" class="flex gap-2 mt-6 w-full px-8 hidden">
                <button id="btn-follow" onclick="toggleFollow()" class="flex-1 bg-red-600 text-white py-2 rounded text-sm font-semibold transition-colors">S'abonner</button>
                <button onclick="startChat()" class="flex-1 bg-gray-800 text-white py-2 rounded text-sm font-semibold border border-gray-600">Message</button>
            </div>
        </div>
        <div class="border-t border-gray-800 w-full">
             <div class="flex justify-center py-4 border-b-2 border-white w-1/2 mx-auto"><i data-lucide="grid-3x3"></i></div>
             <div id="profile-videos-grid" class="grid grid-cols-3 gap-0.5 mt-1"></div>
        </div>
    </div>

    <!-- CHAT SCREEN -->
    <div id="chat-screen" class="full-screen-modal">
        <div class="flex items-center p-4 border-b border-gray-800 bg-gray-900">
            <i data-lucide="chevron-left" class="w-6 h-6 cursor-pointer mr-4" onclick="closeChat()"></i>
            <div class="flex items-center gap-3">
                <div id="chat-avatar" class="w-8 h-8 rounded-full bg-gray-700 overflow-hidden"></div>
                <div id="chat-username" class="font-bold">Utilisateur</div>
            </div>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col bg-black"></div>
        <div class="p-3 bg-gray-900 flex items-center gap-2">
            <input type="text" id="chat-input" placeholder="Envoyer..." class="flex-1 bg-gray-800 border-none rounded-full px-4 py-2 text-sm text-white outline-none">
            <button onclick="sendMessage()" class="bg-red-600 p-2 rounded-full"><i data-lucide="send" class="w-4 h-4 text-white"></i></button>
        </div>
    </div>

    <!-- MODALS -->
    <div id="edit-modal" class="modal-overlay">
        <div class="bg-gray-900 w-11/12 max-w-md p-6 rounded-xl border border-gray-700">
            <h3 class="text-lg font-bold mb-4">Modifier le profil</h3>
            <label class="block text-xs text-gray-400 mb-1">Photo de profil</label>
            <input type="file" id="edit-file-input" accept="image/*" class="block w-full text-sm text-gray-400 file:bg-gray-800 file:text-white mb-4"/>
            <input type="text" id="edit-username" placeholder="Nom d'utilisateur" class="auth-input mb-3">
            <textarea id="edit-bio" placeholder="Bio" class="auth-input mb-4" rows="3"></textarea>
            <div class="flex gap-2">
                <button onclick="closeModal('edit-modal')" class="flex-1 py-2 bg-gray-800 rounded">Annuler</button>
                <button onclick="saveProfileChanges()" class="flex-1 py-2 bg-white text-black font-bold rounded">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Suppression Video -->
    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="bg-gray-900 w-10/12 max-w-sm p-6 rounded-xl border border-gray-700 text-center">
            <h3 class="text-lg font-bold mb-2 text-white text-red-500">Supprimer la vidéo ?</h3>
            <p class="text-gray-400 text-sm mb-6">Cette action est irréversible.</p>
            <div class="flex gap-3">
                <button onclick="closeModal('delete-confirm-modal')" class="flex-1 py-2 bg-gray-800 text-white rounded font-semibold text-sm">Annuler</button>
                <button id="btn-confirm-delete" class="flex-1 py-2 bg-red-600 text-white rounded font-semibold text-sm">Supprimer</button>
            </div>
        </div>
    </div>

    <div id="logout-modal" class="modal-overlay">
        <div class="bg-gray-900 w-10/12 max-w-sm p-6 rounded-xl border border-gray-700 text-center">
            <h3 class="text-lg font-bold mb-2 text-white">Déconnexion</h3>
            <div class="flex gap-3">
                <button onclick="closeModal('logout-modal')" class="flex-1 py-2 bg-gray-800 text-white rounded font-semibold text-sm">Non</button>
                <button onclick="logout()" class="flex-1 py-2 bg-red-600 text-white rounded font-semibold text-sm">Oui</button>
            </div>
        </div>
    </div>

    <div id="upload-modal" class="modal-overlay">
        <div class="bg-gray-900 w-full h-full md:h-auto md:w-11/12 max-w-md p-6 md:rounded-xl flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">Nouvelle Publication</h3>
                <i data-lucide="x" class="cursor-pointer" onclick="closeModal('upload-modal')"></i>
            </div>
            <div class="flex-1 flex flex-col gap-4">
                <div class="border-2 border-dashed border-gray-700 rounded-lg h-64 flex flex-col items-center justify-center relative bg-black overflow-hidden" id="upload-preview-area">
                    <i data-lucide="upload-cloud" class="w-12 h-12 text-gray-500 mb-2"></i>
                    <p class="text-gray-500 text-sm">Sélectionner une vidéo</p>
                    <input type="file" id="video-file-input" accept="video/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="previewVideoUpload(this)">
                    <video id="video-preview" class="absolute inset-0 w-full h-full object-cover hidden" loop playsinline></video>
                </div>
                <textarea id="video-desc" placeholder="Décris ta vidéo..." class="auth-input h-24 resize-none"></textarea>
            </div>
            <div id="upload-status" class="text-xs text-center text-gray-400 h-4"></div>
            <button onclick="uploadVideo()" id="btn-publish" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg mt-2">Publier</button>
        </div>
    </div>

    <div id="comments-sheet" class="bottom-sheet">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900 rounded-t-xl">
            <div class="text-sm font-bold mx-auto">Commentaires</div>
            <i data-lucide="x" class="w-5 h-5 cursor-pointer absolute right-4" onclick="closeComments()"></i>
        </div>
        <div id="comments-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        <div class="p-3 border-t border-gray-800 bg-black flex items-center gap-2">
            <input type="text" id="comment-input" placeholder="Ajouter un commentaire..." class="flex-1 bg-gray-900 border-none rounded-full px-4 py-2 text-sm text-white outline-none">
            <button onclick="sendComment()" class="text-cyan-500 font-bold text-sm px-2">Publier</button>
        </div>
    </div>

    <!-- NAVBAR -->
    <div id="bottom-nav" class="fixed bottom-0 left-0 w-full bg-black border-t border-gray-800 h-14 z-30 flex justify-around items-center text-white px-2 hidden">
        <div onclick="navigateTo('feed')" class="flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-100" id="nav-feed"><i data-lucide="home" class="w-6 h-6 fill-white"></i><span class="text-[10px]">Accueil</span></div>
        <div onclick="navigateTo('discover')" class="flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-50" id="nav-discover"><i data-lucide="search" class="w-6 h-6"></i><span class="text-[10px]">Découvrir</span></div>
        <div onclick="openUploadModal()" class="relative w-12 h-8 flex justify-center items-center cursor-pointer hover:scale-105 transition"><div class="absolute left-0 w-8 h-full bg-cyan-400 rounded-lg"></div><div class="absolute right-0 w-8 h-full bg-red-500 rounded-lg"></div><div class="relative w-10 h-full bg-white rounded-lg flex items-center justify-center"><i data-lucide="plus" class="w-5 h-5 text-black font-bold"></i></div></div>
        <div onclick="navigateTo('inbox')" class="flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-50" id="nav-inbox"><i data-lucide="message-square" class="w-6 h-6"></i><span class="text-[10px]">Boîte</span></div>
        <div onclick="openMyProfile()" class="flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-50" id="nav-profile"><i data-lucide="user" class="w-6 h-6"></i><span class="text-[10px]">Profil</span></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, updateDoc, limit, arrayUnion, arrayRemove, increment, where, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCfiExPZwsF53-Ix3cCeIa3tq1MJ5359RU", authDomain: "nanofinance-9192a.firebaseapp.com", projectId: "nanofinance-9192a", storageBucket: "nanofinance-9192a.firebasestorage.app", messagingSenderId: "376434082116", appId: "1:376434082116:web:838ef702670608bc959711", measurementId: "G-9455DCWCNL" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserData = null;
        let videoObserver = null;
        let isRegistering = false;
        let currentVideoIdForComments = null;
        let currentProfileUid = null;
        let currentChatId = null;
        let currentChatReceiver = null;
        let viewedVideos = new Set();

        function getAvatarHTML(photoURL, sizeClass = "w-full h-full") {
            if (photoURL && photoURL.length > 5) {
                const optimizedUrl = photoURL.includes('cloudinary') ? photoURL.replace('/upload/', '/upload/w_200,c_fill,q_auto,f_auto/') : photoURL;
                return `<img src="${optimizedUrl}" class="${sizeClass} rounded-full object-cover border border-white">`;
            }
            return `<div class="${sizeClass} rounded-full bg-gray-700 flex items-center justify-center border border-white"><i data-lucide="user" class="text-gray-400 w-1/2 h-1/2"></i></div>`;
        }
        function formatCount(num) {
            if(!num) return "0";
            if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
            if(num >= 1000) return (num/1000).toFixed(1) + 'k';
            return num;
        }
        function getOptimizedVideoUrl(url, width = 720) {
            if (!url) return "";
            if (url.includes("cloudinary.com")) return url.replace('/upload/', `/upload/q_auto,f_auto,w_${width}/`);
            return url;
        }

        async function uploadToCloudinary(file) {
            const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, { method: 'POST', body: formData });
            const data = await response.json(); return data.secure_url;
        }
        async function sendNotification(targetUid, type, text) {
            if(targetUid === auth.currentUser.uid) return;
            await addDoc(collection(db, "users", targetUid, "notifications"), { type, text, fromUid: auth.currentUser.uid, fromUsername: currentUserData.username, fromPhoto: currentUserData.photoURL, createdAt: serverTimestamp(), read: false });
        }

        // DELETE VIDEO
        window.confirmDeleteVideo = (docId) => {
            const modal = document.getElementById('delete-confirm-modal');
            const confirmBtn = document.getElementById('btn-confirm-delete');
            modal.classList.add('open');
            confirmBtn.onclick = async () => {
                try {
                    await deleteDoc(doc(db, "videos", docId));
                    modal.classList.remove('open');
                    if(document.getElementById('profile-screen').classList.contains('active')) renderProfile(currentUserData, true);
                } catch(e) { alert("Erreur suppression: " + e.message); }
            };
        };

        // SHARE VIDEO
        window.shareVideo = (url) => {
            if (navigator.share) {
                navigator.share({ title: 'R-Videos', text: 'Regarde cette vidéo incroyable !', url: url }).catch(err => { if(err.name !== 'AbortError') console.error(err); });
            } else {
                navigator.clipboard.writeText(url).then(() => alert("Lien copié !")).catch(()=>{});
            }
        };

        // FAVORITES
        window.toggleFavorite = async (docId, el) => {
            if(!auth.currentUser) return;
            const isFav = el.classList.contains('favorited');
            const ref = doc(db, "videos", docId);
            if(isFav) {
                el.classList.remove('favorited');
                el.querySelector('svg').classList.remove('fill-yellow-500', 'text-yellow-500');
                await updateDoc(ref, { favorites: arrayRemove(auth.currentUser.uid) });
            } else {
                el.classList.add('favorited');
                el.querySelector('svg').classList.add('fill-yellow-500', 'text-yellow-500');
                await updateDoc(ref, { favorites: arrayUnion(auth.currentUser.uid) });
            }
        };

        // AUTH & NAV
        window.toggleAuthMode = () => { document.getElementById('login-form').classList.toggle('hidden'); document.getElementById('register-form').classList.toggle('hidden'); };
        document.getElementById('btn-register').addEventListener('click', async () => {
            const email = document.getElementById('reg-email').value, pass = document.getElementById('reg-pass').value, username = document.getElementById('reg-username').value;
            if (!email || !pass || !username) return;
            try {
                isRegistering = true; const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "users", cred.user.uid), { username, email, photoURL: "", bio: "Nouveau membre", followers: [], following: [], uid: cred.user.uid, createdAt: serverTimestamp() });
                await updateProfile(cred.user, { displayName: username });
                await signOut(auth); isRegistering = false; window.toggleAuthMode();
                document.getElementById('auth-success').classList.remove('hidden'); document.getElementById('login-email').value = email;
            } catch (e) { isRegistering = false; alert(e.message); }
        });
        document.getElementById('btn-login').addEventListener('click', async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); } catch(e) { alert("Erreur connexion"); } });
        window.confirmLogout = () => { document.getElementById('logout-modal').classList.add('open'); };
        window.logout = () => { document.getElementById('logout-modal').classList.remove('open'); signOut(auth); };
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');

        onAuthStateChanged(auth, async (user) => {
            if (isRegistering) return;
            if (user) {
                document.getElementById('auth-screen').classList.remove('active'); document.getElementById('bottom-nav').classList.remove('hidden'); document.getElementById('bottom-nav').classList.add('flex');
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(userDoc.exists()) currentUserData = userDoc.data();
                window.navigateTo('feed'); loadFeed();
            } else {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById('auth-screen').classList.add('active'); document.getElementById('bottom-nav').classList.add('hidden'); document.getElementById('bottom-nav').classList.remove('flex'); currentUserData = null;
            }
        });

        window.navigateTo = (screen) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.querySelectorAll('video').forEach(v => v.pause());
            document.getElementById(screen + '-screen').classList.add('active');
            if (screen === 'feed') setTimeout(handleVideoPlayback, 100);
            if (screen === 'inbox') switchInboxTab('activities');
            updateNavUI(screen);
        };
        function updateNavUI(screen) {
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.add('opacity-50'); el.classList.remove('opacity-100'); el.querySelector('svg')?.classList.remove('fill-white'); });
            const active = document.getElementById('nav-' + screen);
            if(active) { active.classList.remove('opacity-50'); active.classList.add('opacity-100'); if(screen==='feed') active.querySelector('svg')?.classList.add('fill-white'); }
        }

        // FEED
        function loadFeed() {
            onSnapshot(query(collection(db, "videos"), orderBy("createdAt", "desc"), limit(20)), (snapshot) => {
                if (!auth.currentUser) return;
                if(videoObserver) videoObserver.disconnect();
                if(snapshot.empty) return document.getElementById('feed-container').innerHTML = '<div class="h-full flex items-center justify-center text-gray-500">Aucune vidéo.</div>';
                let html = "";
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const iLiked = data.likedBy?.includes(auth.currentUser.uid);
                    const iFav = data.favorites?.includes(auth.currentUser.uid);
                    const optimizedUrl = getOptimizedVideoUrl(data.url, 720);
                    
                    // AVATAR AVEC BADGE PLUS
                    const avatarSection = `
                    <div class="relative mb-4 cursor-pointer" onclick="viewUserProfile('${data.userId}')">
                        <div class="w-12 h-12 rounded-full border-2 border-white overflow-hidden bg-black transition transform hover:scale-110">
                            ${getAvatarHTML(data.userPhotoURL, "w-full h-full object-cover")}
                        </div>
                        <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-red-600 rounded-full w-5 h-5 flex items-center justify-center shadow-md">
                            <i data-lucide="plus" class="w-3 h-3 text-white font-bold"></i>
                        </div>
                    </div>`;

                    html += `<div class="video-card w-full h-full relative snap-start bg-gray-900 border-b border-gray-800" data-id="${docSnap.id}">
                        <video class="w-full h-full object-cover pointer-events-none" loop playsinline preload="metadata" src="${optimizedUrl}"></video>
                        <div class="absolute inset-0 z-10" onclick="togglePlay(this)"></div>
                        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-black/60 pointer-events-none"></div>
                        <div class="absolute right-2 bottom-32 flex flex-col items-center gap-6 z-20 pb-4">
                            
                            ${avatarSection}
                            
                            <div class="flex flex-col items-center gap-1 cursor-pointer group ${iLiked ? 'liked' : ''}" onclick="toggleLike('${docSnap.id}', this, '${data.userId}')">
                                <i data-lucide="heart" class="w-9 h-9 icon-shadow ${iLiked ? 'fill-red-500 text-red-500' : 'text-white fill-white'} transition-all"></i>
                                <span class="text-xs font-bold text-shadow">${formatCount(data.likes)}</span>
                            </div>
                            
                            <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="openComments('${docSnap.id}')">
                                <i data-lucide="message-circle" class="w-9 h-9 icon-shadow text-white fill-white"></i>
                                <span class="text-xs font-bold text-shadow">${formatCount(data.commentCount)}</span>
                            </div>
                            
                            <div class="flex flex-col items-center gap-1 cursor-pointer ${iFav ? 'favorited' : ''}" onclick="toggleFavorite('${docSnap.id}', this)">
                                <i data-lucide="bookmark" class="w-9 h-9 icon-shadow ${iFav ? 'fill-yellow-500 text-yellow-500' : 'text-white fill-white'} transition-all"></i>
                                <span class="text-xs font-bold text-shadow">${iFav ? 'Fav' : 'Fav'}</span>
                            </div>

                            <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="shareVideo('${data.url}')">
                                <i data-lucide="share-2" class="w-9 h-9 icon-shadow text-white fill-white"></i>
                                <span class="text-xs font-bold text-shadow">Partager</span>
                            </div>

                            <div class="mt-4 relative animate-spin-slow"><div class="w-10 h-10 bg-gray-800 rounded-full border-4 border-gray-900 flex items-center justify-center overflow-hidden">${getAvatarHTML(data.userPhotoURL, "w-full h-full")}</div></div>
                        </div>
                        <div class="absolute bottom-20 left-4 right-20 z-20 text-left pointer-events-none">
                            <h3 class="font-bold text-lg text-shadow mb-1">@${data.username}</h3>
                            <p class="text-sm mb-2 text-shadow text-gray-100 line-clamp-3">${data.description}</p>
                        </div>
                    </div>`;
                });
                document.getElementById('feed-container').innerHTML = html; lucide.createIcons(); handleVideoPlayback();
            });
        }
        
        window.togglePlay = (el) => { const v = el.parentElement.querySelector('video'); v.paused ? v.play().catch(()=>{}) : v.pause(); };
        function handleVideoPlayback() {
            if(videoObserver) videoObserver.disconnect();
            const options = { root: document.getElementById('feed-container'), threshold: 0.6 };
            videoObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => { 
                    const v = entry.target.querySelector('video'); if (!v) return;
                    if(entry.isIntersecting) {
                        v.play().catch(e=>{});
                        const vidId = entry.target.getAttribute('data-id');
                        if(vidId && !viewedVideos.has(vidId)) { viewedVideos.add(vidId); updateDoc(doc(db, "videos", vidId), { views: increment(1) }).catch(e=>{}); }
                    } else { v.currentTime = 0; v.pause(); } 
                });
            }, options);
            document.querySelectorAll('.video-card').forEach(c => videoObserver.observe(c));
        }
        window.toggleLike = async (docId, el, authorId) => {
            if(!auth.currentUser) return;
            const isLiked = el.classList.contains('liked');
            const ref = doc(db, "videos", docId);
            if(isLiked) { el.classList.remove('liked'); el.querySelector('svg').classList.remove('fill-red-500','text-red-500'); el.querySelector('svg').classList.add('text-white', 'fill-white'); await updateDoc(ref, {likes: increment(-1), likedBy: arrayRemove(auth.currentUser.uid)}); }
            else { el.classList.add('liked'); el.querySelector('svg').classList.add('fill-red-500','text-red-500','like-animation'); el.querySelector('svg').classList.remove('text-white', 'fill-white'); setTimeout(()=>el.querySelector('svg').classList.remove('like-animation'),300); await updateDoc(ref, {likes: increment(1), likedBy: arrayUnion(auth.currentUser.uid)}); sendNotification(authorId, "like", "a aimé votre vidéo"); }
        };

        // COMMENTS, SEARCH, INBOX, CHAT (Même logique que précédemment)
        window.openComments = (id) => { currentVideoIdForComments = id; document.getElementById('comments-sheet').classList.add('open'); loadComments(id); };
        window.closeComments = () => { document.getElementById('comments-sheet').classList.remove('open'); currentVideoIdForComments = null; };
        function loadComments(id) {
            const list = document.getElementById('comments-list'); list.innerHTML = "<div class='text-center text-sm py-4'>Chargement...</div>";
            onSnapshot(query(collection(db, `videos/${id}/comments`), orderBy("createdAt", "asc")), (snap) => {
                let html = ""; snap.forEach(d => { const c = d.data(); const isLiked = c.likedBy?.includes(auth.currentUser.uid); html += `<div class="flex gap-3 mb-4 w-full"><div class="flex-shrink-0 cursor-pointer" onclick="window.viewUserProfile('${c.userId}'); window.closeComments()">${getAvatarHTML(c.userPhotoURL, "w-8 h-8")}</div><div class="flex-1"><div class="text-xs font-bold text-gray-400 cursor-pointer" onclick="window.viewUserProfile('${c.userId}'); window.closeComments()">@${c.username}</div><div class="text-sm">${c.text}</div></div><div class="flex flex-col items-center justify-center cursor-pointer" onclick="toggleCommentLike('${id}', '${d.id}', '${c.userId}')"><i data-lucide="heart" class="w-4 h-4 ${isLiked ? 'fill-red-500 text-red-500' : 'text-gray-500'}"></i><span class="text-[10px] text-gray-500">${c.likes || 0}</span></div></div>`; });
                list.innerHTML = html || "<div class='text-center text-sm py-4 text-gray-500'>Aucun commentaire.</div>"; lucide.createIcons();
            });
        }
        window.toggleCommentLike = async (vidId, cId, aId) => {
            const ref = doc(db, `videos/${vidId}/comments`, cId); const snap = await getDoc(ref); if(!snap.exists()) return;
            if(snap.data().likedBy?.includes(auth.currentUser.uid)) await updateDoc(ref, { likes: increment(-1), likedBy: arrayRemove(auth.currentUser.uid) });
            else { await updateDoc(ref, { likes: increment(1), likedBy: arrayUnion(auth.currentUser.uid) }); sendNotification(aId, "comment_like", "a aimé votre commentaire"); }
        };
        window.sendComment = async () => {
            const inp = document.getElementById('comment-input'); const txt = inp.value.trim(); if(!txt || !currentVideoIdForComments) return;
            inp.value = "";
            await addDoc(collection(db, `videos/${currentVideoIdForComments}/comments`), { text: txt, userId: auth.currentUser.uid, username: currentUserData.username, userPhotoURL: currentUserData.photoURL||"", likes: 0, likedBy: [], createdAt: serverTimestamp() });
            await updateDoc(doc(db, "videos", currentVideoIdForComments), { commentCount: increment(1) });
            const vidSnap = await getDoc(doc(db, "videos", currentVideoIdForComments)); if(vidSnap.exists()) sendNotification(vidSnap.data().userId, "comment", "a commenté: " + txt);
        };
        window.switchInboxTab = (tab) => {
            document.getElementById('tab-activities').classList.toggle('border-b-2', tab==='activities'); document.getElementById('tab-activities').classList.toggle('text-gray-500', tab!=='activities');
            document.getElementById('tab-messages').classList.toggle('border-b-2', tab==='messages'); document.getElementById('tab-messages').classList.toggle('text-gray-500', tab!=='messages');
            if(tab === 'activities') loadActivities(); else loadConversations();
        };
        function loadActivities() {
            const list = document.getElementById('inbox-content'); list.innerHTML = "Chargement...";
            onSnapshot(query(collection(db, "users", auth.currentUser.uid, "notifications"), orderBy("createdAt", "desc"), limit(20)), (snap) => {
                if(snap.empty) return list.innerHTML = "<div class='text-center text-gray-500 mt-4'>Aucune activité.</div>";
                let html = ""; snap.forEach(d => { const n = d.data(); let icon = "bell"; let color = "text-yellow-500"; if(n.type === 'like') { icon = "heart"; color = "text-red-500"; } if(n.type === 'follow') { icon = "user-plus"; color = "text-blue-500"; } if(n.type === 'comment') { icon = "message-circle"; color = "text-green-500"; } html += `<div class="flex items-center gap-3 py-2 border-b border-gray-800"><div class="relative w-12 h-12">${getAvatarHTML(n.fromPhoto, "w-full h-full")}<div class="absolute -bottom-1 -right-1 bg-gray-900 rounded-full p-1"><i data-lucide="${icon}" class="w-4 h-4 ${color}"></i></div></div><div><p class="text-sm"><span class="font-bold">@${n.fromUsername}</span> ${n.text}</p></div></div>`; });
                list.innerHTML = html; lucide.createIcons();
            });
        }
        function loadConversations() {
            const list = document.getElementById('inbox-content'); list.innerHTML = "Chargement...";
            const q = query(collection(db, "chats"), where("participants", "array-contains", auth.currentUser.uid));
            onSnapshot(q, (snap) => {
                if(snap.empty) return list.innerHTML = "<div class='text-center text-gray-500 mt-4'>Aucun message.</div>";
                let chats = []; snap.forEach(d => chats.push(d.data()));
                chats.sort((a, b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0));
                let html = ""; chats.forEach(c => { const oId = c.participants.find(p => p !== auth.currentUser.uid); if(oId && c.names) html += `<div onclick="startChatWith('${oId}', '${c.names[oId]}', '${c.photos[oId]}')" class="flex items-center gap-3 py-3 border-b border-gray-800 cursor-pointer hover:bg-gray-900"><div class="w-12 h-12 flex-shrink-0">${getAvatarHTML(c.photos[oId], "w-full h-full")}</div><div class="flex-1 min-w-0"><div class="font-bold truncate">@${c.names[oId]}</div><div class="text-sm text-gray-400 truncate">${c.lastMessage}</div></div></div>`; });
                list.innerHTML = html;
            });
        }
        window.startChat = () => { if(currentProfileUid) startChatWith(currentProfileUid, document.getElementById('profile-handle').innerText.substring(1), document.getElementById('profile-avatar-container').querySelector('img')?.src || ""); };
        window.startChatWith = (uid, name, photo) => { currentChatReceiver = uid; document.getElementById('chat-username').innerText = name; document.getElementById('chat-avatar').innerHTML = getAvatarHTML(photo, "w-full h-full"); const ids = [auth.currentUser.uid, uid].sort(); currentChatId = ids[0] + "_" + ids[1]; document.getElementById('chat-screen').classList.add('open'); loadMessages(currentChatId); };
        window.closeChat = () => document.getElementById('chat-screen').classList.remove('open');
        function loadMessages(cId) {
            const box = document.getElementById('chat-messages'); box.innerHTML = "";
            onSnapshot(query(collection(db, "chats", cId, "messages"), orderBy("createdAt", "asc")), (snap) => {
                let html = ""; snap.forEach(d => { const m = d.data(); html += `<div class="msg-bubble ${m.senderId === auth.currentUser.uid ? 'msg-me' : 'msg-other'}">${m.text}</div>`; });
                box.innerHTML = html; box.scrollTop = box.scrollHeight;
            });
        }
        window.sendMessage = async () => {
            const inp = document.getElementById('chat-input'); const txt = inp.value.trim(); if(!txt || !currentChatId) return;
            inp.value = ""; await addDoc(collection(db, "chats", currentChatId, "messages"), { text: txt, senderId: auth.currentUser.uid, createdAt: serverTimestamp() });
            const cref = doc(db, "chats", currentChatId); const csnap = await getDoc(cref);
            if(!csnap.exists()) { const n={}; n[auth.currentUser.uid]=currentUserData.username; n[currentChatReceiver]=document.getElementById('chat-username').innerText; const p={}; p[auth.currentUser.uid]=currentUserData.photoURL; p[currentChatReceiver]=document.getElementById('chat-avatar').querySelector('img')?.src||""; await setDoc(cref, {participants:[auth.currentUser.uid, currentChatReceiver], names:n, photos:p, lastMessage:txt, lastUpdated:serverTimestamp()}); }
            else await updateDoc(cref, { lastMessage: txt, lastUpdated: serverTimestamp() });
        };
        window.openMyProfile = () => { if(!auth.currentUser) return; renderProfile(currentUserData, true); navigateTo('profile'); };
        window.viewUserProfile = async (uid) => { if(!auth.currentUser) return; if(uid === auth.currentUser.uid) return openMyProfile(); const snap = await getDoc(doc(db, "users", uid)); if(snap.exists()) { renderProfile(snap.data(), false); navigateTo('profile'); } };
        window.searchUsers = async (term) => {
            const container = document.getElementById('search-results'); if(!term || term.length < 2) { container.innerHTML = "<div class='text-gray-500 text-center text-sm mt-10'>Tapez un nom...</div>"; return; }
            const snap = await getDocs(query(collection(db, "users"), where('username', '>=', term), where('username', '<=', term + '\uf8ff'), limit(10)));
            if(snap.empty) { container.innerHTML = "<div class='text-gray-500 text-center text-sm mt-10'>Aucun utilisateur.</div>"; return; }
            let html = ""; snap.forEach(doc => { const u = doc.data(); html += `<div onclick="viewUserProfile('${u.uid}')" class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-800"><div class="w-10 h-10">${getAvatarHTML(u.photoURL, "w-full h-full")}</div><div><div class="font-bold">@${u.username}</div><div class="text-xs text-gray-400">${u.bio || ''}</div></div></div>`; });
            container.innerHTML = html;
        };
        async function renderProfile(data, isMe) {
            currentProfileUid = data.uid; document.getElementById('profile-handle').textContent = "@" + data.username; document.getElementById('profile-bio').textContent = data.bio || "Pas de bio"; document.getElementById('profile-avatar-container').innerHTML = getAvatarHTML(data.photoURL, "w-full h-full");
            document.getElementById('my-profile-actions').classList.toggle('hidden', !isMe); document.getElementById('other-profile-actions').classList.toggle('hidden', isMe);
            document.getElementById('profile-followers').innerText = data.followers ? data.followers.length : 0;
            if(!isMe) { const btn = document.getElementById('btn-follow'); const isF = data.followers?.includes(auth.currentUser.uid); updateFollowButtonUI(btn, isF); }
            const grid = document.getElementById('profile-videos-grid'); grid.innerHTML = "<div class='col-span-3 text-center text-gray-500'>Chargement...</div>";
            let likes = 0; const snap = await getDocs(query(collection(db, "videos"), orderBy("createdAt", "desc")));
            grid.innerHTML = "";
            snap.forEach(d => {
                const v = d.data();
                if(v.userId === data.uid) {
                    likes += (v.likes || 0);
                    // Add delete button on profile thumbnails if it's me
                    const delBtn = isMe ? `<div class="absolute top-1 right-1 bg-black/50 p-1 rounded-full cursor-pointer z-10" onclick="event.stopPropagation(); confirmDeleteVideo('${d.id}')"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></div>` : '';
                    
                    const div = document.createElement('div'); div.className = "bg-gray-800 aspect-[3/4] relative border border-black group"; 
                    div.innerHTML = `${delBtn}<video src="${getOptimizedVideoUrl(v.url, 300)}" class="w-full h-full object-cover" muted playsinline></video><div class="absolute bottom-1 left-1 flex items-center gap-1 text-[10px] font-bold text-white drop-shadow-md"><i data-lucide="play" class="w-3 h-3 fill-white"></i> ${formatCount(v.views)}</div>`;
                    grid.appendChild(div);
                }
            });
            document.getElementById('profile-likes').innerText = formatCount(likes); lucide.createIcons();
        }
        function updateFollowButtonUI(btn, isFollowing) {
            btn.innerText = isFollowing ? "Abonné" : "S'abonner";
            btn.className = isFollowing ? "flex-1 bg-gray-200 text-black py-2 rounded text-sm font-semibold" : "flex-1 bg-red-600 text-white py-2 rounded text-sm font-semibold";
        }
        window.toggleFollow = async () => {
            if (!currentProfileUid || !auth.currentUser) return;
            const tRef = doc(db, "users", currentProfileUid); const mRef = doc(db, "users", auth.currentUser.uid);
            const snap = await getDoc(tRef); const isF = snap.data().followers?.includes(auth.currentUser.uid);
            const btn = document.getElementById('btn-follow'); const cnt = document.getElementById('profile-followers');
            let n = parseInt(cnt.innerText);
            if (isF) { await updateDoc(tRef, {followers:arrayRemove(auth.currentUser.uid)}); await updateDoc(mRef, {following:arrayRemove(currentProfileUid)}); updateFollowButtonUI(btn, false); cnt.innerText = n-1; }
            else { await updateDoc(tRef, {followers:arrayUnion(auth.currentUser.uid)}); await updateDoc(mRef, {following:arrayUnion(currentProfileUid)}); updateFollowButtonUI(btn, true); cnt.innerText = n+1; sendNotification(currentProfileUid, "follow", "a commencé à vous suivre"); }
        };
        window.openEditProfile = () => { document.getElementById('edit-username').value = currentUserData.username; document.getElementById('edit-bio').value = currentUserData.bio; document.getElementById('edit-modal').classList.add('open'); };
        window.saveProfileChanges = async () => {
            const file = document.getElementById('edit-file-input').files[0]; let url = currentUserData.photoURL; if(file) url = await uploadToCloudinary(file);
            await updateDoc(doc(db, "users", auth.currentUser.uid), { username: document.getElementById('edit-username').value, bio: document.getElementById('edit-bio').value, photoURL: url });
            currentUserData = (await getDoc(doc(db, "users", auth.currentUser.uid))).data();
            if(file) { const vidSnap = await getDocs(query(collection(db, "videos"), where("userId", "==", auth.currentUser.uid))); vidSnap.forEach(async (v) => { await updateDoc(doc(db, "videos", v.id), { userPhotoURL: url }); }); }
            window.closeModal('edit-modal'); renderProfile(currentUserData, true);
        };
        window.openUploadModal = () => document.getElementById('upload-modal').classList.add('open');
        window.previewVideoUpload = (i) => { if(i.files[0]) { const v=document.getElementById('video-preview'); v.src=URL.createObjectURL(i.files[0]); v.classList.remove('hidden'); v.play(); document.getElementById('upload-preview-area').querySelector('i').classList.add('hidden'); document.getElementById('upload-preview-area').querySelector('p').classList.add('hidden'); } };
        window.uploadVideo = async () => {
            const f = document.getElementById('video-file-input').files[0]; if(!f) return;
            const btn = document.getElementById('btn-publish'); btn.disabled=true; btn.innerText="Envoi...";
            try {
                const url = await uploadToCloudinary(f);
                await addDoc(collection(db, "videos"), { userId: auth.currentUser.uid, username: currentUserData.username, userPhotoURL: currentUserData.photoURL||"", url, description: document.getElementById('video-desc').value, likes: 0, likedBy: [], favorites: [], commentCount: 0, views: 0, createdAt: serverTimestamp() });
                window.closeModal('upload-modal'); navigateTo('feed');
            } catch(e) { alert(e.message); } finally { btn.disabled=false; btn.innerText="Publier"; }
        };

        lucide.createIcons();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Videos Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- ONESIGNAL SDK INTEGRATION -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        try {
            await OneSignal.init({
              appId: "784b7423-3539-448c-8d8d-80e8b0bed456",
              safari_web_id: "web.onesignal.auto.35c3b21f-3634-4ed2-bd52-fd09e2637415",
              notifyButton: { enable: false },
              promptOptions: {
                slidedown: {
                  enabled: true,
                  autoPrompt: true,
                  actionMessage: "Active les notifications pour recevoir les likes et commentaires üîî",
                  acceptButtonText: "Autoriser",
                  cancelButtonText: "Plus tard"
                }
              }
            });
            OneSignal.Slidedown.promptPush();
        } catch (e) { console.warn("Erreur OneSignal:", e); }
      });
    </script>
    <style>
        /* THEME COULEUR : MIDNIGHT BLUE (#0f172a) */
        body, html { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #0f172a; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overscroll-behavior-y: contain; }
        .snap-y-mandatory { scroll-snap-type: y mandatory; }
        .snap-start { scroll-snap-align: start; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-spin-slow { animation: spin 4s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .like-animation { animation: pop 0.3s ease-in-out; }
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; z-index: 10; background: #0f172a; }
        .screen.active { display: flex; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        
        .bottom-sheet { position: fixed; bottom: 0; left: 0; width: 100%; height: auto; max-height: 75%; background: #1e293b; border-t-left-radius: 16px; border-t-right-radius: 16px; z-index: 60; transform: translateY(100%); transition: transform 0.3s ease-out; display: flex; flex-direction: column; }
        .bottom-sheet.open { transform: translateY(0); }
        
        .full-screen-modal { position: fixed; inset: 0; background: #0f172a; z-index: 70; transform: translateX(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .full-screen-modal.open { transform: translateX(0); }
        
        .liked svg { fill: #ef4444; color: #ef4444; }
        .favorited svg { fill: #eab308; color: #eab308; }
        .text-shadow { text-shadow: 1px 1px 2px rgba(0,0,0,0.8); }
        .icon-shadow { filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.5)); }
        
        .auth-input { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; }
        
        .msg-bubble { max-width: 75%; padding: 8px 12px; border-radius: 16px; margin-bottom: 2px; font-size: 14px; position: relative; word-break: break-word; }
        .msg-me { align-self: flex-end; background-color: #ef4444; color: white; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background-color: #334155; color: white; border-bottom-left-radius: 4px; }
        
        .msg-status { align-self: flex-end; margin-bottom: 8px; margin-right: 4px; display: flex; align-items: center; }
        .verified-badge { fill: #3b82f6; color: white; display: inline-block; vertical-align: middle; margin-left: 4px; }
        .custom-checkbox { accent-color: #ef4444; width: 16px; height: 16px; cursor: pointer; }
        
        #ptr-loader { transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); z-index: 9999; }
        .ptr-icon { transition: transform 0.2s; }
        .body-content { transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); height: 100%; width: 100%; }
        
        .big-heart { position: absolute; transform: translate(-50%, -50%) scale(0); animation: bigHeartAnim 0.8s ease-out forwards; pointer-events: none; z-index: 50; }
        @keyframes bigHeartAnim {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-15deg); opacity: 1; }
            15% { transform: translate(-50%, -50%) scale(1.5) rotate(0deg); opacity: 1; }
            30% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 0; }
        }
        .trim-input { @apply bg-gray-800 text-white border border-gray-600 rounded px-2 py-1 text-xs w-20 text-center; }
        
        /* Custom Range Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ef4444; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        /* Custom Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #ef4444; }
        .toggle-checkbox:checked + .toggle-label { background-color: #ef4444; }
        
        /* Lang Selector Style */
        .lang-select {
            appearance: none;
            background-color: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 24px 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='white' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>
<body class="relative overflow-hidden bg-[#0f172a]">
    <div id="ptr-loader" class="fixed top-0 left-0 w-full flex justify-center pt-4 -translate-y-16 pointer-events-none">
        <div class="bg-white rounded-full p-2 shadow-xl border border-gray-200">
            <svg id="ptr-spinner" class="w-6 h-6 text-red-600 animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <i id="ptr-arrow" data-lucide="arrow-down" class="w-6 h-6 text-black"></i>
        </div>
    </div>
    
    <div id="main-app-container" class="body-content relative">
        <script>
            const CLOUDINARY_CLOUD_NAME = "dh68eblab"; 
            const CLOUDINARY_UPLOAD_PRESET = "uxyhxrib"; 
            const VIP_EMAIL = "virgulemili@gmail.com"; 
        </script>
        <div id="splash-screen" class="screen active justify-center items-center bg-[#0f172a] z-[100]">
            <div class="text-center animate-pulse">
                <h1 class="text-5xl font-black text-red-600 tracking-tighter mb-4">R-VIDEOS</h1>
                <div class="w-8 h-8 border-4 border-red-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
            </div>
        </div>
        <div id="offline-screen" class="screen justify-center items-center bg-[#0f172a] z-[99]">
            <div class="text-center p-8">
                <i data-lucide="wifi-off" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                <h2 class="text-xl font-bold mb-2" data-i18n="offline_title">Pas de connexion internet</h2>
                <p class="text-gray-400 text-sm mb-6" data-i18n="offline_desc">V√©rifiez votre connexion et r√©essayez.</p>
                <button onclick="window.location.reload()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full transition" data-i18n="retry_btn">R√©essayer</button>
            </div>
        </div>
        <div id="auth-screen" class="screen justify-center items-center p-8 bg-gradient-to-br from-[#0f172a] to-[#1e293b] relative">
            <!-- LANGUAGE SELECTOR -->
            <div class="absolute top-4 right-4 z-20">
                <select id="lang-selector" class="lang-select" onchange="changeLanguage(this.value)">
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                    <option value="en">üá∫üá∏ English</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="pt">üáµüáπ Portugu√™s</option>
                    <option value="de">üá©üá™ Deutsch</option>
                    <option value="tr">üáπüá∑ T√ºrk√ße</option>
                    <option value="id">üáÆüá© Indonesia</option>
                    <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                    <option value="hi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                    <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                    <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                    <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                </select>
            </div>
            <div class="absolute top-12 w-full text-center">
                <p class="text-[10px] text-gray-500 uppercase tracking-[0.2em] font-medium"><span data-i18n="app_created_by">Application cr√©√©e par</span> <br><span class="text-gray-400 font-bold" data-i18n="studio_name">"Le Studio Ralph Nyam√®". 2025</span></p>
            </div>
            <div class="w-full max-w-sm text-center mt-10">
                <h1 class="text-4xl font-black mb-2 text-red-500 tracking-tighter">R-VIDEOS</h1>
                <p class="text-gray-400 mb-8 text-sm" data-i18n="subtitle">R√©seau Social Vid√©o</p>
                <div id="auth-success" class="hidden mb-4 p-3 bg-green-900/50 border border-green-500 text-green-200 rounded-lg text-sm" data-i18n="auth_success">Compte cr√©√© ! Connectez-vous.</div>
                
                <div id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="auth-input" data-i18n-placeholder="email_placeholder">
                    <div class="relative">
                        <input type="password" id="login-pass" placeholder="Mot de passe" class="auth-input pr-10" data-i18n-placeholder="pass_placeholder">
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 cursor-pointer" onclick="togglePassword('login-pass', this)"><i data-lucide="eye" class="w-5 h-5 eye"></i><i data-lucide="eye-off" class="w-5 h-5 eye-off hidden"></i></div>
                    </div>
                    <div class="text-right">
                        <span onclick="toggleForgotPasswordMode()" class="text-xs text-gray-400 cursor-pointer hover:text-white" data-i18n="forgot_pass">Mot de passe oubli√© ?</span>
                    </div>
                    <button id="btn-login" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition flex justify-center items-center h-12" data-i18n="login_btn">Se connecter</button>
                    <p class="text-xs text-gray-400 mt-4"><span data-i18n="no_account">Pas encore de compte ?</span> <span onclick="toggleAuthMode()" class="text-white font-bold cursor-pointer underline" data-i18n="signup_link">S'inscrire</span></p>
                </div>
                <div id="register-form" class="space-y-4 hidden">
                    <input type="text" id="reg-username" placeholder="Nom d'utilisateur" class="auth-input" data-i18n-placeholder="username_placeholder">
                    <input type="email" id="reg-email" placeholder="Email (Gmail requis)" class="auth-input" data-i18n-placeholder="email_placeholder">
                    <div class="relative">
                        <input type="password" id="reg-pass" placeholder="Mot de passe" class="auth-input pr-10" data-i18n-placeholder="pass_placeholder">
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 cursor-pointer" onclick="togglePassword('reg-pass', this)"><i data-lucide="eye" class="w-5 h-5 eye"></i><i data-lucide="eye-off" class="w-5 h-5 eye-off hidden"></i></div>
                    </div>
                    <div class="flex items-start gap-2 text-left mt-2">
                        <input type="checkbox" id="reg-privacy" class="custom-checkbox mt-1">
                        <label for="reg-privacy" class="text-xs text-gray-400 leading-tight"><span data-i18n="privacy_text">En cochant cette case, j'accepte la</span> <span onclick="openPrivacyPolicy()" class="text-blue-500 underline cursor-pointer" data-i18n="privacy_link">Politique de Confidentialit√©</span>.</label>
                    </div>
                    <button id="btn-register" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-lg transition mt-2 flex justify-center items-center h-12" data-i18n="register_btn">Cr√©er mon compte</button>
                    <p class="text-xs text-gray-400 mt-4"><span data-i18n="has_account">D√©j√† un compte ?</span> <span onclick="toggleAuthMode()" class="text-white font-bold cursor-pointer underline" data-i18n="login_link">Se connecter</span></p>
                </div>
                <div id="forgot-password-form" class="space-y-4 hidden">
                    <h3 class="text-white font-bold text-lg mb-2" data-i18n="reset_title">R√©initialisation</h3>
                    <p class="text-gray-400 text-xs mb-4" data-i18n="reset_desc">Entrez votre email pour recevoir un lien de r√©initialisation.</p>
                    <input type="email" id="reset-email" placeholder="Email" class="auth-input" data-i18n-placeholder="email_placeholder">
                    
                    <!-- FEEDBACK BOX -->
                    <div id="reset-feedback" class="hidden p-3 bg-blue-900/50 border border-blue-500 text-blue-200 rounded-lg text-sm mb-2 text-left"></div>
                    
                    <button id="btn-reset-pass" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition flex justify-center items-center h-12" data-i18n="send_link_btn">Envoyer le lien</button>
                    <p class="text-xs text-gray-400 mt-4"><span onclick="toggleForgotPasswordMode()" class="text-white font-bold cursor-pointer underline" data-i18n="back_login">Retour √† la connexion</span></p>
                </div>
                
                <p id="auth-error" class="text-red-500 text-sm mt-4 hidden bg-red-900/30 p-2 rounded border border-red-800"></p>
            </div>
        </div>
        <div id="feed-screen" class="screen relative">
            <div class="absolute top-0 left-0 w-full z-20 pt-4 pb-2 bg-gradient-to-b from-[#0f172a]/90 to-transparent pointer-events-none">
                <div class="flex justify-center items-center gap-4 text-base font-semibold pointer-events-auto">
                    <span id="tab-following" class="text-gray-400 cursor-pointer transition-colors" onclick="switchFeed('following')" data-i18n="tab_following">Abonnements</span>
                    <span id="tab-foryou" class="text-white border-b-2 border-white pb-0.5 cursor-pointer shadow-lg transition-colors" onclick="switchFeed('foryou')" data-i18n="tab_foryou">Pour toi</span>
                </div>
            </div>
            <div id="feed-container" class="h-full w-full overflow-y-scroll snap-y-mandatory no-scrollbar relative bg-[#0f172a]">
                <div id="loading-feed" class="flex items-center justify-center h-full text-gray-500"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div></div>
            </div>
        </div>
        
        <div id="fullscreen-video-overlay" class="fixed inset-0 z-50 bg-[#0f172a] hidden flex-col">
            <div class="absolute top-0 left-0 w-full z-20 p-4">
                <i data-lucide="chevron-left" class="w-8 h-8 text-white cursor-pointer drop-shadow-md" onclick="closeFullVideo()"></i>
            </div>
            <div id="fullscreen-video-container" class="w-full h-full relative"></div>
        </div>
        <div id="discover-screen" class="screen bg-[#0f172a] pt-4 px-4 pb-20 overflow-y-auto">
            <h2 class="font-bold text-xl mb-4" data-i18n="nav_discover">D√©couvrir</h2>
            <div class="relative mb-6">
                <i data-lucide="search" class="absolute left-3 top-3 text-gray-400 w-5 h-5"></i>
                <input type="text" id="search-input" placeholder="Rechercher des utilisateurs..." class="w-full bg-[#1e293b] rounded-lg py-3 pl-10 pr-4 text-white outline-none focus:ring-1 focus:ring-gray-700" oninput="searchUsers(this.value)" data-i18n-placeholder="search_placeholder">
            </div>
            <div id="trending-container">
                <div class="flex items-center gap-2 mb-3">
                    <i data-lucide="flame" class="w-4 h-4 text-red-500 fill-red-500"></i>
                    <h3 class="font-bold text-sm text-gray-200" data-i18n="trending_title">Top Vid√©os</h3>
                </div>
                <div id="trending-grid" class="grid grid-cols-3 gap-0.5"></div>
            </div>
            <div id="search-results" class="space-y-4 hidden pb-20">
                <div class="text-gray-500 text-center text-sm mt-10">...</div>
            </div>
        </div>
        <div id="inbox-screen" class="screen bg-[#0f172a] pt-4 px-0 pb-20">
            <h2 class="font-bold text-xl mb-4 px-4" data-i18n="inbox_title">Bo√Æte de r√©ception</h2>
            <div class="flex border-b border-[#334155] px-4 mb-4">
                <div onclick="switchInboxTab('activities')" id="tab-activities" class="pb-2 border-b-2 border-white font-semibold mr-6 cursor-pointer" data-i18n="tab_activities">Activit√©s</div>
                <div onclick="switchInboxTab('messages')" id="tab-messages" class="pb-2 text-gray-500 font-semibold cursor-pointer" data-i18n="tab_messages">Messages</div>
            </div>
            <div id="inbox-content" class="px-4 space-y-4 overflow-y-auto h-full pb-20"></div>
        </div>
        <div id="profile-screen" class="screen bg-[#0f172a] pt-10 px-4 overflow-y-auto pb-20">
            <div class="flex justify-between items-center mb-6">
                <i data-lucide="chevron-left" class="w-6 h-6 text-white cursor-pointer" onclick="navigateTo('feed')"></i>
                <h2 class="font-bold text-lg" id="profile-header-name" data-i18n="profile_title">Profil</h2>
                <i data-lucide="more-horizontal" class="w-6 h-6 text-white cursor-pointer" onclick="confirmLogout()"></i>
            </div>
            <div class="flex flex-col items-center mb-8">
                <div id="profile-avatar-container" class="w-24 h-24 rounded-full border-2 border-gray-700 flex items-center justify-center mb-4 overflow-hidden bg-[#1e293b]"></div>
                <div class="flex items-center gap-1 mb-1">
                    <h1 id="profile-handle" class="text-xl font-bold">@utilisateur</h1>
                    <span id="profile-badge-container"></span>
                </div>
                <p id="profile-bio" class="text-gray-400 text-sm mb-4 text-center max-w-xs">...</p>
                <div class="flex gap-6 mt-2 text-center">
                    <div><div class="font-bold text-lg" id="profile-following">0</div><div class="text-xs text-gray-400" data-i18n="following">Abonnements</div></div>
                    <div><div class="font-bold text-lg" id="profile-followers">0</div><div class="text-xs text-gray-400" data-i18n="followers">Abonn√©s</div></div>
                    <div><div class="font-bold text-lg" id="profile-likes">0</div><div class="text-xs text-gray-400" data-i18n="likes">J'aime</div></div>
                </div>
                <div id="my-profile-actions" class="flex gap-2 mt-6 w-full px-8 hidden">
                    <button onclick="openEditProfile()" class="flex-1 bg-[#1e293b] py-2 rounded text-sm font-semibold border border-gray-600" data-i18n="edit_profile">Modifier le profil</button>
                </div>
                <div id="other-profile-actions" class="flex gap-2 mt-6 w-full px-8 hidden">
                    <button id="btn-follow" onclick="toggleFollow()" class="flex-1 bg-red-600 text-white py-2 rounded text-sm font-semibold transition-colors" data-i18n="follow_btn">S'abonner</button>
                    <button onclick="startChat()" class="flex-1 bg-[#1e293b] text-white py-2 rounded text-sm font-semibold border border-gray-600" data-i18n="message_btn">Message</button>
                    <button id="btn-block" onclick="toggleBlock()" class="bg-[#1e293b] border border-red-900 text-red-500 py-2 px-3 rounded text-sm font-semibold"><i data-lucide="shield-off" class="w-4 h-4"></i></button>
                </div>
                <div id="admin-actions" class="mt-4 w-full px-8 hidden"></div>
            </div>
            <div class="flex border-b border-[#334155] mb-1">
                <div id="tab-profile-videos" class="flex-1 py-3 text-center border-b-2 border-white cursor-pointer transition-colors" onclick="switchProfileTab('videos')"><i data-lucide="grid-3x3" class="mx-auto w-5 h-5"></i></div>
                <div id="tab-profile-favs" class="flex-1 py-3 text-center border-b-2 border-transparent text-gray-500 cursor-pointer transition-colors" onclick="switchProfileTab('favs')"><i data-lucide="bookmark" class="mx-auto w-5 h-5"></i></div>
            </div>
            <div id="profile-videos-grid" class="grid grid-cols-3 gap-0.5 mt-1"></div>
        </div>
        <div id="chat-screen" class="full-screen-modal">
            <div class="flex items-center p-4 border-b border-[#334155] bg-[#1e293b]">
                <i data-lucide="chevron-left" class="w-6 h-6 cursor-pointer mr-4" onclick="closeChat()"></i>
                <div class="flex items-center gap-3">
                    <div id="chat-avatar" class="w-8 h-8 rounded-full bg-gray-700 overflow-hidden"></div>
                    <div class="flex items-center gap-1">
                        <div id="chat-username" class="font-bold">Utilisateur</div>
                        <span id="chat-badge-container"></span>
                    </div>
                </div>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col bg-[#0f172a]"></div>
            <div class="p-3 bg-[#1e293b] flex items-center gap-2">
                <input type="text" id="chat-input" placeholder="Envoyer..." class="flex-1 bg-[#334155] border-none rounded-full px-4 py-2 text-sm text-white outline-none">
                <button onclick="sendMessage()" class="bg-red-600 p-2 rounded-full"><i data-lucide="send" class="w-4 h-4 text-white"></i></button>
            </div>
        </div>
        <div id="privacy-modal" class="modal-overlay">
            <div class="bg-[#1e293b] w-11/12 max-w-lg p-6 rounded-xl border border-gray-700 max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                    <h3 class="text-lg font-bold" data-i18n="privacy_modal_title">Politique de Confidentialit√©</h3>
                    <i data-lucide="x" class="cursor-pointer" onclick="closeModal('privacy-modal')"></i>
                </div>
                <div class="overflow-y-auto text-sm text-gray-300 space-y-4 pr-2">
                    <p class="font-bold text-white">Derni√®re mise √† jour : 2025</p>
                    <p>Bienvenue sur R-Videos. Votre confidentialit√© est notre priorit√©.</p>
                    <h4 class="font-bold text-white">1. Informations Collect√©es</h4>
                    <ul class="list-disc pl-5"><li>Informations de profil.</li><li>Contenu utilisateur.</li></ul>
                    <h4 class="font-bold text-white">2. Utilisation des Donn√©es</h4>
                    <p>Pour fournir et am√©liorer nos services.</p>
                    <h4 class="font-bold text-white">3. Vos Droits</h4>
                    <p>Vous avez le droit d'acc√©der √† vos donn√©es ou de supprimer votre compte.</p>
                    <h4 class="font-bold text-red-500 mt-6">4. Tol√©rance Z√©ro</h4>
                    <div class="bg-red-900/20 border border-red-800 p-3 rounded">
                        <p class="text-white font-semibold">Nous appliquons une tol√©rance z√©ro concernant les contenus abusifs. Tout contenu haineux, pornographique ou ill√©gal sera supprim√© et l'utilisateur banni.</p>
                    </div>
                </div>
                <button onclick="closeModal('privacy-modal')" class="mt-4 w-full bg-[#334155] py-2 rounded text-white font-bold" data-i18n="close_btn">Fermer</button>
            </div>
        </div>
        <div id="edit-modal" class="modal-overlay">
            <div class="bg-[#1e293b] w-11/12 max-w-md p-6 rounded-xl border border-gray-700">
                <h3 class="text-lg font-bold mb-4" data-i18n="edit_profile">Modifier le profil</h3>
                <label class="block text-xs text-gray-400 mb-1">Photo de profil</label>
                <input type="file" id="edit-file-input" accept="image/*" class="block w-full text-sm text-gray-400 file:bg-[#334155] file:text-white mb-4"/>
                <input type="text" id="edit-username" placeholder="Nom d'utilisateur" class="auth-input mb-3" data-i18n-placeholder="username_placeholder">
                <textarea id="edit-bio" placeholder="Bio" class="auth-input mb-4" rows="3"></textarea>
                <div class="flex gap-2 mb-4">
                    <button onclick="closeModal('edit-modal')" class="flex-1 py-2 bg-[#334155] rounded">Annuler</button>
                    <button id="btn-save-profile" onclick="saveProfileChanges()" class="flex-1 py-2 bg-white text-black font-bold rounded flex justify-center items-center">Enregistrer</button>
                </div>
                <div class="border-t border-gray-800 pt-4">
                    <button onclick="confirmDeleteAccount()" class="w-full text-red-500 font-bold text-sm py-2 hover:bg-red-900/20 rounded">Supprimer mon compte</button>
                </div>
            </div>
        </div>
        <div id="delete-confirm-modal" class="modal-overlay">
            <div class="bg-[#1e293b] w-10/12 max-w-sm p-6 rounded-xl border border-gray-700 text-center">
                <h3 class="text-lg font-bold mb-2 text-white text-red-500" id="delete-modal-title">Supprimer ?</h3>
                <p class="text-gray-400 text-sm mb-6">Cette action est irr√©versible.</p>
                <div class="flex gap-3">
                    <button onclick="closeModal('delete-confirm-modal')" class="flex-1 py-2 bg-[#334155] text-white rounded font-semibold text-sm">Annuler</button>
                    <button id="btn-confirm-delete" class="flex-1 py-2 bg-red-600 text-white rounded font-semibold text-sm">Supprimer</button>
                </div>
            </div>
        </div>
        <div id="logout-modal" class="modal-overlay">
            <div class="bg-[#1e293b] w-10/12 max-w-sm p-6 rounded-xl border border-gray-700 text-center">
                <h3 class="text-lg font-bold mb-2 text-white">D√©connexion</h3>
                <div class="flex gap-3">
                    <button onclick="closeModal('logout-modal')" class="flex-1 py-2 bg-[#334155] text-white rounded font-semibold text-sm">Non</button>
                    <button onclick="logout()" class="flex-1 py-2 bg-red-600 text-white rounded font-semibold text-sm">Oui</button>
                </div>
            </div>
        </div>
        <div id="upload-modal" class="modal-overlay">
            <div class="bg-[#1e293b] w-full h-full md:h-auto md:w-11/12 max-w-md p-6 md:rounded-xl flex flex-col overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold" data-i18n="upload_title">Nouvelle Publication</h3>
                    <i data-lucide="x" class="cursor-pointer" onclick="closeModal('upload-modal')"></i>
                </div>
                <div class="flex-1 flex flex-col gap-4">
                    <div class="border-2 border-dashed border-gray-700 rounded-lg h-64 flex flex-col items-center justify-center relative bg-black overflow-hidden" id="upload-preview-area">
                        <i data-lucide="upload-cloud" class="w-12 h-12 text-gray-500 mb-2"></i>
                        <p class="text-gray-500 text-sm" data-i18n="select_video">S√©lectionner une vid√©o</p>
                        <input type="file" id="video-file-input" accept="video/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="previewVideoUpload(this)">
                        <video id="video-preview" class="absolute inset-0 w-full h-full object-cover hidden" loop playsinline></video>
                        <div id="video-controls-overlay" class="absolute bottom-2 left-0 w-full px-4 hidden flex-col gap-2 z-20">
                            <div class="flex justify-between items-center mb-1">
                                <button onclick="changeVideoFile()" class="bg-gray-800/80 hover:bg-gray-700 text-white text-xs px-3 py-1.5 rounded flex items-center gap-1 border border-gray-600"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Changer</button>
                                <button onclick="deleteVideoFile()" class="bg-red-900/80 hover:bg-red-800 text-red-200 text-xs px-3 py-1.5 rounded flex items-center gap-1 border border-red-800"><i data-lucide="trash-2" class="w-3 h-3"></i> Supprimer</button>
                            </div>
                            <div class="bg-black/70 p-2 rounded-lg border border-gray-700 backdrop-blur-sm">
                                <div class="text-[10px] text-gray-400 mb-1 flex justify-between"><span>Couper (< 120s)</span><span id="trim-duration-display">0s</span></div>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="trim-start" class="bg-gray-800 text-white border border-gray-600 rounded px-2 py-1 text-xs w-20 text-center outline-none" placeholder="D√©but (s)" min="0" onchange="updateTrimPreview()">
                                    <span class="text-gray-500 text-xs">-</span>
                                    <input type="number" id="trim-end" class="bg-gray-800 text-white border border-gray-600 rounded px-2 py-1 text-xs w-20 text-center outline-none" placeholder="Fin (s)" min="0" onchange="updateTrimPreview()">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <textarea id="video-desc" placeholder="D√©cris ta vid√©o... #Hashtags" class="auth-input h-20 resize-none" data-i18n-placeholder="desc_placeholder"></textarea>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Couverture (Miniature)</label>
                            <input type="range" id="cover-slider" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer" min="0" value="0" step="0.1">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="relative">
                                <i data-lucide="map-pin" class="absolute left-2 top-2.5 w-4 h-4 text-gray-400"></i>
                                <input type="text" id="video-location" placeholder="Ajouter un lieu" class="auth-input pl-8 text-sm py-2">
                            </div>
                            <div class="relative">
                                <i data-lucide="users" class="absolute left-2 top-2.5 w-4 h-4 text-gray-400"></i>
                                <input type="text" id="video-tags" placeholder="Identifier des amis (@...)" class="auth-input pl-8 text-sm py-2">
                            </div>
                        </div>
                        <div>
                            <select id="video-visibility" class="auth-input bg-[#334155] text-sm py-2">
                                <option value="public">Public (Tout le monde)</option>
                                <option value="followers">Abonn√©s (Mes followers)</option>
                                <option value="private">Priv√© (Moi seul)</option>
                            </select>
                        </div>
                        <div class="bg-[#334155]/50 p-3 rounded-lg space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-300">Autoriser les commentaires</span>
                                <input type="checkbox" id="opt-comments" class="custom-checkbox" checked>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-300">Autoriser le t√©l√©chargement</span>
                                <input type="checkbox" id="opt-downloads" class="custom-checkbox" checked>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-300">Autoriser les Duos/Collages</span>
                                <input type="checkbox" id="opt-duet" class="custom-checkbox" checked>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="upload-status" class="text-xs text-center text-gray-400 h-4 mt-2"></div>
                <button onclick="uploadVideo()" id="btn-publish" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg mt-2 flex justify-center items-center" data-i18n="publish_btn">Publier</button>
            </div>
        </div>
        
        <div id="comments-sheet" class="bottom-sheet">
            <div class="p-4 border-b border-[#334155] flex justify-between items-center bg-[#1e293b] rounded-t-xl">
                <div class="text-sm font-bold mx-auto" data-i18n="comments_title">Commentaires</div>
                <i data-lucide="x" class="w-5 h-5 cursor-pointer absolute right-4" onclick="closeComments()"></i>
            </div>
            <div id="comments-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
            <div class="p-3 border-t border-[#334155] bg-[#0f172a] flex items-center gap-2" id="comment-input-area">
                <input type="text" id="comment-input" placeholder="Ajouter un commentaire..." class="flex-1 bg-[#1e293b] border-none rounded-full px-4 py-2 text-sm text-white outline-none" data-i18n-placeholder="comment_placeholder">
                <button onclick="sendComment()" class="text-cyan-500 font-bold text-sm px-2" data-i18n="publish_btn">Publier</button>
            </div>
            <div id="comments-disabled-msg" class="p-4 text-center text-gray-500 text-sm hidden bg-[#0f172a] border-t border-[#334155]">Les commentaires sont d√©sactiv√©s.</div>
        </div>
        <div id="options-modal" class="bottom-sheet z-50">
            <div class="p-4 border-b border-[#334155] flex justify-between items-center bg-[#1e293b] rounded-t-xl">
                <div class="text-sm font-bold mx-auto">Options</div>
                <i data-lucide="x" class="w-5 h-5 cursor-pointer absolute right-4" onclick="closeOptions()"></i>
            </div>
            <div class="p-4 flex flex-col gap-4 bg-[#0f172a] h-full" id="options-content">
                <button id="opt-share" class="flex items-center gap-3 p-3 bg-[#1e293b] rounded-lg text-white font-semibold">
                    <i data-lucide="share-2"></i> <span data-i18n="options_share">Partager</span>
                </button>
                <button id="opt-download" class="flex items-center gap-3 p-3 bg-[#1e293b] rounded-lg text-white font-semibold">
                    <i data-lucide="download"></i> <span data-i18n="options_download">T√©l√©charger</span>
                </button>
                <button id="opt-report" class="flex items-center gap-3 p-3 bg-[#1e293b] rounded-lg text-red-500 font-semibold border border-red-900">
                    <i data-lucide="flag"></i> <span data-i18n="options_report">Signaler</span>
                </button>
            </div>
        </div>
        <div id="bottom-nav" class="fixed bottom-0 left-0 w-full bg-[#0f172a] border-t border-[#334155] h-14 z-30 flex justify-around items-center text-white px-2 hidden">
            <div onclick="navigateTo('feed')" class="flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-100" id="nav-feed"><i data-lucide="home" class="w-6 h-6 fill-white"></i><span class="text-[10px]" data-i18n="nav_home">Accueil</span></div>
            <div onclick="navigateTo('discover')" class="flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-50" id="nav-discover"><i data-lucide="search" class="w-6 h-6"></i><span class="text-[10px]" data-i18n="nav_discover">D√©couvrir</span></div>
            <div onclick="openUploadModal()" class="cursor-pointer hover:scale-105 transition duration-200 flex items-center justify-center"><div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg shadow-white/20"><i data-lucide="plus" class="w-6 h-6 text-black font-bold"></i></div></div>
            <div onclick="navigateTo('inbox')" class="relative flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-50" id="nav-inbox"><div class="relative"><i data-lucide="message-square" class="w-6 h-6"></i><div id="inbox-badge" class="absolute -top-1 -right-2 bg-red-600 text-white text-[9px] font-bold px-1 py-0.5 rounded-full hidden border border-black min-w-[18px] text-center">0</div></div><span class="text-[10px]" data-i18n="nav_inbox">Bo√Æte</span></div>
            <div onclick="openMyProfile()" class="flex flex-col items-center gap-0.5 cursor-pointer nav-item opacity-50" id="nav-profile"><i data-lucide="user" class="w-6 h-6"></i><span class="text-[10px]" data-i18n="nav_profile">Profil</span></div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, deleteUser, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, updateDoc, limit, arrayUnion, arrayRemove, increment, where, deleteDoc, writeBatch, startAfter } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyCfiExPZwsF53-Ix3cCeIa3tq1MJ5359RU", authDomain: "nanofinance-9192a.firebaseapp.com", projectId: "nanofinance-9192a", storageBucket: "nanofinance-9192a.firebasestorage.app", messagingSenderId: "376434082116", appId: "1:376434082116:web:838ef702670608bc959711", measurementId: "G-9455DCWCNL" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUserData = null;
        let videoObserver = null;
        let unreadObserver = null;
        let isRegistering = false;
        let currentVideoIdForComments = null;
        let currentVideoAuthorId = null; 
        let currentProfileUid = null;
        let currentChatId = null;
        let currentChatReceiver = null;
        let viewedVideos = new Set();
        let isInitialLoad = true;
        let inboxUnsubscribe = null;
        let profileVideosData = {}; // Now reused for Trending videos as well
        let currentProfileTab = 'videos'; 
        let currentFeedMode = 'foryou';
        let totalUnreadNotifications = 0;
        let totalUnreadChats = 0;
        let feedUnsubscribes = [];
        let lastVisibleDoc = null;
        let isFetchingMore = false;
        let isFirstLoad = true;
        const BATCH_SIZE = 5; 
        // --- FONCTION UTILITAIRE POUR INCREMENTER LES CHIFFRES ---
        function updateCountUI(element, change) {
            if (!element) return;
            const currentText = element.innerText;
            if (currentText.includes('k') || currentText.includes('M')) return;
            let val = parseInt(currentText, 10);
            if (isNaN(val)) val = 0;
            val += change;
            if (val < 0) val = 0;
            element.innerText = val;
        }
        // --- NEW: ADAPTIVE BITRATE LOGIC ---
        function getNetworkConfig() {
            let config = { width: 320, quality: 'q_auto:eco' }; // Default low-mid
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                // If Data Saver is on, force lowest
                if (connection.saveData) {
                    return { width: 240, quality: 'q_auto:low' };
                }
                switch (connection.effectiveType) {
                    case 'slow-2g':
                    case '2g':
                        config = { width: 240, quality: 'q_auto:low' };
                        break;
                    case '3g':
                        config = { width: 360, quality: 'q_auto:eco' };
                        break;
                    case '4g':
                        // Even on 4g, keep it reasonable for mobile web
                        config = { width: 480, quality: 'q_auto:good' };
                        break;
                    default:
                        config = { width: 320, quality: 'q_auto:eco' };
                        break;
                }
            }
            return config;
        }
        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        
        function getWatermarkedUrl(url, username) {
            if (!url || !url.includes("cloudinary")) return url;
            const safeUser = username ? username.replace(/[^a-zA-Z0-9_.-]/g, '') : 'User';
            // Overlay 1: App Name (Top Right)
            // Overlay 2: Username (Bottom Right)
            const watermark = `l_text:Arial_40_bold:R-VIDEOS,g_north_east,x_20,y_20,co_white,o_60/l_text:Arial_25_bold:@${safeUser},g_south_east,x_20,y_20,co_white,o_80`;
            return url.replace('/upload/', `/upload/${watermark}/`);
        }
        function formatDescription(text) {
            if (!text) return "";
            let formatted = text.replace(/#(\w+)/g, '<span class="text-blue-400 font-bold">#$1</span>');
            formatted = formatted.replace(/@([\w\.\-]+)/g, '<span class="text-blue-400 font-bold cursor-pointer" onclick="findUserByHandle(\'$1\', event)">@$1</span>');
            return formatted;
        }
        // --- TASTE ALGORITHM HELPERS ---
        function extractTags(text) {
            if (!text) return [];
            const matches = text.match(/#(\w+)/g);
            return matches ? matches.map(t => t.substring(1).toLowerCase()) : [];
        }
        async function updateUserPreferences(tags) {
            if (!auth.currentUser || !tags || tags.length === 0) return;
            const userRef = doc(db, "users", auth.currentUser.uid);
            
            // Optimistic update locally
            if (!currentUserData.preferences) currentUserData.preferences = {};
            tags.forEach(tag => {
                currentUserData.preferences[tag] = (currentUserData.preferences[tag] || 0) + 1;
            });
            // Update in Firestore
            await updateDoc(userRef, { preferences: currentUserData.preferences }).catch(e => console.log(e));
        }
        function calculateViralScore(video) {
            let score = 0;
            // Engagement Weighting
            score += (video.likes || 0) * 1;
            score += (video.commentCount || 0) * 2;
            score += (video.views || 0) * 0.1;
            
            // Verified Boost (Massive)
            if (video.isVerified) score += 5000;
            
            // --- PERSONALIZED TASTE BOOST ---
            if (currentUserData && currentUserData.preferences) {
                const videoTags = extractTags(video.description);
                let interestScore = 0;
                videoTags.forEach(tag => {
                    if (currentUserData.preferences[tag]) {
                        interestScore += currentUserData.preferences[tag];
                    }
                });
                // Heavily weight personal interest
                score += interestScore * 50;
            }
            // Randomness for discovery
            score += Math.random() * 50; 
            
            return score;
        }
        window.findUserByHandle = async (handle, e) => {
            if(e) e.stopPropagation();
            const q = query(collection(db, "users"), where("username", "==", handle), limit(1));
            const snap = await getDocs(q);
            if(!snap.empty) {
                viewUserProfile(snap.docs[0].id);
            } else {
                alert("Utilisateur introuvable");
            }
        };
        window.togglePassword = (inputId, iconContainer) => {
            const input = document.getElementById(inputId);
            const eye = iconContainer.querySelector('.eye');
            const eyeOff = iconContainer.querySelector('.eye-off');
            if (input.type === "password") { input.type = "text"; eye.classList.add('hidden'); eyeOff.classList.remove('hidden'); } 
            else { input.type = "password"; eye.classList.remove('hidden'); eyeOff.classList.add('hidden'); }
        };
        window.toggleForgotPasswordMode = () => {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('forgot-password-form').classList.toggle('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('auth-error').classList.add('hidden');
            // Reset feedback box when toggling
            document.getElementById('reset-feedback').classList.add('hidden');
            document.getElementById('reset-feedback').innerText = "";
        };
        document.getElementById('btn-reset-pass').addEventListener('click', async () => {
            const email = document.getElementById('reset-email').value;
            const feedbackBox = document.getElementById('reset-feedback');
            
            feedbackBox.classList.add('hidden'); // Hide initially
            if(!email) { showAuthError("Veuillez entrer votre email."); return; }
            
            try {
                await sendPasswordResetEmail(auth, email);
                // SHOW SUCCESS BOX INSTEAD OF ALERT
                feedbackBox.classList.remove('hidden');
                feedbackBox.innerHTML = `
                    <div class="flex flex-col gap-2">
                        <span>Lien envoy√© √† <b>${escapeHtml(email)}</b> !</span>
                        <span class="text-xs">Si vous ne le voyez pas, v√©rifiez les ind√©sirables :</span>
                        <a href="https://mail.google.com/mail/u/0/#spam" target="_blank" class="bg-blue-700 hover:bg-blue-600 text-white text-center py-2 rounded font-bold text-xs border border-blue-500 shadow-md transition">
                            Ouvrir les Spams Gmail <i data-lucide="external-link" class="w-3 h-3 inline ml-1"></i>
                        </a>
                    </div>
                `;
                lucide.createIcons(); // Refresh icons for the new link
            } catch(e) {
                let errorMsg = "Erreur: " + e.message;
                if (e.code === 'auth/user-not-found') {
                    errorMsg = "Aucun compte trouv√© avec cet email.";
                } else if (e.code === 'auth/invalid-email') {
                    errorMsg = "Format d'email invalide.";
                }
                showAuthError(errorMsg);
            }
        });
        function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
            if (window.OneSignalDeferred && window.location.hostname === 'buidtelecom.github.io') {
                window.OneSignalDeferred.push(function(OneSignal) { try { OneSignal.Slidedown.promptPush(); } catch(e) {} });
            }
        }
        
        function updateGlobalBadge() {
            const total = totalUnreadNotifications + totalUnreadChats;
            const badge = document.getElementById('inbox-badge');
            if (total > 0) { badge.classList.remove('hidden'); badge.innerText = total > 99 ? "+99" : total; } else { badge.classList.add('hidden'); }
        }
        function getBadgeHtml(isVerified) {
            if (!isVerified) return '';
            return `<svg class="w-4 h-4 ml-1 inline-block align-middle" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.5 12.5C22.5 14.08 21.625 15.45 20.352 16.1C20.372 16.27 20.384 16.44 20.384 16.614C20.384 18.824 18.676 20.614 16.566 20.614C16.096 20.614 15.646 20.528 15.231 20.365C14.61 21.698 13.304 22.614 11.792 22.614C10.28 22.614 8.974 21.698 8.353 20.365C7.938 20.528 7.488 20.614 7.018 20.614C4.908 20.614 3.2 18.824 3.2 16.614C3.2 16.44 3.212 16.27 3.232 16.1C1.959 15.45 1.084 14.08 1.084 12.5C1.084 10.92 1.959 9.55 3.232 8.9C3.212 8.73 3.2 8.56 3.2 8.386C3.2 6.176 4.908 4.386 7.018 4.386C7.488 4.386 7.938 4.472 8.353 4.635C8.974 3.302 10.28 2.386 11.792 2.386C13.304 2.386 14.61 3.302 15.231 4.635C15.646 4.472 16.096 4.386 16.566 4.386C18.676 4.386 20.384 6.176 20.384 8.386C20.384 8.56 20.372 8.73 20.352 8.9C21.625 9.55 22.5 10.92 22.5 12.5Z" fill="#20D5EC"/><path d="M10.09 17.1L5.39 12.4L6.8 10.99L10.09 14.28L17.19 7.18005L18.6 8.59005L10.09 17.1Z" fill="white"/></svg>`;
        }
        function getAvatarHTML(photoURL, sizeClass = "w-full h-full") {
            if (photoURL && photoURL.length > 5) {
                const optimizedUrl = photoURL.includes('cloudinary') ? photoURL.replace('/upload/', '/upload/w_100,c_fill,q_auto:eco,f_auto/') : photoURL;
                return `<img src="${optimizedUrl}" class="${sizeClass} rounded-full object-cover border border-white">`;
            }
            return `<div class="${sizeClass} rounded-full bg-gray-700 flex items-center justify-center border border-white"><i data-lucide="user" class="text-gray-400 w-1/2 h-1/2"></i></div>`;
        }
        function formatCount(num) {
            if(!num) return "0";
            if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
            if(num >= 1000) return (num/1000).toFixed(1) + 'k';
            return num;
        }
        function getOptimizedVideoUrl(url, ignoredWidth, trimStart = 0, trimEnd = 0) {
            if (!url) return "";
            // Dynamic quality check
            const netConfig = getNetworkConfig();
            const width = netConfig.width;
            const quality = netConfig.quality;
            if (url.includes("cloudinary.com")) {
                let transformation = `${quality},f_auto,w_${width}`;
                if (trimStart > 0 || (trimEnd > 0 && trimEnd < 9999)) {
                    transformation += `,so_${trimStart}`;
                    if (trimEnd > 0) transformation += `,eo_${trimEnd}`;
                }
                return url.replace('/upload/', `/upload/${transformation}/`);
            }
            return url;
        }
        window.downloadVideo = (url, videoId, username) => {
            const finalUrl = getWatermarkedUrl(url, username);
            if(confirm("Ouvrir la vid√©o pour le t√©l√©chargement ?")) {
                window.open(finalUrl, '_blank');
            }
        };
        window.shareVideo = (url, videoId, username) => {
            const finalUrl = getWatermarkedUrl(url, username);
            
            // Helper for clipboard fallback
            const copyToClipboard = (text) => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => alert("Lien copi√© !"))
                        .catch((err) => {
                            console.warn("Clipboard API failed, trying execCommand", err);
                            fallbackCopy(text);
                        });
                } else {
                    fallbackCopy(text);
                }
            };

            const fallbackCopy = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; 
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("Lien copi√© !");
                } catch (err) {
                    alert("Erreur copie : " + err);
                }
                document.body.removeChild(textArea);
            };

            if (navigator.share) {
                navigator.share({
                    title: 'R-Videos',
                    text: `Regarde cette vid√©o de @${username} sur R-Videos !`,
                    url: finalUrl
                }).catch((err) => {
                    // Suppress AbortError (user cancelled)
                    if (err.name !== 'AbortError') {
                        console.log("Share failed, attempting copy", err);
                        copyToClipboard(finalUrl);
                    }
                });
            } else {
                copyToClipboard(finalUrl);
            }
        };
        function getVideoThumbnail(url, offset) {
            if (!url) return "";
            if (url.includes("cloudinary.com")) {
                const so = offset !== undefined ? offset : 0;
                let newUrl = url.replace('/upload/', `/upload/w_240,q_auto:eco,f_jpg,so_${so}/`);
                return newUrl.replace(/\.[^/.]+$/, ".jpg"); 
            }
            return url;
        }
        async function uploadToCloudinary(file) {
            const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, { method: 'POST', body: formData });
            const data = await response.json(); return data.secure_url;
        }
        async function sendNotification(targetUid, type, text) {
            if(targetUid === auth.currentUser.uid) return;
            try {
                const targetUser = await getDoc(doc(db, "users", targetUid));
                if (targetUser.exists()) {
                    const data = targetUser.data();
                    if (data.blockedBy && data.blockedBy.includes(auth.currentUser.uid)) return; 
                    if (data.blockedUsers && data.blockedUsers.includes(auth.currentUser.uid)) return;
                }
                await addDoc(collection(db, "users", targetUid, "notifications"), { type, text, fromUid: auth.currentUser.uid, fromUsername: currentUserData.username, fromPhoto: currentUserData.photoURL, createdAt: serverTimestamp(), read: false });
            } catch(e) { console.log("Notif error:", e); }
        }
        function subscribeToUnreadCount() {
            if (unreadObserver) unreadObserver();
            const qChats = query(collection(db, "chats"), where("participants", "array-contains", auth.currentUser.uid));
            onSnapshot(qChats, (snapshot) => {
                let chatsUnread = 0;
                snapshot.forEach(d => {
                    const c = d.data();
                    const myUnread = (c.unreadCounts && c.unreadCounts[auth.currentUser.uid]) ? c.unreadCounts[auth.currentUser.uid] : 0;
                    chatsUnread += myUnread;
                });
                totalUnreadChats = chatsUnread;
                updateGlobalBadge();
                if (!isInitialLoad) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified' || change.type === 'added') {
                            const data = change.doc.data();
                            const myUnread = (data.unreadCounts && data.unreadCounts[auth.currentUser.uid]) ? data.unreadCounts[auth.currentUser.uid] : 0;
                            if (myUnread > 0 && data.lastMessage && currentChatId !== change.doc.id) {
                                const otherId = data.participants.find(p => p !== auth.currentUser.uid);
                                const senderName = data.names ? data.names[otherId] : "Quelqu'un";
                                if ("Notification" in window && Notification.permission === "granted") {
                                    try {
                                        const notif = new Notification("Nouveau message", { body: `@${senderName}: ${data.lastMessage}`, icon: data.photos ? data.photos[otherId] : "", tag: 'chat-msg' });
                                        notif.onclick = function() { window.focus(); this.close(); };
                                    } catch(e) {}
                                }
                            }
                        }
                    });
                }
            });
            const q = query(collection(db, "users", auth.currentUser.uid, "notifications"), limit(100));
            unreadObserver = onSnapshot(q, (snapshot) => {
                let notifUnread = 0;
                snapshot.forEach(doc => { if (doc.data().read === false) notifUnread++; });
                totalUnreadNotifications = notifUnread;
                updateGlobalBadge();
                if (!isInitialLoad) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const data = change.doc.data();
                            if (data.read === false) {
                                if ("Notification" in window && Notification.permission === "granted") {
                                    try {
                                        const notif = new Notification("R-Videos", { body: `@${data.fromUsername} ${data.text}`, icon: data.fromPhoto || "", tag: 'r-videos-alert', vibrate: [200, 100, 200] });
                                        notif.onclick = function() { window.focus(); this.close(); };
                                    } catch(e) {}
                                }
                            }
                        }
                    });
                }
                isInitialLoad = false;
            });
        }
        let deleteAction = null;
        window.confirmAction = (title, action) => {
            document.getElementById('delete-modal-title').innerText = title;
            deleteAction = action;
            document.getElementById('delete-confirm-modal').classList.add('open');
        };
        document.getElementById('btn-confirm-delete').onclick = () => {
            if (deleteAction) deleteAction();
            window.closeModal('delete-confirm-modal');
        };
        window.confirmDeleteAccount = () => {
            window.closeModal('edit-modal');
            window.confirmAction("SUPPRIMER COMPTE ?", window.deleteAccount);
        };
        window.deleteAccount = async () => {
            const user = auth.currentUser;
            if (!user) return;
            try {
                await deleteDoc(doc(db, "users", user.uid));
                await deleteUser(user);
                alert("Compte supprim√© avec succ√®s.");
                window.location.reload();
            } catch (error) {
                if (error.code === 'auth/requires-recent-login') {
                    alert("Pour des raisons de s√©curit√©, veuillez vous reconnecter avant de supprimer votre compte.");
                    await signOut(auth);
                } else {
                    alert("Erreur: " + error.message);
                }
            }
        };
        window.confirmDeleteVideo = (docId) => { 
            window.confirmAction("Supprimer la vid√©o ?", async () => {
                try { await deleteDoc(doc(db, "videos", docId)); if(document.getElementById('profile-screen').classList.contains('active')) renderProfile(currentUserData, true); } catch(e) { alert("Erreur: " + e.message); }
            });
        };
        
        // --- MODIFIED TOGGLE FAVORITE WITH COUNTER ---
        window.toggleFavorite = async (docId, el) => { 
            if(!auth.currentUser) return; 
            const countSpan = el.querySelector('.fav-text');
            const isFav = el.classList.contains('favorited'); 
            const ref = doc(db, "videos", docId); 
            
            // Extract tags for algorithm
            const card = el.closest('.video-card');
            const desc = card ? card.querySelector('.line-clamp-3')?.innerText : "";
            const tags = extractTags(desc);
            if(isFav) { 
                el.classList.remove('favorited'); 
                el.querySelector('svg').classList.remove('fill-yellow-500', 'text-yellow-500'); 
                updateCountUI(countSpan, -1);
                await updateDoc(ref, { favorites: arrayRemove(auth.currentUser.uid) }); 
            } else { 
                el.classList.add('favorited'); 
                el.querySelector('svg').classList.add('fill-yellow-500', 'text-yellow-500'); 
                updateCountUI(countSpan, 1);
                await updateDoc(ref, { favorites: arrayUnion(auth.currentUser.uid) }); 
                // UPDATE PREFERENCES
                await updateUserPreferences(tags);
            } 
        };
        window.toggleAuthMode = () => { document.getElementById('login-form').classList.toggle('hidden'); document.getElementById('register-form').classList.toggle('hidden'); document.getElementById('auth-error').classList.add('hidden'); };
        function showAuthError(msg) { const err = document.getElementById('auth-error'); err.innerText = msg; err.classList.remove('hidden'); }
        window.openPrivacyPolicy = () => document.getElementById('privacy-modal').classList.add('open');
        document.getElementById('btn-register').addEventListener('click', async () => {
            const email = document.getElementById('reg-email').value, pass = document.getElementById('reg-pass').value, username = document.getElementById('reg-username').value;
            const privacyChecked = document.getElementById('reg-privacy').checked;
            document.getElementById('auth-error').classList.add('hidden');
            if (!email || !pass || !username) { showAuthError("Veuillez remplir tous les champs."); return; }
            if (!email.toLowerCase().endsWith('@gmail.com')) { showAuthError("Adresse Gmail (@gmail.com) obligatoire."); return; }
            if (!privacyChecked) { showAuthError("Veuillez accepter la politique de confidentialit√©."); return; }
            
            requestNotificationPermission();
            const btn = document.getElementById('btn-register'); const originalText = btn.innerText; btn.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mx-auto"></div>`; btn.disabled = true;
            try {
                isRegistering = true; const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const isVerified = email === VIP_EMAIL;
                
                await setDoc(doc(db, "users", cred.user.uid), { 
                    username: escapeHtml(username), email, photoURL: "", bio: "Nouveau membre", 
                    followers: [], following: [], blockedUsers: [], blockedBy: [], uid: cred.user.uid, 
                    isVerified: isVerified, 
                    createdAt: serverTimestamp() 
                });
                await updateProfile(cred.user, { displayName: username });
                
                if (email !== VIP_EMAIL) {
                    const qAdmin = query(collection(db, "users"), where("email", "==", VIP_EMAIL));
                    const snapAdmin = await getDocs(qAdmin);
                    
                    if (!snapAdmin.empty) {
                        const adminDoc = snapAdmin.docs[0];
                        const adminData = adminDoc.data();
                        const adminUid = adminData.uid;
                        await addDoc(collection(db, "users", adminUid, "notifications"), {
                            type: 'info', text: `vient de rejoindre l'application !`,
                            fromUid: cred.user.uid, fromUsername: username, fromPhoto: "", 
                            createdAt: serverTimestamp(), read: false
                        });
                        await addDoc(collection(db, "users", cred.user.uid, "notifications"), {
                            type: 'info', text: "regarde dans tes messages", fromUid: adminUid, fromUsername: adminData.username, fromPhoto: adminData.photoURL, createdAt: serverTimestamp(), read: false
                        });
                        const ids = [cred.user.uid, adminUid].sort();
                        const chatId = ids[0] + "_" + ids[1];
                        const chatRef = doc(db, "chats", chatId);
                        
                        const n = {}; n[cred.user.uid] = username; n[adminUid] = adminData.username;
                        const p = {}; p[cred.user.uid] = ""; p[adminUid] = adminData.photoURL;
                        const unread = {}; unread[cred.user.uid] = 1; unread[adminUid] = 0; 
                        const welcomeMsg = `Bienvenue sur l'application ! Voici tes acc√®s exclusifs.\nINFORMATIONS DU COMPTE NETF\n- Adresse : kmerfrud@gmail.com\n- Mdp : ralphii88`;
                        await setDoc(chatRef, { participants: [cred.user.uid, adminUid], names: n, photos: p, lastMessage: welcomeMsg, lastUpdated: serverTimestamp(), unreadCounts: unread });
                        await addDoc(collection(db, "chats", chatId, "messages"), { text: welcomeMsg, senderId: adminUid, createdAt: serverTimestamp(), read: false });
                    }
                }
                await signOut(auth); isRegistering = false; window.toggleAuthMode();
                document.getElementById('auth-success').classList.remove('hidden'); document.getElementById('login-email').value = email;
            } catch (e) { 
                isRegistering = false; showAuthError(e.message); 
            } finally { btn.innerHTML = originalText; btn.disabled = false; }
        });
        document.getElementById('btn-login').addEventListener('click', async () => { 
            document.getElementById('auth-error').classList.add('hidden');
            requestNotificationPermission();
            const btn = document.getElementById('btn-login'); const originalText = btn.innerText; btn.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mx-auto"></div>`; btn.disabled = true;
            try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); } 
            catch(e) { let msg = "Erreur de connexion."; if(e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') msg = "Email ou mot de passe incorrect."; showAuthError(msg); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        });
        window.confirmLogout = () => { document.getElementById('logout-modal').classList.add('open'); };
        window.logout = () => { 
            document.getElementById('logout-modal').classList.remove('open'); 
            if(unreadObserver) unreadObserver(); 
            if (window.OneSignalDeferred && window.location.hostname === 'buidtelecom.github.io') {
                window.OneSignalDeferred.push(function(OneSignal) { try { OneSignal.logout(); } catch(e) {} });
            }
            signOut(auth); 
        };
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');
        onAuthStateChanged(auth, async (user) => {
            if (isRegistering) return;
            
            document.getElementById('splash-screen').classList.remove('active');
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(userDoc.exists()) {
                    currentUserData = userDoc.data();
                    if (currentUserData.isBanned) {
                        alert("Votre compte a √©t√© banni pour non-respect des r√®gles.");
                        await signOut(auth);
                        return;
                    }
                    if(currentUserData && currentUserData.email === VIP_EMAIL) currentUserData.isVerified = true;
                }
                requestNotificationPermission();
                if (window.OneSignalDeferred && window.location.hostname === 'buidtelecom.github.io') {
                    window.OneSignalDeferred.push(function(OneSignal) { try { OneSignal.login(user.uid); } catch(e) {} });
                }
                document.getElementById('auth-screen').classList.remove('active'); document.getElementById('bottom-nav').classList.remove('hidden'); document.getElementById('bottom-nav').classList.add('flex');
                
                initBotSystem();
                subscribeToUnreadCount();
                const currentActive = document.querySelector('.screen.active');
                if(!currentActive || currentActive.id === 'auth-screen' || currentActive.id === 'splash-screen') { window.navigateTo('feed'); loadFeed(); }
            } else {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
                document.getElementById('auth-screen').classList.add('active'); 
                document.getElementById('bottom-nav').classList.add('hidden'); 
                document.getElementById('bottom-nav').classList.remove('flex'); 
                currentUserData = null; isInitialLoad = true;
            }
        });
        window.navigateTo = (screen) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.querySelectorAll('video').forEach(v => v.pause());
            document.getElementById(screen + '-screen').classList.add('active');
            if (screen === 'feed') setTimeout(handleVideoPlayback, 100);
            if (screen === 'inbox') switchInboxTab('activities');
            if (screen === 'discover') loadTrendingVideos(); 
            updateNavUI(screen);
        };
        function updateNavUI(screen) {
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.add('opacity-50'); el.classList.remove('opacity-100'); el.querySelector('svg')?.classList.remove('fill-white'); });
            const active = document.getElementById('nav-' + screen);
            if(active) { active.classList.remove('opacity-50'); active.classList.add('opacity-100'); if(screen==='feed') active.querySelector('svg')?.classList.add('fill-white'); }
        }
        window.switchProfileTab = (tab) => {
            currentProfileTab = tab;
            const tabVideos = document.getElementById('tab-profile-videos');
            const tabFavs = document.getElementById('tab-profile-favs');
            if (tab === 'videos') { tabVideos.classList.add('border-white'); tabVideos.classList.remove('text-gray-500', 'border-transparent'); tabFavs.classList.remove('border-white'); tabFavs.classList.add('text-gray-500', 'border-transparent'); } else { tabFavs.classList.add('border-white'); tabFavs.classList.remove('text-gray-500', 'border-transparent'); tabVideos.classList.remove('border-white'); tabVideos.classList.add('text-gray-500', 'border-transparent'); }
            if (currentProfileUid) viewUserProfile(currentProfileUid);
        };
        window.switchFeed = (mode) => {
            currentFeedMode = mode;
            const tabFollowing = document.getElementById('tab-following');
            const tabForyou = document.getElementById('tab-foryou');
            if (mode === 'following') { tabFollowing.classList.add('text-white', 'border-b-2', 'border-white', 'pb-0.5', 'shadow-lg'); tabFollowing.classList.remove('text-gray-400'); tabForyou.classList.remove('text-white', 'border-b-2', 'border-white', 'pb-0.5', 'shadow-lg'); tabForyou.classList.add('text-gray-400'); } else { tabForyou.classList.add('text-white', 'border-b-2', 'border-white', 'pb-0.5', 'shadow-lg'); tabForyou.classList.remove('text-gray-400'); tabFollowing.classList.remove('text-white', 'border-b-2', 'border-white', 'pb-0.5', 'shadow-lg'); tabFollowing.classList.add('text-gray-400'); }
            loadFeed();
        };
        window.handleBump = async (docId, authorId) => {
            if (!auth.currentUser) return;
            const ref = doc(db, "videos", docId);
            await updateDoc(ref, { createdAt: serverTimestamp() }).catch(e => console.log(e));
        };
        
        window.toggleFollowFromFeed = async (uid, btn) => {
            btn.innerHTML = "‚úîÔ∏è"; 
            btn.classList.remove('bg-red-600', 'text-white', 'px-3'); 
            btn.classList.add('text-green-500', 'px-0', 'bg-transparent', 'shadow-none'); 
            btn.disabled = true;
            if (!auth.currentUser) return;
            try { 
                const tRef = doc(db, "users", uid); 
                const mRef = doc(db, "users", auth.currentUser.uid); 
                await updateDoc(tRef, {followers:arrayUnion(auth.currentUser.uid)}); 
                await updateDoc(mRef, {following:arrayUnion(uid)}); 
                if(currentUserData.following) currentUserData.following.push(uid); 
                else currentUserData.following = [uid]; 
                sendNotification(uid, "follow", "a commenc√© √† vous suivre"); 
            } catch(e) { console.log(e); }
        };
        window.openOptions = (id, url, username, allowDL) => {
            document.getElementById('opt-share').onclick = () => { window.shareVideo(url, id, username); window.closeOptions(); };
            const btnDL = document.getElementById('opt-download');
            if(allowDL) {
                btnDL.classList.remove('hidden');
                btnDL.onclick = () => { window.downloadVideo(url, id, username); window.closeOptions(); };
            } else {
                btnDL.classList.add('hidden');
            }
            document.getElementById('opt-report').onclick = () => { window.reportVideo(id); window.closeOptions(); };
            document.getElementById('options-modal').classList.add('open');
        };
        window.closeOptions = () => document.getElementById('options-modal').classList.remove('open');
        window.reportVideo = async (docId) => {
            if(!auth.currentUser) return;
            if(!confirm("Souhaitez-vous ne plus voir les publications de cet utilisateur et signaler ce contenu ?")) return;
            const reason = prompt("Veuillez r√©diger la raison du signalement :");
            if(!reason) return;
            const card = document.querySelector(`[data-id="${docId}"]`);
            if(card) {
                card.innerHTML = "<div class='flex items-center justify-center h-full w-full bg-[#1e293b] text-gray-500 font-bold p-4 text-center'>Contenu signal√© et masqu√©.</div>";
            }
            try {
                const vidSnap = await getDoc(doc(db, "videos", docId));
                let authorId = null;
                if(vidSnap.exists()) authorId = vidSnap.data().userId;
                if(authorId) {
                    await updateDoc(doc(db, "users", auth.currentUser.uid), {
                        blockedUsers: arrayUnion(authorId),
                        following: arrayRemove(authorId)
                    });
                }
                const qAdmin = query(collection(db, "users"), where("email", "==", VIP_EMAIL));
                const snapAdmin = await getDocs(qAdmin);
                
                if(!snapAdmin.empty) {
                    const adminUid = snapAdmin.docs[0].id;
                    await addDoc(collection(db, "users", adminUid, "notifications"), {
                        type: 'report', 
                        text: `a signal√© une vid√©o (ID: ${docId}). Raison : "${escapeHtml(reason)}".`,
                        fromUid: auth.currentUser.uid,
                        fromUsername: currentUserData.username,
                        fromPhoto: currentUserData.photoURL || "",
                        targetVideoId: docId,
                        targetAuthorId: authorId,
                        createdAt: serverTimestamp(),
                        read: false
                    });
                }
                alert("Merci. Le signalement a √©t√© envoy√© √† l'administration.");
            } catch(e) { console.error(e); alert("Erreur lors de l'envoi du signalement."); }
        };
        window.toggleBan = async (targetUid) => {
            if(!confirm("√ätes-vous s√ªr de vouloir BANNIR cet utilisateur d√©finitivement ?")) return;
            try {
                await updateDoc(doc(db, "users", targetUid), { isBanned: true });
                alert("L'utilisateur a √©t√© banni.");
                if (currentProfileUid === targetUid) viewUserProfile(targetUid);
            } catch(e) { alert("Erreur bannissement: " + e.message); }
        };
        function loadFeed() {
            const container = document.getElementById('feed-container');
            feedUnsubscribes.forEach(unsub => unsub());
            feedUnsubscribes = [];
            lastVisibleDoc = null;
            isFetchingMore = false;
            isFirstLoad = true;
            
            container.innerHTML = '<div id="loading-feed" class="flex items-center justify-center h-full text-gray-500"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div></div>';
            subscribeToFeed(null);
            container.onscroll = () => {
                const { scrollTop, scrollHeight, clientHeight } = container;
                if (scrollTop + clientHeight >= scrollHeight - 200) {
                    subscribeToFeed(lastVisibleDoc);
                }
            };
        }
        async function subscribeToFeed(startAfterDoc) {
            if (!auth.currentUser || isFetchingMore) return;
            isFetchingMore = true;
            const container = document.getElementById('feed-container');
            
            let q;
            // VIRALITY LOGIC FOR "POUR TOI"
            if (currentFeedMode === 'foryou') {
                // We fetch a larger batch to sort them client-side by virality score
                const fetchSize = 12; 
                q = query(collection(db, "videos"), orderBy("createdAt", "desc"), limit(fetchSize));
                if (startAfterDoc) {
                    q = query(collection(db, "videos"), orderBy("createdAt", "desc"), startAfter(startAfterDoc), limit(fetchSize));
                }
            } else {
                // Normal chronological order for Following
                q = query(collection(db, "videos"), orderBy("createdAt", "desc"), limit(BATCH_SIZE));
                if (startAfterDoc) {
                    q = query(collection(db, "videos"), orderBy("createdAt", "desc"), startAfter(startAfterDoc), limit(BATCH_SIZE));
                }
            }
            try {
                const snapshot = await getDocs(q);
                
                const loader = document.getElementById('loading-feed');
                if(loader) loader.remove();
                if(snapshot.empty) {
                    isFetchingMore = false; 
                    if (container.children.length > 0) { 
                        // If end reached, loop for infinite feeling (optional, maybe just stop)
                        // lastVisibleDoc = null; subscribeToFeed(null); 
                    } else {
                        container.innerHTML = '<div class="h-full flex items-center justify-center text-gray-500">Aucune vid√©o.</div>'; 
                    }
                    return;
                }
                if (!snapshot.empty) lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
                // --- DATA PROCESSING & SORTING ---
                let videos = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    videos.push({ id: doc.id, ...data });
                });
                // Apply filtering first
                videos = videos.filter(data => {
                    const visibility = data.visibility || 'public';
                    if (visibility === 'private' && data.userId !== auth.currentUser.uid) return false;
                    if (visibility === 'followers' && data.userId !== auth.currentUser.uid) {
                        if (!currentUserData.following || !currentUserData.following.includes(data.userId)) return false;
                    }
                    if (currentFeedMode === 'following') {
                        if (!currentUserData || !currentUserData.following || !currentUserData.following.includes(data.userId)) return false;
                    }
                    if (currentUserData.blockedUsers && currentUserData.blockedUsers.includes(data.userId)) return false;
                    return true;
                });
                // Apply Virality Sorting ONLY for "Pour toi"
                if (currentFeedMode === 'foryou') {
                    videos.sort((a, b) => calculateViralScore(b) - calculateViralScore(a));
                }
                // Render
                videos.forEach((data) => {
                    const docId = data.id;
                    const iLiked = data.likedBy?.includes(auth.currentUser.uid);
                    const iFav = data.favorites?.includes(auth.currentUser.uid);
                    const trimStart = data.trimStart || 0;
                    const trimEnd = data.trimEnd || 0;
                    const optimizedUrl = getOptimizedVideoUrl(data.url, 480, trimStart, trimEnd);
                    const badge = getBadgeHtml(data.isVerified);
                    
                    const safeDesc = formatDescription(escapeHtml(data.description));
                    const safeUsername = escapeHtml(data.username);
                    const allowDL = (data.allowDownloads !== false); 
                    const isMe = data.userId === auth.currentUser.uid;
                    const isFollowing = currentUserData.following && currentUserData.following.includes(data.userId);
                    
                    const div = document.createElement('div');
                    div.className = "video-card w-full h-full relative snap-start bg-[#0f172a] border-b border-gray-800";
                    div.setAttribute('data-id', docId); 
                    div.setAttribute('data-src', optimizedUrl);
                    
                    div.innerHTML = `
                        <video class="w-full h-full object-cover pointer-events-none" loop playsinline preload="none" src="${optimizedUrl}"></video>
                        <div class="play-overlay absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-200 opacity-0"><div class="bg-black/40 rounded-full p-4 backdrop-blur-sm"><i data-lucide="play" class="w-12 h-12 text-white fill-white"></i></div></div>
                        <div class="absolute inset-0 z-10" onclick="togglePlay(this)" ondblclick="handleDoubleTap(event, '${docId}', '${data.userId}')"></div>
                        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-[#0f172a]/80 pointer-events-none"></div>
                        
                        <div class="absolute right-2 bottom-20 flex flex-col items-center gap-5 z-20 pb-20">
                            <div class="relative mb-2 cursor-pointer" onclick="viewUserProfile('${data.userId}')"><div class="w-12 h-12 rounded-full border-2 border-white overflow-hidden bg-black transition transform hover:scale-110">${getAvatarHTML(data.userPhotoURL, "w-full h-full object-cover")}</div></div>
                            <div class="flex flex-col items-center gap-1 cursor-pointer group ${iLiked ? 'liked' : ''}" onclick="toggleLike('${docId}', this, '${data.userId}')"><i data-lucide="heart" class="w-9 h-9 icon-shadow like-icon ${iLiked ? 'fill-red-500 text-red-500' : 'text-white fill-white'} transition-all"></i><span class="text-xs font-bold text-shadow like-count">${formatCount(data.likes)}</span></div>
                            <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="openComments('${docId}', ${data.allowComments})"><i data-lucide="message-circle" class="w-9 h-9 icon-shadow text-white fill-white"></i><span class="text-xs font-bold text-shadow comment-count">${formatCount(data.commentCount)}</span></div>
                            <div class="flex flex-col items-center gap-1 cursor-pointer ${iFav ? 'favorited' : ''}" onclick="toggleFavorite('${docId}', this)"><i data-lucide="bookmark" class="w-9 h-9 icon-shadow fav-icon ${iFav ? 'fill-yellow-500 text-yellow-500' : 'text-white fill-white'} transition-all"></i><span class="text-xs font-bold text-shadow fav-text">${formatCount(data.favorites ? data.favorites.length : 0)}</span></div>
                            <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="openOptions('${docId}', '${data.url}', '${safeUsername}', ${allowDL})">
                                <i data-lucide="more-horizontal" class="w-9 h-9 icon-shadow text-white fill-white"></i>
                            </div>
                            <div class="mt-2 relative animate-spin-slow"><div class="w-10 h-10 bg-gray-800 rounded-full border-4 border-gray-900 flex items-center justify-center overflow-hidden">${getAvatarHTML(data.userPhotoURL, "w-full h-full")}</div></div>
                        </div>
                        <div class="absolute bottom-20 left-4 right-20 z-20 text-left pointer-events-none">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-lg text-shadow cursor-pointer pointer-events-auto" onclick="viewUserProfile('${data.userId}')">@${safeUsername}</h3>
                                ${badge}
                                ${!isMe && !isFollowing ? `<button onclick="toggleFollowFromFeed('${data.userId}', this)" class="pointer-events-auto bg-red-600 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg transform transition active:scale-95">S'abonner</button>` : ''}
                            </div>
                            ${data.location ? `<div class="text-xs text-gray-300 flex items-center gap-1 mb-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${escapeHtml(data.location)}</div>` : ''}
                            <p class="text-sm mb-2 text-shadow text-gray-100 line-clamp-3 pointer-events-auto">${safeDesc}</p>
                        </div>`;
                    container.appendChild(div); 
                    
                    const v = div.querySelector('video');
                    const overlay = div.querySelector('.play-overlay');
                    
                    v.loop = true; 
                    const triggerBump = () => { if (!v.dataset.bumped) { v.dataset.bumped = "true"; handleBump(docId, data.userId); } };
                    v.addEventListener('timeupdate', () => { if (v.currentTime > 10) triggerBump(); });
                    v.addEventListener('ended', () => { 
                        v.currentTime = 0; 
                        v.play().catch(()=>{}); 
                        triggerBump(); 
                    });
                    v.addEventListener('play', () => { clearTimeout(v.playOverlayTimeout); overlay.classList.add('opacity-0'); overlay.classList.remove('opacity-100'); });
                    v.addEventListener('pause', () => { v.playOverlayTimeout = setTimeout(() => { if (v.paused) { overlay.classList.remove('opacity-0'); overlay.classList.add('opacity-100'); } }, 300); });
                    if (v.paused) { v.playOverlayTimeout = setTimeout(() => { overlay.classList.remove('opacity-0'); overlay.classList.add('opacity-100'); }, 300); }
                    
                    if(videoObserver) videoObserver.observe(div);
                });
                
                isFetchingMore = false; 
                lucide.createIcons();
                if (!videoObserver) handleVideoPlayback();
            } catch(e) {
                console.error("Erreur chargement feed:", e);
                isFetchingMore = false;
            }
        }
        window.openUploadModal = () => {
            document.getElementById('video-file-input').value = ""; document.getElementById('video-preview').src = ""; document.getElementById('video-preview').classList.add('hidden'); document.getElementById('video-controls-overlay').classList.add('hidden'); document.getElementById('video-controls-overlay').classList.remove('flex');
            const area = document.getElementById('upload-preview-area'); const icon = area.querySelector('i') || area.querySelector('svg'); if(icon) icon.classList.remove('hidden'); const text = area.querySelector('p'); if(text) text.classList.remove('hidden');
            document.getElementById('upload-modal').classList.add('open');
        };
        window.previewVideoUpload = (i) => { 
            if(i.files[0]) { 
                const v = document.getElementById('video-preview'); const fileURL = URL.createObjectURL(i.files[0]); v.src = fileURL; v.classList.remove('hidden'); 
                
                v.onloadedmetadata = () => { 
                    const dur = v.duration; 
                    const maxDur = Math.min(dur, 120); 
                    document.getElementById('trim-start').value = 0; 
                    document.getElementById('trim-end').value = Math.floor(maxDur); 
                    
                    const coverSlider = document.getElementById('cover-slider');
                    coverSlider.max = dur;
                    coverSlider.value = 0;
                    coverSlider.oninput = () => {
                        v.currentTime = coverSlider.value;
                    };
                };
                
                v.play(); 
                const area = document.getElementById('upload-preview-area'); const icon = area.querySelector('i') || area.querySelector('svg'); if(icon) icon.classList.add('hidden'); const text = area.querySelector('p'); if(text) text.classList.add('hidden');
                const controls = document.getElementById('video-controls-overlay'); controls.classList.remove('hidden'); controls.classList.add('flex');
            } 
        };
        window.changeVideoFile = () => { document.getElementById('video-file-input').click(); };
        window.deleteVideoFile = () => {
            const v = document.getElementById('video-preview'); v.pause(); v.removeAttribute('src'); v.load(); v.classList.add('hidden');
            document.getElementById('video-file-input').value = "";
            const controls = document.getElementById('video-controls-overlay'); controls.classList.add('hidden'); controls.classList.remove('flex');
            const area = document.getElementById('upload-preview-area'); const icon = area.querySelector('i') || area.querySelector('svg'); if(icon) icon.classList.remove('hidden'); const text = area.querySelector('p'); if(text) text.classList.remove('hidden');
        };
        window.updateTrimPreview = () => {
            const v = document.getElementById('video-preview'); if (!v.duration) return;
            let start = parseFloat(document.getElementById('trim-start').value) || 0; let end = parseFloat(document.getElementById('trim-end').value) || Math.min(v.duration, 120);
            if (start < 0) start = 0; if (end > v.duration) end = v.duration;
            if (end - start > 120) { end = start + 120; if (end > v.duration) { end = v.duration; start = Math.max(0, end - 120); } }
            if (end <= start + 5) { end = Math.min(v.duration, start + 5); if (end - start < 5 && start > 5) { start = end - 5; } }
            document.getElementById('trim-start').value = start.toFixed(1); document.getElementById('trim-end').value = end.toFixed(1);
            v.currentTime = start; v.play(); v.ontimeupdate = null; v.ontimeupdate = () => { if(v.currentTime >= end) { v.currentTime = start; v.play(); } };
        };
        window.uploadVideo = async () => {
            const f = document.getElementById('video-file-input').files[0]; if(!f) { alert("Veuillez s√©lectionner une vid√©o avant de publier."); return; }
            const btn = document.getElementById('btn-publish'); const originalText = btn.innerText; btn.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mx-auto"></div>`; btn.disabled = true;
            
            const trimStart = parseFloat(document.getElementById('trim-start').value) || 0; 
            const trimEnd = parseFloat(document.getElementById('trim-end').value) || 0;
            const visibility = document.getElementById('video-visibility').value;
            const thumbnailOffset = parseFloat(document.getElementById('cover-slider').value) || 0;
            const location = document.getElementById('video-location').value;
            const allowComments = document.getElementById('opt-comments').checked;
            const allowDownloads = document.getElementById('opt-downloads').checked;
            const allowDuet = document.getElementById('opt-duet').checked;
            
            let desc = document.getElementById('video-desc').value;
            const tags = document.getElementById('video-tags').value;
            if(tags && tags.length > 0) {
               const names = tags.split(',').map(t => t.trim());
               names.forEach(n => {
                   if(n.length > 0) {
                       const handle = n.startsWith('@') ? n : '@'+n;
                       if(!desc.includes(handle)) desc += ' ' + handle;
                   }
               });
            }
            try {
                const url = await uploadToCloudinary(f);
                await addDoc(collection(db, "videos"), { 
                    userId: auth.currentUser.uid, 
                    username: currentUserData.username, 
                    userPhotoURL: currentUserData.photoURL||"", 
                    url, 
                    description: escapeHtml(desc), 
                    likes: 0, 
                    likedBy: [], 
                    favorites: [], 
                    commentCount: 0, 
                    views: 0, 
                    isVerified: currentUserData.isVerified || false, 
                    createdAt: serverTimestamp(), 
                    trimStart: trimStart, 
                    trimEnd: trimEnd,
                    visibility: visibility,
                    thumbnailOffset: thumbnailOffset,
                    location: escapeHtml(location),
                    allowComments: allowComments,
                    allowDownloads: allowDownloads,
                    allowDuet: allowDuet
                });
                window.deleteVideoFile(); document.getElementById('video-desc').value = ""; document.getElementById('video-location').value = ""; document.getElementById('video-tags').value = "";
                window.closeModal('upload-modal'); navigateTo('feed');
            } catch(e) { alert(e.message); } finally { btn.disabled=false; btn.innerHTML=originalText; }
        };
        window.togglePlay = (el) => { const v = el.parentElement.querySelector('video'); v.paused ? v.play().catch(()=>{}) : v.pause(); };
        window.handleDoubleTap = (e, docId, authorId) => { e.stopPropagation(); const rect = e.target.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; const heart = document.createElement('div'); heart.innerHTML = `<i data-lucide="heart" class="w-24 h-24 fill-red-500 text-red-500"></i>`; heart.className = 'big-heart'; heart.style.left = x + 'px'; heart.style.top = y + 'px'; e.target.parentElement.appendChild(heart); lucide.createIcons(); setTimeout(() => heart.remove(), 800); const card = e.target.closest('.video-card'); const likeBtn = card.querySelector('.group'); if (!likeBtn.classList.contains('liked')) toggleLike(docId, likeBtn, authorId); };
        function handleVideoPlayback() { 
            if(videoObserver) videoObserver.disconnect(); 
            const options = { root: document.getElementById('feed-container'), threshold: 0.6 }; 
            videoObserver = new IntersectionObserver((entries) => { 
                entries.forEach(entry => { 
                    const v = entry.target.querySelector('video'); 
                    if (!v) return;
                    const sourceUrl = entry.target.getAttribute('data-src');
                    if(entry.isIntersecting) { 
                        if (!v.src && sourceUrl) {
                            v.src = sourceUrl;
                            v.load();
                        }
                        if (v.paused) { 
                            if (v.preload === 'none') { v.preload = "auto"; } 
                            v.play().catch(e=>{}); 
                        }
                        
                        const vidId = entry.target.getAttribute('data-id'); 
                        if(vidId && !viewedVideos.has(vidId)) { 
                            viewedVideos.add(vidId); 
                            updateDoc(doc(db, "videos", vidId), { views: increment(1) }).catch(e=>{}); 
                        }
                    } else { 
                        v.pause(); 
                        const container = document.getElementById('feed-container');
                        const children = Array.from(container.children);
                        const myIndex = children.indexOf(entry.target);
                        const scrollTop = container.scrollTop;
                        const cardHeight = container.clientHeight;
                        const visibleIndex = Math.round(scrollTop / cardHeight);
                        
                        if (Math.abs(myIndex - visibleIndex) > 2) {
                             v.removeAttribute('src');
                             v.load();
                        }
                    } 
                }); 
            }, options); 
            document.querySelectorAll('.video-card').forEach(c => videoObserver.observe(c)); 
        }
        // --- MODIFIED TOGGLE LIKE ---
        window.toggleLike = async (docId, el, authorId) => { 
            if(!auth.currentUser) return; 
            const countSpan = el.querySelector('.like-count');
            const isLiked = el.classList.contains('liked'); 
            const ref = doc(db, "videos", docId); 
            
            // Extract tags and update preferences on Like as well
            const card = el.closest('.video-card');
            const desc = card ? card.querySelector('.line-clamp-3')?.innerText : "";
            const tags = extractTags(desc);
            if(isLiked) { 
                el.classList.remove('liked'); 
                el.querySelector('svg').classList.remove('fill-red-500','text-red-500'); 
                el.querySelector('svg').classList.add('text-white', 'fill-white'); 
                updateCountUI(countSpan, -1);
                await updateDoc(ref, {likes: increment(-1), likedBy: arrayRemove(auth.currentUser.uid)}); 
            } else { 
                el.classList.add('liked'); 
                el.querySelector('svg').classList.add('fill-red-500','text-red-500','like-animation'); 
                el.querySelector('svg').classList.remove('text-white', 'fill-white'); 
                setTimeout(()=>el.querySelector('svg').classList.remove('like-animation'),300); 
                updateCountUI(countSpan, 1);
                await updateDoc(ref, {likes: increment(1), likedBy: arrayUnion(auth.currentUser.uid)}); 
                sendNotification(authorId, "like", "a aim√© votre vid√©o"); 
                // UPDATE PREFERENCES
                await updateUserPreferences(tags);
            } 
        };
        window.openComments = async (id, allowed = true) => { 
            currentVideoIdForComments = id; 
            const inputArea = document.getElementById('comment-input-area');
            const disabledMsg = document.getElementById('comments-disabled-msg');
            const isAllowed = (allowed !== false);
            if(isAllowed) {
                inputArea.classList.remove('hidden');
                inputArea.classList.add('flex');
                disabledMsg.classList.add('hidden');
            } else {
                inputArea.classList.add('hidden');
                inputArea.classList.remove('flex');
                disabledMsg.classList.remove('hidden');
            }
            const vidSnap = await getDoc(doc(db, "videos", id)); 
            if (vidSnap.exists()) { currentVideoAuthorId = vidSnap.data().userId; } 
            document.getElementById('comments-sheet').classList.add('open'); 
            loadComments(id); 
        };
        window.closeComments = () => { document.getElementById('comments-sheet').classList.remove('open'); currentVideoIdForComments = null; currentVideoAuthorId = null; };
        
        // --- NEW: REPLY FUNCTION ---
        window.replyToUser = (username) => {
            const inp = document.getElementById('comment-input');
            inp.value = "@" + username + " ";
            inp.focus();
        };

        function loadComments(id) { 
            const list = document.getElementById('comments-list'); list.innerHTML = "<div class='text-center text-sm py-4'>Chargement...</div>"; 
            onSnapshot(query(collection(db, `videos/${id}/comments`), orderBy("createdAt", "asc")), (snap) => { 
                let html = ""; 
                const currentLang = localStorage.getItem('rv_lang') || 'fr';
                // Get 'reply' translation, fallback to FR if missing in a specific language
                const replyText = translations[currentLang]?.reply || (currentLang === 'en' ? "Reply" : "R√©pondre");

                snap.forEach(d => { 
                    const c = d.data(); 
                    const isLiked = c.likedBy?.includes(auth.currentUser.uid); 
                    const canDelete = (c.userId === auth.currentUser.uid) || (currentVideoAuthorId === auth.currentUser.uid);
                    
                    html += `
                    <div class="flex gap-3 mb-4 w-full group relative">
                        <div class="flex-shrink-0 cursor-pointer" onclick="window.viewUserProfile('${c.userId}'); window.closeComments()">
                            ${getAvatarHTML(c.userPhotoURL, "w-8 h-8")}
                        </div>
                        <div class="flex-1 pr-6">
                            <div class="text-xs font-bold text-gray-400 cursor-pointer" onclick="window.viewUserProfile('${c.userId}'); window.closeComments()">
                                @${escapeHtml(c.username)}
                            </div>
                            <div class="text-sm break-words">${escapeHtml(c.text)}</div>
                            <button onclick="replyToUser('${escapeHtml(c.username)}')" class="text-[10px] text-gray-500 font-bold mt-1 hover:text-white transition-colors">
                                ${replyText}
                            </button>
                        </div>
                        <div class="flex flex-col items-center justify-center cursor-pointer" onclick="toggleCommentLike('${id}', '${d.id}', '${c.userId}')">
                            <i data-lucide="heart" class="w-4 h-4 ${isLiked ? 'fill-red-500 text-red-500' : 'text-gray-500'}"></i>
                            <span class="text-[10px] text-gray-500">${c.likes || 0}</span>
                        </div>
                        ${canDelete ? `<div onclick="deleteComment('${id}', '${d.id}')" class="absolute top-0 right-10 p-1 text-gray-500 hover:text-red-500 cursor-pointer"><i data-lucide="trash-2" class="w-4 h-4"></i></div>` : ''}
                    </div>`; 
                }); 
                list.innerHTML = html || "<div class='text-center text-sm py-4 text-gray-500'>Aucun commentaire.</div>"; lucide.createIcons(); 
            }); 
        }
        // --- MODIFIED DELETE COMMENT ---
        window.deleteComment = (vidId, cId) => { 
            window.confirmAction("Supprimer le commentaire ?", async () => { 
                const card = document.querySelector(`.video-card[data-id="${vidId}"]`);
                if(card) {
                    const countSpan = card.querySelector('.comment-count');
                    updateCountUI(countSpan, -1);
                }
                await deleteDoc(doc(db, `videos/${vidId}/comments`, cId)); 
                await updateDoc(doc(db, "videos", vidId), { commentCount: increment(-1) }); 
            }); 
        };
        window.toggleCommentLike = async (vidId, cId, aId) => { const ref = doc(db, `videos/${vidId}/comments`, cId); const snap = await getDoc(ref); if(!snap.exists()) return; if(snap.data().likedBy?.includes(auth.currentUser.uid)) { await updateDoc(ref, { likes: increment(-1), likedBy: arrayRemove(auth.currentUser.uid) }); } else { await updateDoc(ref, { likes: increment(1), likedBy: arrayUnion(auth.currentUser.uid) }); sendNotification(aId, "comment_like", "a aim√© votre commentaire"); } };
        
        // --- MODIFIED SEND COMMENT ---
        window.sendComment = async () => { 
            const inp = document.getElementById('comment-input'); 
            const txt = inp.value.trim(); 
            if(!txt || !currentVideoIdForComments) return; 
            inp.value = ""; 
            
            const card = document.querySelector(`.video-card[data-id="${currentVideoIdForComments}"]`);
            if(card) {
                const countSpan = card.querySelector('.comment-count');
                updateCountUI(countSpan, 1);
            }
            await addDoc(collection(db, `videos/${currentVideoIdForComments}/comments`), { text: escapeHtml(txt), userId: auth.currentUser.uid, username: currentUserData.username, userPhotoURL: currentUserData.photoURL||"", likes: 0, likedBy: [], createdAt: serverTimestamp() }); 
            await updateDoc(doc(db, "videos", currentVideoIdForComments), { commentCount: increment(1) }); 
            
            const vidSnap = await getDoc(doc(db, "videos", currentVideoIdForComments)); 
            if(vidSnap.exists()) {
                const videoOwnerId = vidSnap.data().userId;
                sendNotification(videoOwnerId, "comment", "a comment√©: " + txt);
            }

            // --- REPLY NOTIFICATION LOGIC ---
            const mentionMatch = txt.match(/^@([^\s]+)/); // Matches @Username until space
            if (mentionMatch) {
                const targetUsername = mentionMatch[1];
                try {
                    const qUser = query(collection(db, "users"), where("username", "==", targetUsername), limit(1));
                    const snapUser = await getDocs(qUser);
                    if (!snapUser.empty) {
                        const targetUid = snapUser.docs[0].id;
                        let videoOwnerId = null;
                        if(vidSnap.exists()) videoOwnerId = vidSnap.data().userId;

                        if (targetUid !== videoOwnerId) {
                             sendNotification(targetUid, "reply", "a r√©pondu √† votre commentaire : " + txt);
                        }
                    }
                } catch(e) { console.log("Reply notify error:", e); }
            }
        };
        window.switchInboxTab = (tab) => { if(inboxUnsubscribe) { inboxUnsubscribe(); inboxUnsubscribe = null; } document.getElementById('tab-activities').classList.toggle('border-b-2', tab==='activities'); document.getElementById('tab-activities').classList.toggle('text-gray-500', tab!=='activities'); document.getElementById('tab-messages').classList.toggle('border-b-2', tab==='messages'); document.getElementById('tab-messages').classList.toggle('text-gray-500', tab!=='messages'); if(tab === 'activities') loadActivities(); else loadConversations(); };
        function loadActivities() { const list = document.getElementById('inbox-content'); list.innerHTML = "Chargement..."; inboxUnsubscribe = onSnapshot(query(collection(db, "users", auth.currentUser.uid, "notifications"), orderBy("createdAt", "desc"), limit(20)), (snap) => { if(snap.empty) return list.innerHTML = "<div class='text-center text-gray-500 mt-4'>Aucune activit√©.</div>"; let html = ""; snap.forEach(d => { const n = d.data(); if(!n.read) updateDoc(doc(db, "users", auth.currentUser.uid, "notifications", d.id), {read: true}).catch(e=>{}); let icon = "bell"; let color = "text-yellow-500"; if(n.type === 'like') { icon = "heart"; color = "text-red-500"; } if(n.type === 'follow') { icon = "user-plus"; color = "text-blue-500"; } if(n.type === 'comment') { icon = "message-circle"; color = "text-green-500"; } if(n.type === 'reply') { icon = "message-square"; color = "text-indigo-500"; } if(n.type === 'info') { icon = "info"; color = "text-blue-400"; } if(n.type === 'rewatch') { icon = "repeat"; color = "text-purple-500"; } if(n.type === 'report') { icon = "alert-triangle"; color = "text-red-600"; } html += `<div onclick="viewUserProfile('${n.fromUid}')" class="flex items-center gap-3 py-2 border-b border-gray-800 cursor-pointer hover:bg-gray-900 transition"><div class="relative w-12 h-12">${getAvatarHTML(n.fromPhoto, "w-full h-full")}<div class="absolute -bottom-1 -right-1 bg-gray-900 rounded-full p-1"><i data-lucide="${icon}" class="w-4 h-4 ${color}"></i></div></div><div><p class="text-sm"><span class="font-bold">@${escapeHtml(n.fromUsername)}</span> ${escapeHtml(n.text)}</p></div></div>`; }); list.innerHTML = html; lucide.createIcons(); }); }
        function loadConversations() { const list = document.getElementById('inbox-content'); list.innerHTML = "Chargement..."; const q = query(collection(db, "chats"), where("participants", "array-contains", auth.currentUser.uid)); inboxUnsubscribe = onSnapshot(q, (snap) => { if(snap.empty) return list.innerHTML = "<div class='text-center text-gray-500 mt-4'>Aucun message.</div>"; let chats = []; snap.forEach(d => chats.push({id: d.id, ...d.data()})); chats.sort((a, b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0)); let html = ""; chats.forEach(c => { const oId = c.participants.find(p => p !== auth.currentUser.uid); if (currentUserData.blockedUsers && currentUserData.blockedUsers.includes(oId)) return; const unread = (c.unreadCounts && c.unreadCounts[auth.currentUser.uid]) || 0; if(oId && c.names) { html += `<div class="flex items-center gap-3 py-3 border-b border-gray-800 hover:bg-gray-900 relative"><div onclick="startChatWith('${oId}', '${c.names[oId]}', '${c.photos[oId]}')" class="w-12 h-12 flex-shrink-0 cursor-pointer">${getAvatarHTML(c.photos[oId], "w-full h-full")}</div><div onclick="startChatWith('${oId}', '${c.names[oId]}', '${c.photos[oId]}')" class="flex-1 min-w-0 cursor-pointer"><div class="flex justify-between"><div class="font-bold truncate">@${escapeHtml(c.names[oId])}</div>${unread > 0 ? `<div class="bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[20px] text-center">${unread > 99 ? '+99' : unread}</div>` : ''}</div><div class="text-sm text-gray-400 truncate">${escapeHtml(c.lastMessage)}</div></div><div onclick="deleteConversation('${c.id}')" class="p-2 text-gray-500 hover:text-red-500 cursor-pointer"><i data-lucide="trash-2" class="w-4 h-4"></i></div></div>`; } }); list.innerHTML = html; lucide.createIcons(); }); }
        window.deleteConversation = (chatId) => { window.confirmAction("Supprimer la conversation ?", async () => { await deleteDoc(doc(db, "chats", chatId)); }); };
        window.startChat = () => { if(currentProfileUid) startChatWith(currentProfileUid, document.getElementById('profile-handle').innerText.substring(1), document.getElementById('profile-avatar-container').querySelector('img')?.src || ""); };
        window.startChatWith = async (uid, name, photo) => { currentChatReceiver = uid; document.getElementById('chat-username').innerText = name; document.getElementById('chat-avatar').innerHTML = getAvatarHTML(photo, "w-full h-full"); const ids = [auth.currentUser.uid, uid].sort(); currentChatId = ids[0] + "_" + ids[1]; document.getElementById('chat-screen').classList.add('open'); loadMessages(currentChatId); const cref = doc(db, "chats", currentChatId); const updateMap = {}; updateMap[`unreadCounts.${auth.currentUser.uid}`] = 0; await updateDoc(cref, updateMap).catch(()=>{}); };
        window.closeChat = () => document.getElementById('chat-screen').classList.remove('open');
        function loadMessages(cId) { const box = document.getElementById('chat-messages'); box.innerHTML = ""; onSnapshot(query(collection(db, "chats", cId, "messages"), orderBy("createdAt", "asc")), (snap) => { let html = ""; const batch = writeBatch(db); let needsCommit = false; snap.forEach(d => { const m = d.data(); const isMe = m.senderId === auth.currentUser.uid; if (!isMe && !m.read) { batch.update(doc(db, "chats", cId, "messages", d.id), { read: true }); needsCommit = true; } const checkIcon = isMe ? (m.read ? `<i data-lucide="check-check" class="w-3 h-3 text-blue-500 ml-1"></i>` : `<i data-lucide="check" class="w-3 h-3 text-gray-400 ml-1"></i>`) : ''; html += `<div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}"><div class="msg-bubble ${isMe ? 'msg-me' : 'msg-other'} cursor-pointer" ondblclick="deleteMessage('${cId}', '${d.id}', ${isMe})">${escapeHtml(m.text)}</div>${isMe ? `<div class="msg-status">${checkIcon}</div>` : ''}</div>`; }); box.innerHTML = html; box.scrollTop = box.scrollHeight; lucide.createIcons(); if (needsCommit) batch.commit().catch(e => console.log(e)); }); }
        window.deleteMessage = (cId, mId, isMe) => { if (!isMe) return; window.confirmAction("Supprimer le message ?", async () => { await deleteDoc(doc(db, "chats", cId, "messages", mId)); }); }
        window.sendMessage = async () => { const inp = document.getElementById('chat-input'); const txt = inp.value.trim(); if(!txt || !currentChatId) return; inp.value = ""; const receiverDoc = await getDoc(doc(db, "users", currentChatReceiver)); if (receiverDoc.exists()) { const rData = receiverDoc.data(); if (rData.blockedUsers && rData.blockedUsers.includes(auth.currentUser.uid)) { alert("Vous ne pouvez pas envoyer de message √† cet utilisateur."); return; } } await addDoc(collection(db, "chats", currentChatId, "messages"), { text: escapeHtml(txt), senderId: auth.currentUser.uid, createdAt: serverTimestamp(), read: false }); const cref = doc(db, "chats", currentChatId); const csnap = await getDoc(cref); const updateData = { lastMessage: escapeHtml(txt), lastUpdated: serverTimestamp() }; updateData[`unreadCounts.${currentChatReceiver}`] = increment(1); if(!csnap.exists()) { const n={}; n[auth.currentUser.uid]=currentUserData.username; n[currentChatReceiver]=document.getElementById('chat-username').innerText; const p={}; p[auth.currentUser.uid]=currentUserData.photoURL; p[currentChatReceiver]=document.getElementById('chat-avatar').querySelector('img')?.src||""; const unread = {}; unread[auth.currentUser.uid]=0; unread[currentChatReceiver]=1; await setDoc(cref, {participants:[auth.currentUser.uid, currentChatReceiver], names:n, photos:p, lastMessage:escapeHtml(txt), lastUpdated:serverTimestamp(), unreadCounts: unread}); } else { await updateDoc(cref, updateData); } };
        window.toggleBlock = async () => { if (!currentProfileUid || !auth.currentUser) return; const myRef = doc(db, "users", auth.currentUser.uid); const otherRef = doc(db, "users", currentProfileUid); const myData = (await getDoc(myRef)).data(); const isBlocked = myData.blockedUsers && myData.blockedUsers.includes(currentProfileUid); if (isBlocked) { await updateDoc(myRef, { blockedUsers: arrayRemove(currentProfileUid) }); await updateDoc(otherRef, { blockedBy: arrayRemove(auth.currentUser.uid) }); document.getElementById('btn-block').innerHTML = '<i data-lucide="shield-off" class="w-4 h-4"></i>'; document.getElementById('btn-block').classList.remove('bg-red-900', 'text-white'); document.getElementById('btn-block').classList.add('text-red-500'); alert("Utilisateur d√©bloqu√©."); } else { window.confirmAction("Bloquer cet utilisateur ?", async () => { await updateDoc(myRef, { blockedUsers: arrayUnion(currentProfileUid), following: arrayRemove(currentProfileUid) }); await updateDoc(otherRef, { blockedBy: arrayUnion(auth.currentUser.uid), followers: arrayRemove(auth.currentUser.uid) }); document.getElementById('btn-block').innerHTML = '<i data-lucide="shield" class="w-4 h-4"></i>'; document.getElementById('btn-block').classList.add('bg-red-900', 'text-white'); alert("Utilisateur bloqu√©."); renderProfile(currentUserData, true); }); } lucide.createIcons(); };
        
        window.openFullVideo = (id) => { 
            const data = profileVideosData[id]; 
            if (!data) return; 
            const overlay = document.getElementById('fullscreen-video-overlay'); 
            const container = document.getElementById('fullscreen-video-container'); 
            const iLiked = data.likedBy?.includes(auth.currentUser.uid); 
            const iFav = data.favorites?.includes(auth.currentUser.uid); 
            const optimizedUrl = getOptimizedVideoUrl(data.url, 720); 
            const badge = getBadgeHtml(data.isVerified); 
            const html = `<div class="video-card w-full h-full relative bg-black flex items-center justify-center"><video class="w-full h-full object-contain" loop playsinline autoplay src="${optimizedUrl}"></video><div class="absolute inset-0 z-10" onclick="togglePlay(this)" ondblclick="handleDoubleTap(event, '${id}', '${data.userId}')"></div><div class="absolute right-2 bottom-32 flex flex-col items-center gap-6 z-20 pb-4"><div class="relative mb-4 cursor-pointer" onclick="viewUserProfile('${data.userId}'); closeFullVideo()"><div class="w-12 h-12 rounded-full border-2 border-white overflow-hidden bg-black transition transform hover:scale-110">${getAvatarHTML(data.userPhotoURL, "w-full h-full object-cover")}</div></div><div class="flex flex-col items-center gap-1 cursor-pointer group ${iLiked ? 'liked' : ''}" onclick="toggleLike('${id}', this, '${data.userId}')"><i data-lucide="heart" class="w-9 h-9 icon-shadow ${iLiked ? 'fill-red-500 text-red-500' : 'text-white fill-white'} transition-all"></i><span class="text-xs font-bold text-shadow">${formatCount(data.likes)}</span></div><div class="flex flex-col items-center gap-1 cursor-pointer" onclick="openComments('${id}')"><i data-lucide="message-circle" class="w-9 h-9 icon-shadow text-white fill-white"></i><span class="text-xs font-bold text-shadow">${formatCount(data.commentCount)}</span></div><div class="flex flex-col items-center gap-1 cursor-pointer ${iFav ? 'favorited' : ''}" onclick="toggleFavorite('${id}', this)"><i data-lucide="bookmark" class="w-9 h-9 icon-shadow ${iFav ? 'fill-yellow-500 text-yellow-500' : 'text-white fill-white'} transition-all"></i><span class="text-xs font-bold text-shadow">${formatCount(data.favorites ? data.favorites.length : 0)}</span></div><div class="flex flex-col items-center gap-1 cursor-pointer" onclick="downloadVideo('${data.url}', '${id}', '${data.username}')"><i data-lucide="download" class="w-9 h-9 icon-shadow text-white fill-white"></i><span class="text-[10px] font-bold text-shadow">T√©lec.</span></div><div class="flex flex-col items-center gap-1 cursor-pointer" onclick="shareVideo('${data.url}', '${id}', '${data.username}')"><i data-lucide="share-2" class="w-9 h-9 icon-shadow text-white fill-white"></i><span class="text-[10px] font-bold text-shadow">Partager</span></div><div class="flex flex-col items-center gap-1 cursor-pointer" onclick="reportVideo('${id}')"><i data-lucide="flag" class="w-9 h-9 icon-shadow text-white fill-white"></i><span class="text-[10px] font-bold text-shadow">Signaler</span></div></div><div class="absolute bottom-10 left-4 right-20 z-20 text-left pointer-events-none"><div class="flex items-center"><h3 class="font-bold text-lg text-shadow mb-1">@${escapeHtml(data.username)}</h3>${badge}</div><p class="text-sm mb-2 text-shadow text-gray-100 line-clamp-3">${escapeHtml(data.description)}</p></div></div>`; 
            container.innerHTML = html; 
            overlay.classList.remove('hidden'); 
            overlay.classList.add('flex'); 
            lucide.createIcons(); 
        };
        window.closeFullVideo = () => { const overlay = document.getElementById('fullscreen-video-overlay'); overlay.classList.add('hidden'); overlay.classList.remove('flex'); document.getElementById('fullscreen-video-container').innerHTML = ""; };
        window.openMyProfile = () => { if(!auth.currentUser) return; renderProfile(currentUserData, true); navigateTo('profile'); };
        window.viewUserProfile = async (uid) => { if(!auth.currentUser) return; if(uid === auth.currentUser.uid) return openMyProfile(); const snap = await getDoc(doc(db, "users", uid)); if(snap.exists()) { renderProfile(snap.data(), false); navigateTo('profile'); } };
        window.searchUsers = async (term) => { 
            const trendingContainer = document.getElementById('trending-container');
            const searchResultsContainer = document.getElementById('search-results');
            
            if(!term || term.length === 0) {
                trendingContainer.classList.remove('hidden');
                searchResultsContainer.classList.add('hidden');
                return;
            } else {
                trendingContainer.classList.add('hidden');
                searchResultsContainer.classList.remove('hidden');
            }
            if(term.length < 2) { 
                searchResultsContainer.innerHTML = "<div class='text-gray-500 text-center text-sm mt-10'>Tapez un nom...</div>"; 
                return; 
            } 
            
            const snap = await getDocs(query(collection(db, "users"), where('username', '>=', term), where('username', '<=', term + '\uf8ff'), limit(10))); 
            if(snap.empty) { 
                searchResultsContainer.innerHTML = "<div class='text-gray-500 text-center text-sm mt-10'>Aucun utilisateur.</div>"; 
                return; 
            } 
            
            let html = ""; 
            snap.forEach(doc => { 
                const u = doc.data(); 
                const badge = getBadgeHtml(u.isVerified); 
                html += `<div onclick="viewUserProfile('${u.uid}')" class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-800"><div class="w-10 h-10">${getAvatarHTML(u.photoURL, "w-full h-full")}</div><div><div class="font-bold flex items-center">@${escapeHtml(u.username)} ${badge}</div><div class="text-xs text-gray-400">${escapeHtml(u.bio || '')}</div></div></div>`; 
            }); 
            searchResultsContainer.innerHTML = html; 
            lucide.createIcons(); 
        };
        window.loadTrendingVideos = async () => {
            const grid = document.getElementById('trending-grid');
            grid.innerHTML = "<div class='col-span-3 text-center text-gray-500 mt-4'>Chargement...</div>";
            
            try {
                const q = query(collection(db, "videos"), orderBy("likes", "desc"), limit(21));
                const snap = await getDocs(q);
                
                grid.innerHTML = "";
                let count = 0;
                
                profileVideosData = {}; 
                snap.forEach(d => {
                   const v = d.data();
                   if (v.visibility === 'private' && v.userId !== auth.currentUser.uid) return;
                   count++;
                   profileVideosData[d.id] = v; 
                   const div = document.createElement('div');
                   div.className = "bg-gray-800 aspect-[3/4] relative border border-black group cursor-pointer";
                   div.onclick = () => openFullVideo(d.id);
                   div.innerHTML = `<img src="${getVideoThumbnail(v.url)}" class="w-full h-full object-cover"><div class="absolute bottom-1 left-1 flex items-center gap-1 text-[10px] font-bold text-white drop-shadow-md"><i data-lucide="heart" class="w-3 h-3 fill-white text-white"></i> ${formatCount(v.likes)}</div>`;
                   grid.appendChild(div);
                });
                if(count === 0) {
                    grid.innerHTML = "<div class='col-span-3 text-center text-gray-500 text-sm mt-4'>Aucune tendance pour le moment.</div>";
                }
                lucide.createIcons();
            } catch (e) {
                console.error(e);
                grid.innerHTML = "<div class='col-span-3 text-center text-red-500 text-sm mt-4'>Erreur de chargement.</div>";
            }
        };
        async function renderProfile(data, isMe) { 
            currentProfileUid = data.uid; document.getElementById('profile-handle').textContent = "@" + data.username; document.getElementById('profile-bio').textContent = data.bio || "Pas de bio"; document.getElementById('profile-avatar-container').innerHTML = getAvatarHTML(data.photoURL, "w-full h-full"); 
            const isCertif = data.isVerified || (data.email === VIP_EMAIL);
            document.getElementById('profile-badge-container').innerHTML = getBadgeHtml(isCertif); 
            document.getElementById('my-profile-actions').classList.toggle('hidden', !isMe); document.getElementById('other-profile-actions').classList.toggle('hidden', isMe); document.getElementById('profile-followers').innerText = formatCount(data.followers ? data.followers.length + (data.email === "virgulemili@gmail.com" ? 5300 : 0) : 0); document.getElementById('profile-following').innerText = formatCount(data.following ? data.following.length : 0); document.getElementById('profile-likes').innerText = formatCount((data.likes || 0) + (data.email === "virgulemili@gmail.com" ? 0 : 0)); 
            const adminContainer = document.getElementById('admin-actions');
            adminContainer.classList.add('hidden'); adminContainer.innerHTML = '';
            if(!isMe) { 
                const btn = document.getElementById('btn-follow'); const isF = data.followers?.includes(auth.currentUser.uid); updateFollowButtonUI(btn, isF); 
                const isBlocked = currentUserData.blockedUsers && currentUserData.blockedUsers.includes(data.uid);
                const blockBtn = document.getElementById('btn-block');
                if (isBlocked) { blockBtn.innerHTML = '<i data-lucide="shield" class="w-4 h-4"></i>'; blockBtn.classList.add('bg-red-900', 'text-white'); blockBtn.classList.remove('text-red-500'); } else { blockBtn.innerHTML = '<i data-lucide="shield-off" class="w-4 h-4"></i>'; blockBtn.classList.remove('bg-red-900', 'text-white'); blockBtn.classList.add('text-red-500'); }
                
                if (currentUserData.email === VIP_EMAIL) {
                    adminContainer.classList.remove('hidden');
                    adminContainer.innerHTML = `<button onclick="toggleBan('${data.uid}')" class="w-full bg-red-900 hover:bg-red-800 text-white font-bold py-2 rounded mt-2 border border-red-500 uppercase tracking-widest text-xs">‚ö†Ô∏è Bannir cet utilisateur</button>`;
                }
            } 
            const grid = document.getElementById('profile-videos-grid'); grid.innerHTML = "<div class='col-span-3 text-center text-gray-500'>Chargement...</div>"; 
            profileVideosData = {}; let likes = 0; const snap = await getDocs(query(collection(db, "videos"), orderBy("createdAt", "desc"))); 
            grid.innerHTML = ""; let count = 0;
            snap.forEach(d => { 
                const v = d.data(); if (v.userId === data.uid) likes += (v.likes || 0); let shouldShow = false; if (currentProfileTab === 'videos') { if (v.userId === data.uid) shouldShow = true; } else if (currentProfileTab === 'favs') { if (v.favorites && v.favorites.includes(data.uid)) shouldShow = true; }
                if (shouldShow) { count++; profileVideosData[d.id] = v; const delBtn = (isMe && v.userId === auth.currentUser.uid) ? `<div class="absolute top-1 right-1 bg-black/50 p-1 rounded-full cursor-pointer z-10" onclick="event.stopPropagation(); confirmDeleteVideo('${d.id}')"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></div>` : ''; const div = document.createElement('div'); div.className = "bg-gray-800 aspect-[3/4] relative border border-black group cursor-pointer"; div.onclick = () => openFullVideo(d.id); div.innerHTML = `${delBtn}<img src="${getVideoThumbnail(v.url)}" class="w-full h-full object-cover"><div class="absolute bottom-1 left-1 flex items-center gap-1 text-[10px] font-bold text-white drop-shadow-md"><i data-lucide="play" class="w-3 h-3 fill-white"></i> ${formatCount(v.views)}</div>`; grid.appendChild(div); } 
            }); 
            if(count === 0) grid.innerHTML = "<div class='col-span-3 text-center text-gray-500 text-sm mt-4'>Aucune vid√©o.</div>"; document.getElementById('profile-likes').innerText = formatCount(likes); lucide.createIcons(); 
        }
        function updateFollowButtonUI(btn, isFollowing) { btn.innerText = isFollowing ? "Abonn√©" : "S'abonner"; btn.className = isFollowing ? "flex-1 bg-gray-200 text-black py-2 rounded text-sm font-semibold" : "flex-1 bg-red-600 text-white py-2 rounded text-sm font-semibold"; }
        window.toggleFollow = async () => { if (!currentProfileUid || !auth.currentUser) return; const tRef = doc(db, "users", currentProfileUid); const mRef = doc(db, "users", auth.currentUser.uid); const snap = await getDoc(tRef); const isF = snap.data().followers?.includes(auth.currentUser.uid); const btn = document.getElementById('btn-follow'); const cnt = document.getElementById('profile-followers'); let n = parseInt(cnt.innerText); if (isF) { await updateDoc(tRef, {followers:arrayRemove(auth.currentUser.uid)}); await updateDoc(mRef, {following:arrayRemove(currentProfileUid)}); updateFollowButtonUI(btn, false); cnt.innerText = n-1; } else { await updateDoc(tRef, {followers:arrayUnion(auth.currentUser.uid)}); await updateDoc(mRef, {following:arrayUnion(currentProfileUid)}); updateFollowButtonUI(btn, true); cnt.innerText = n+1; sendNotification(currentProfileUid, "follow", "a commenc√© √† vous suivre"); } };
        window.openEditProfile = () => { document.getElementById('edit-username').value = currentUserData.username; document.getElementById('edit-bio').value = currentUserData.bio; document.getElementById('edit-modal').classList.add('open'); };
        window.saveProfileChanges = async () => { const btn = document.getElementById('btn-save-profile'); const originalText = btn.innerText; btn.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-black border-t-transparent rounded-full mx-auto"></div>`; btn.disabled = true; try { const file = document.getElementById('edit-file-input').files[0]; let url = currentUserData.photoURL; if(file) url = await uploadToCloudinary(file); await updateDoc(doc(db, "users", auth.currentUser.uid), { username: escapeHtml(document.getElementById('edit-username').value), bio: escapeHtml(document.getElementById('edit-bio').value), photoURL: url }); currentUserData = (await getDoc(doc(db, "users", auth.currentUser.uid))).data(); if(file) { const vidSnap = await getDocs(query(collection(db, "videos"), where("userId", "==", auth.currentUser.uid))); vidSnap.forEach(async (v) => { await updateDoc(doc(db, "videos", v.id), { userPhotoURL: url }); }); } window.closeModal('edit-modal'); renderProfile(currentUserData, true); } catch(e) { alert("Erreur: " + e.message); } finally { btn.innerHTML = originalText; btn.disabled = false; } };
        async function refreshCurrentScreen() {
            if (!auth.currentUser) return;
            const activeScreenEl = document.querySelector('.screen.active');
            if (!activeScreenEl) return;
            const activeScreen = activeScreenEl.id;
            const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
            if(userDoc.exists()) currentUserData = userDoc.data();
            if (activeScreen === 'feed-screen') { loadFeed(); } else if (activeScreen === 'profile-screen') { if (currentProfileUid) viewUserProfile(currentProfileUid); } else if (activeScreen === 'inbox-screen') { const isActivity = document.getElementById('tab-activities').classList.contains('border-b-2'); switchInboxTab(isActivity ? 'activities' : 'messages'); } else if (activeScreen === 'discover-screen') { const term = document.getElementById('search-input').value; searchUsers(term); }
        }
        const CAM_NAMES = [ "Abena", "Onana", "Mbarga", "Etoundi", "Ngannou", "Eto'o", "Milla", "Song", "Kamga", "Fotso", "Ekedi", "Njoya", "Tchami", "Mbia", "Bassogog", "Aboubakar", "N'Jie", "Olinga", "Oyongo", "Fai" ];
        const CAM_FIRST = [ "Jean", "Pierre", "Paul", "Marie", "Th√©r√®se", "Samuel", "Roger", "Patrick", "Rigobert", "Achille", "Joseph", "Emmanuel", "Chantal", "Charlotte", "Amadou", "Moussa", "Fatou", "Aisha", "Ibrahim" ];
        async function initBotSystem() { await checkAndSpawnBot(); setInterval(checkAndSpawnBot, 60000); }
        async function checkAndSpawnBot() { try { const sysRef = doc(db, "system", "bot_config"); const snap = await getDoc(sysRef); let lastRun = 0; if (snap.exists()) { lastRun = snap.data().lastRun?.toMillis() || 0; } const now = Date.now(); if (now - lastRun > 1800000) { await setDoc(sysRef, { lastRun: serverTimestamp() }); await createAndActivateBot(); } } catch (e) {} }
        async function createAndActivateBot() { const fname = CAM_FIRST[Math.floor(Math.random() * CAM_FIRST.length)]; const lname = CAM_NAMES[Math.floor(Math.random() * CAM_NAMES.length)]; const username = `${fname}_${lname}${Math.floor(Math.random()*100)}`; const botId = "bot_" + crypto.randomUUID(); await setDoc(doc(db, "users", botId), { username: username, email: `${username.toLowerCase()}@bot.local`, photoURL: "", bio: "J'aime le Cameroun üá®üá≤", followers: [], following: [], blockedUsers: [], blockedBy: [], uid: botId, isVerified: false, isBot: true, createdAt: serverTimestamp() }); const videosSnap = await getDocs(query(collection(db, "videos"), limit(20))); if (!videosSnap.empty) { const videos = videosSnap.docs; const randomVideo = videos[Math.floor(Math.random() * videos.length)]; const vidData = randomVideo.data(); if (Math.random() > 0.5) { await updateDoc(doc(db, "videos", randomVideo.id), { likes: increment(1), likedBy: arrayUnion(botId) }); if (vidData.userId !== botId) { await addDoc(collection(db, "users", vidData.userId, "notifications"), { type: 'like', text: "a aim√© votre vid√©o", fromUid: botId, fromUsername: username, fromPhoto: "", createdAt: serverTimestamp(), read: false }); } } else { const comments = ["Super !", "J'adore üòç", "Propre", "Valid√© ‚úÖ", "Cameroun oye üá®üá≤", "Mdrrr", "Top", "Bien jou√©", "Le feu üî•", "Respect"]; const txt = comments[Math.floor(Math.random() * comments.length)]; await addDoc(collection(db, `videos/${randomVideo.id}/comments`), { text: txt, userId: botId, username: username, userPhotoURL: "", likes: 0, likedBy: [], createdAt: serverTimestamp() }); await updateDoc(doc(db, "videos", randomVideo.id), { commentCount: increment(1) }); if (vidData.userId !== botId) { await addDoc(collection(db, "users", vidData.userId, "notifications"), { type: 'comment', text: "a comment√©: " + txt, fromUid: botId, fromUsername: username, fromPhoto: "", createdAt: serverTimestamp(), read: false }); } } } }
        (function() { let startY = 0; let currentY = 0; let isPulling = false; const threshold = 120; const bodyContent = document.getElementById('main-app-container'); const loader = document.getElementById('ptr-loader'); const spinner = document.getElementById('ptr-spinner'); const arrow = document.getElementById('ptr-arrow'); document.addEventListener('touchstart', (e) => { const activeScreen = document.querySelector('.screen.active'); if (!activeScreen) return; let scrollContainer = activeScreen.querySelector('.overflow-y-scroll, .overflow-y-auto'); if (!scrollContainer) scrollContainer = activeScreen; if (scrollContainer.scrollTop <= 0) { startY = e.touches[0].clientY; currentY = startY; isPulling = true; } else { isPulling = false; } }, { passive: true }); document.addEventListener('touchmove', (e) => { if (!isPulling) return; currentY = e.touches[0].clientY; const diff = currentY - startY; if (diff > 0) { const translateVal = Math.min(diff * 0.4, 150); loader.style.transform = `translateY(${translateVal - 64}px)`; bodyContent.style.transform = `translateY(${translateVal}px)`; if (translateVal > 60) { arrow.style.transform = "rotate(180deg)"; } else { arrow.style.transform = "rotate(0deg)"; } } }, { passive: true }); document.addEventListener('touchend', (e) => { if (!isPulling) return; isPulling = false; const diff = currentY - startY; if (diff > threshold) { bodyContent.style.transform = `translateY(80px)`; loader.style.transform = `translateY(20px)`; arrow.classList.add('hidden'); spinner.classList.remove('hidden'); refreshCurrentScreen().then(() => { setTimeout(() => { bodyContent.style.transform = ''; loader.style.transform = ''; arrow.classList.remove('hidden'); arrow.style.transform = "rotate(0deg)"; spinner.classList.add('hidden'); }, 800); }); } else { bodyContent.style.transform = ''; loader.style.transform = ''; } }); })();
        
        // --- TRANSLATION FIX ---
        const translations = {
            fr: {
                app_created_by: "Application cr√©√©e par", studio_name: "\"Le Studio Ralph Nyam√®\". 2025", subtitle: "R√©seau Social Vid√©o", auth_success: "Compte cr√©√© ! Connectez-vous.", email_placeholder: "Email", pass_placeholder: "Mot de passe", forgot_pass: "Mot de passe oubli√© ?", login_btn: "Se connecter", no_account: "Pas encore de compte ?", signup_link: "S'inscrire", username_placeholder: "Nom d'utilisateur", privacy_text: "En cochant cette case, j'accepte la", privacy_link: "Politique de Confidentialit√©", register_btn: "Cr√©er mon compte", has_account: "D√©j√† un compte ?", login_link: "Se connecter", reset_title: "R√©initialisation", reset_desc: "Entrez votre email pour recevoir un lien.", send_link_btn: "Envoyer le lien", back_login: "Retour √† la connexion", tab_following: "Abonnements", tab_foryou: "Pour toi", nav_discover: "D√©couvrir", search_placeholder: "Rechercher des utilisateurs...", trending_title: "Top Vid√©os", inbox_title: "Bo√Æte de r√©ception", tab_activities: "Activit√©s", tab_messages: "Messages", profile_title: "Profil", following: "Abonnements", followers: "Abonn√©s", likes: "J'aime", edit_profile: "Modifier le profil", follow_btn: "S'abonner", message_btn: "Message", privacy_modal_title: "Politique de Confidentialit√©", close_btn: "Fermer", upload_title: "Nouvelle Publication", select_video: "S√©lectionner une vid√©o", desc_placeholder: "D√©cris ta vid√©o... #Hashtags", publish_btn: "Publier", comments_title: "Commentaires", comment_placeholder: "Ajouter un commentaire...", options_share: "Partager", options_download: "T√©l√©charger", options_report: "Signaler", nav_home: "Accueil", nav_inbox: "Bo√Æte", nav_profile: "Profil", offline_title: "Pas de connexion internet", offline_desc: "V√©rifiez votre connexion et r√©essayez.", retry_btn: "R√©essayer", reply: "R√©pondre"
            },
            en: {
                app_created_by: "App created by", studio_name: "\"Ralph Nyam√® Studio\". 2025", subtitle: "Video Social Network", auth_success: "Account created! Please login.", email_placeholder: "Email", pass_placeholder: "Password", forgot_pass: "Forgot password?", login_btn: "Login", no_account: "No account yet?", signup_link: "Sign up", username_placeholder: "Username", privacy_text: "By checking this, I accept the", privacy_link: "Privacy Policy", register_btn: "Create account", has_account: "Already have an account?", login_link: "Login", reset_title: "Reset Password", reset_desc: "Enter your email to receive a link.", send_link_btn: "Send Link", back_login: "Back to login", tab_following: "Following", tab_foryou: "For You", nav_discover: "Discover", search_placeholder: "Search users...", trending_title: "Top Videos", inbox_title: "Inbox", tab_activities: "Activities", tab_messages: "Messages", profile_title: "Profile", following: "Following", followers: "Followers", likes: "Likes", edit_profile: "Edit Profile", follow_btn: "Follow", message_btn: "Message", privacy_modal_title: "Privacy Policy", close_btn: "Close", upload_title: "New Post", select_video: "Select Video", desc_placeholder: "Describe your video... #Hashtags", publish_btn: "Publish", comments_title: "Comments", comment_placeholder: "Add a comment...", options_share: "Share", options_download: "Download", options_report: "Report", nav_home: "Home", nav_inbox: "Inbox", nav_profile: "Profile", offline_title: "No Internet Connection", offline_desc: "Check your connection and try again.", retry_btn: "Retry", reply: "Reply"
            },
            es: {
                app_created_by: "Aplicaci√≥n creada por", studio_name: "\"Ralph Nyam√® Studio\". 2025", subtitle: "Red Social de Video", auth_success: "¬°Cuenta creada! Inicia sesi√≥n.", email_placeholder: "Correo electr√≥nico", pass_placeholder: "Contrase√±a", forgot_pass: "¬øOlvidaste tu contrase√±a?", login_btn: "Iniciar Sesi√≥n", no_account: "¬øNo tienes cuenta?", signup_link: "Reg√≠strate", username_placeholder: "Usuario", privacy_text: "Al marcar esto, acepto la", privacy_link: "Pol√≠tica de Privacidad", register_btn: "Crear cuenta", has_account: "¬øYa tienes cuenta?", login_link: "Iniciar Sesi√≥n", reset_title: "Restablecer contrase√±a", reset_desc: "Ingresa tu correo para recibir un enlace.", send_link_btn: "Enviar enlace", back_login: "Volver al inicio", tab_following: "Siguiendo", tab_foryou: "Para ti", nav_discover: "Descubrir", search_placeholder: "Buscar usuarios...", trending_title: "Videos Populares", inbox_title: "Bandeja de entrada", tab_activities: "Actividades", tab_messages: "Mensajes", profile_title: "Perfil", following: "Siguiendo", followers: "Seguidores", likes: "Me gusta", edit_profile: "Editar perfil", follow_btn: "Seguir", message_btn: "Mensaje", privacy_modal_title: "Pol√≠tica de Privacidad", close_btn: "Cerrar", upload_title: "Nueva Publicaci√≥n", select_video: "Seleccionar video", desc_placeholder: "Describe tu video... #Hashtags", publish_btn: "Publicar", comments_title: "Comentarios", comment_placeholder: "A√±adir un comentario...", options_share: "Compartir", options_download: "Descargar", options_report: "Reportar", nav_home: "Inicio", nav_inbox: "Bandeja", nav_profile: "Perfil", offline_title: "Sin conexi√≥n a internet", offline_desc: "Verifica tu conexi√≥n e int√©ntalo de nuevo.", retry_btn: "Reintentar", reply: "Responder"
            },
            pt: {
                app_created_by: "App criado por", studio_name: "\"Ralph Nyam√® Studio\". 2025", subtitle: "Rede Social de V√≠deo", auth_success: "Conta criada! Entre.", email_placeholder: "Email", pass_placeholder: "Senha", forgot_pass: "Esqueceu a senha?", login_btn: "Entrar", no_account: "N√£o tem conta?", signup_link: "Cadastre-se", username_placeholder: "Usu√°rio", privacy_text: "Ao marcar, aceito a", privacy_link: "Pol√≠tica de Privacidade", register_btn: "Criar conta", has_account: "J√° tem conta?", login_link: "Entrar", reset_title: "Redefinir Senha", reset_desc: "Digite seu email para receber um link.", send_link_btn: "Enviar Link", back_login: "Voltar para o login", tab_following: "Seguindo", tab_foryou: "Para Voc√™", nav_discover: "Descobrir", search_placeholder: "Buscar usu√°rios...", trending_title: "V√≠deos em Alta", inbox_title: "Caixa de Entrada", tab_activities: "Atividades", tab_messages: "Mensagens", profile_title: "Perfil", following: "Seguindo", followers: "Seguidores", likes: "Curtidas", edit_profile: "Editar Perfil", follow_btn: "Seguir", message_btn: "Mensagem", privacy_modal_title: "Pol√≠tica de Privacidade", close_btn: "Fechar", upload_title: "Nova Publica√ß√£o", select_video: "Selecionar V√≠deo", desc_placeholder: "Descreva seu v√≠deo... #Hashtags", publish_btn: "Publicar", comments_title: "Coment√°rios", comment_placeholder: "Adicionar coment√°rio...", options_share: "Compartilhar", options_download: "Baixar", options_report: "Denunciar", nav_home: "In√≠cio", nav_inbox: "Caixa", nav_profile: "Perfil", offline_title: "Sem conex√£o com a internet", offline_desc: "Verifique sua conex√£o e tente novamente.", retry_btn: "Tentar novamente", reply: "Responder"
            },
            de: {
                app_created_by: "App erstellt von", studio_name: "\"Ralph Nyam√® Studio\". 2025", subtitle: "Video Soziales Netzwerk", auth_success: "Konto erstellt! Bitte anmelden.", email_placeholder: "E-Mail", pass_placeholder: "Passwort", forgot_pass: "Passwort vergessen?", login_btn: "Anmelden", no_account: "Noch kein Konto?", signup_link: "Registrieren", username_placeholder: "Benutzername", privacy_text: "Hiermit akzeptiere ich die", privacy_link: "Datenschutzrichtlinie", register_btn: "Konto erstellen", has_account: "Hast du schon ein Konto?", login_link: "Anmelden", reset_title: "Passwort zur√ºcksetzen", reset_desc: "Gib deine E-Mail ein, um einen Link zu erhalten.", send_link_btn: "Link senden", back_login: "Zur√ºck zur Anmeldung", tab_following: "Abonniert", tab_foryou: "F√ºr dich", nav_discover: "Entdecken", search_placeholder: "Benutzer suchen...", trending_title: "Top Videos", inbox_title: "Posteingang", tab_activities: "Aktivit√§ten", tab_messages: "Nachrichten", profile_title: "Profil", following: "Abonniert", followers: "Abonnenten", likes: "Gef√§llt mir", edit_profile: "Profil bearbeiten", follow_btn: "Folgen", message_btn: "Nachricht", privacy_modal_title: "Datenschutzrichtlinie", close_btn: "Schlie√üen", upload_title: "Neuer Beitrag", select_video: "Video ausw√§hlen", desc_placeholder: "Beschreibe dein Video... #Hashtags", publish_btn: "Ver√∂ffentlichen", comments_title: "Kommentare", comment_placeholder: "Kommentar hinzuf√ºgen...", options_share: "Teilen", options_download: "Herunterladen", options_report: "Melden", nav_home: "Start", nav_inbox: "Postfach", nav_profile: "Profil", offline_title: "Keine Internetverbindung", offline_desc: "√úberpr√ºfe deine Verbindung und versuche es erneut.", retry_btn: "Wiederholen", reply: "Antworten"
            },
            tr: {
                app_created_by: "Uygulamayƒ± yapan", studio_name: "\"Ralph Nyam√® Studio\". 2025", subtitle: "Video Sosyal Aƒüƒ±", auth_success: "Hesap olu≈üturuldu! L√ºtfen giri≈ü yapƒ±n.", email_placeholder: "E-posta", pass_placeholder: "≈ûifre", forgot_pass: "≈ûifrenizi mi unuttunuz?", login_btn: "Giri≈ü Yap", no_account: "Hesabƒ±nƒ±z yok mu?", signup_link: "Kaydol", username_placeholder: "Kullanƒ±cƒ± Adƒ±", privacy_text: "Bunu i≈üaretleyerek ≈üunlarƒ± kabul ediyorum:", privacy_link: "Gizlilik Politikasƒ±", register_btn: "Hesap olu≈ütur", has_account: "Zaten hesabƒ±nƒ±z var mƒ±?", login_link: "Giri≈ü Yap", reset_title: "≈ûifreyi Sƒ±fƒ±rla", reset_desc: "Baƒülantƒ± almak i√ßin e-postanƒ±zƒ± girin.", send_link_btn: "Baƒülantƒ± G√∂nder", back_login: "Giri≈üe d√∂n", tab_following: "Takip Edilenler", tab_foryou: "Sizin ƒ∞√ßin", nav_discover: "Ke≈üfet", search_placeholder: "Kullanƒ±cƒ± ara...", trending_title: "Pop√ºler Videolar", inbox_title: "Gelen Kutusu", tab_activities: "Aktiviteler", tab_messages: "Mesajlar", profile_title: "Profil", following: "Takip Edilen", followers: "Takip√ßi", likes: "Beƒüeni", edit_profile: "Profili D√ºzenle", follow_btn: "Takip Et", message_btn: "Mesaj", privacy_modal_title: "Gizlilik Politikasƒ±", close_btn: "Kapat", upload_title: "Yeni Payla≈üƒ±m", select_video: "Video Se√ß", desc_placeholder: "Videonuzu a√ßƒ±klayƒ±n... #Hashtags", publish_btn: "Yayƒ±nla", comments_title: "Yorumlar", comment_placeholder: "Yorum ekle...", options_share: "Payla≈ü", options_download: "ƒ∞ndir", options_report: "Bildir", nav_home: "Ana Sayfa", nav_inbox: "Kutu", nav_profile: "Profil", offline_title: "ƒ∞nternet Baƒülantƒ±sƒ± Yok", offline_desc: "Baƒülantƒ±nƒ±zƒ± kontrol edin ve tekrar deneyin.", retry_btn: "Tekrar Dene", reply: "Yanƒ±tla"
            },
            id: {
                app_created_by: "Aplikasi dibuat oleh", studio_name: "\"Ralph Nyam√® Studio\". 2025", subtitle: "Jejaring Sosial Video", auth_success: "Akun dibuat! Silakan masuk.", email_placeholder: "Email", pass_placeholder: "Kata Sandi", forgot_pass: "Lupa kata sandi?", login_btn: "Masuk", no_account: "Belum punya akun?", signup_link: "Daftar", username_placeholder: "Nama Pengguna", privacy_text: "Dengan mencentang ini, saya menerima", privacy_link: "Kebijakan Privasi", register_btn: "Buat akun", has_account: "Sudah punya akun?", login_link: "Masuk", reset_title: "Atur Ulang Kata Sandi", reset_desc: "Masukkan email Anda untuk menerima tautan.", send_link_btn: "Kirim Tautan", back_login: "Kembali ke masuk", tab_following: "Mengikuti", tab_foryou: "Untuk Anda", nav_discover: "Jelajahi", search_placeholder: "Cari pengguna...", trending_title: "Video Teratas", inbox_title: "Kotak Masuk", tab_activities: "Aktivitas", tab_messages: "Pesan", profile_title: "Profil", following: "Mengikuti", followers: "Pengikut", likes: "Suka", edit_profile: "Edit Profil", follow_btn: "Ikuti", message_btn: "Pesan", privacy_modal_title: "Kebijakan Privasi", close_btn: "Tutup", upload_title: "Postingan Baru", select_video: "Pilih Video", desc_placeholder: "Jelaskan video Anda... #Hashtags", publish_btn: "Terbitkan", comments_title: "Komentar", comment_placeholder: "Tambahkan komentar...", options_share: "Bagikan", options_download: "Unduh", options_report: "Laporkan", nav_home: "Beranda", nav_inbox: "Kotak Masuk", nav_profile: "Profil", offline_title: "Tidak Ada Koneksi Internet", offline_desc: "Periksa koneksi Anda dan coba lagi.", retry_btn: "Coba Lagi", reply: "Balas"
            },
            vi: {
                app_created_by: "·ª®ng d·ª•ng ƒë∆∞·ª£c t·∫°o b·ªüi", studio_name: "\"Ralph Nyam√® Studio\". 2025", subtitle: "M·∫°ng x√£ h·ªôi video", auth_success: "T√†i kho·∫£n ƒë√£ t·∫°o! Vui l√≤ng ƒëƒÉng nh·∫≠p.", email_placeholder: "Email", pass_placeholder: "M·∫≠t kh·∫©u", forgot_pass: "Qu√™n m·∫≠t kh·∫©u?", login_btn: "ƒêƒÉng nh·∫≠p", no_account: "Ch∆∞a c√≥ t√†i kho·∫£n?", signup_link: "ƒêƒÉng k√Ω", username_placeholder: "T√™n ng∆∞·ªùi d√πng", privacy_text: "B·∫±ng c√°ch ch·ªçn m·ª•c n√†y, t√¥i ch·∫•p nh·∫≠n", privacy_link: "Ch√≠nh s√°ch b·∫£o m·∫≠t", register_btn: "T·∫°o t√†i kho·∫£n", has_account: "ƒê√£ c√≥ t√†i kho·∫£n?", login_link: "ƒêƒÉng nh·∫≠p", reset_title: "ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u", reset_desc: "Nh·∫≠p email ƒë·ªÉ nh·∫≠n li√™n k·∫øt.", send_link_btn: "G·ª≠i li√™n k·∫øt", back_login: "Quay l·∫°i ƒëƒÉng nh·∫≠p", tab_following: "ƒêang theo d√µi", tab_foryou: "D√†nh cho b·∫°n", nav_discover: "Kh√°m ph√°", search_placeholder: "T√¨m ki·∫øm ng∆∞·ªùi d√πng...", trending_title: "Video h√†ng ƒë·∫ßu", inbox_title: "H·ªôp th∆∞ ƒë·∫øn", tab_activities: "Ho·∫°t ƒë·ªông", tab_messages: "Tin nh·∫Øn", profile_title: "H·ªì s∆°", following: "ƒêang theo d√µi", followers: "Ng∆∞·ªùi theo d√µi", likes: "Th√≠ch", edit_profile: "Ch·ªânh s·ª≠a h·ªì s∆°", follow_btn: "Theo d√µi", message_btn: "Tin nh·∫Øn", privacy_modal_title: "Ch√≠nh s√°ch b·∫£o m·∫≠t", close_btn: "ƒê√≥ng", upload_title: "B√†i ƒëƒÉng m·ªõi", select_video: "Ch·ªçn video", desc_placeholder: "M√¥ t·∫£ video c·ªßa b·∫°n... #Hashtags", publish_btn: "ƒêƒÉng", comments_title: "B√¨nh lu·∫≠n", comment_placeholder: "Th√™m b√¨nh lu·∫≠n...", options_share: "Chia s·∫ª", options_download: "T·∫£i xu·ªëng", options_report: "B√°o c√°o", nav_home: "Trang ch·ªß", nav_inbox: "H·ªôp th∆∞", nav_profile: "H·ªì s∆°", offline_title: "Kh√¥ng c√≥ k·∫øt n·ªëi Internet", offline_desc: "Ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i.", retry_btn: "Th·ª≠ l·∫°i", reply: "Tr·∫£ l·ªùi"
            },
            hi: {
                app_created_by: "‡§ê‡§™ ‡§á‡§®‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ", studio_name: "\"Ralph Nyam√® Studio\". 2025", subtitle: "‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§∏‡•ã‡§∂‡§≤ ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï", auth_success: "‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ! ‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç‡•§", email_placeholder: "‡§à‡§Æ‡•á‡§≤", pass_placeholder: "‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°", forgot_pass: "‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≠‡•Ç‡§≤ ‡§ó‡§è?", login_btn: "‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç", no_account: "‡§ï‡•ã‡§à ‡§ñ‡§æ‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç?", signup_link: "‡§∏‡§æ‡§á‡§® ‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç", username_placeholder: "‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ", privacy_text: "‡§á‡§∏‡•á ‡§ö‡•á‡§ï ‡§ï‡§∞‡§ï‡•á, ‡§Æ‡•à‡§Ç ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡§§‡§æ ‡§π‡•Ç‡§Ç", privacy_link: "‡§ó‡•ã‡§™‡§®‡•Ä‡§Ø‡§§‡§æ ‡§®‡•Ä‡§§‡§ø", register_btn: "‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç", has_account: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§è‡§ï ‡§ñ‡§æ‡§§‡§æ ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à?", login_link: "‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç", reset_title: "‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç", reset_desc: "‡§≤‡§ø‡§Ç‡§ï ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§®‡§æ ‡§à‡§Æ‡•á‡§≤ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§", send_link_btn: "‡§≤‡§ø‡§Ç‡§ï ‡§≠‡•á‡§ú‡•á‡§Ç", back_login: "‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç", tab_following: "‡§´‡§º‡•â‡§≤‡•ã ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç", tab_foryou: "‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è", nav_discover: "‡§ñ‡•ã‡§ú‡•á‡§Ç", search_placeholder: "‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§ñ‡•ã‡§ú‡•á‡§Ç...", trending_title: "‡§∂‡•Ä‡§∞‡•ç‡§∑ ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã", inbox_title: "‡§á‡§®‡§¨‡•â‡§ï‡•ç‡§∏", tab_activities: "‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø‡§Ø‡§æ‡§Ç", tab_messages: "‡§∏‡§Ç‡§¶‡•á‡§∂", profile_title: "‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤", following: "‡§´‡§º‡•â‡§≤‡•ã ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç", followers: "‡§´‡§º‡•â‡§≤‡•ã‡§Ö‡§∞‡•ç‡§∏", likes: "‡§™‡§∏‡§Ç‡§¶", edit_profile: "‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç", follow_btn: "‡§´‡§º‡•â‡§≤‡•ã ‡§ï‡§∞‡•á‡§Ç", message_btn: "‡§∏‡§Ç‡§¶‡•á‡§∂", privacy_modal_title: "‡§ó‡•ã‡§™‡§®‡•Ä‡§Ø‡§§‡§æ ‡§®‡•Ä‡§§‡§ø", close_btn: "‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç", upload_title: "‡§®‡§à ‡§™‡•ã‡§∏‡•ç‡§ü", select_video: "‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç", desc_placeholder: "‡§Ö‡§™‡§®‡•á ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ï‡§æ ‡§µ‡§∞‡•ç‡§£‡§® ‡§ï‡§∞‡•á‡§Ç... #Hashtags", publish_btn: "‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç", comments_title: "‡§ü‡§ø‡§™‡•ç‡§™‡§£‡§ø‡§Ø‡§æ‡§Å", comment_placeholder: "‡§è‡§ï ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä ‡§ú‡•ã‡§°‡§º‡•á‡§Ç...", options_share: "‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç", options_download: "‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç", options_report: "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç", nav_home: "‡§π‡•ã‡§Æ", nav_inbox: "‡§á‡§®‡§¨‡•â‡§ï‡•ç‡§∏", nav_profile: "‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤", offline_title: "‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à", offline_desc: "‡§Ö‡§™‡§®‡§æ ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§î‡§∞ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", retry_btn: "‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç", reply: "‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§Ç"
            },
            zh: {
                app_created_by: "Â∫îÁî®ÂºÄÂèëËÄÖ", studio_name: "\"Ralph Nyam√® Studio\". 2025", subtitle: "ËßÜÈ¢ëÁ§æ‰∫§ÁΩëÁªú", auth_success: "Ë¥¶Êà∑Â∑≤ÂàõÂª∫ÔºÅËØ∑ÁôªÂΩï„ÄÇ", email_placeholder: "ÁîµÂ≠êÈÇÆ‰ª∂", pass_placeholder: "ÂØÜÁ†Å", forgot_pass: "ÂøòËÆ∞ÂØÜÁ†ÅÔºü", login_btn: "ÁôªÂΩï", no_account: "ËøòÊ≤°ÊúâË¥¶Êà∑Ôºü", signup_link: "Ê≥®ÂÜå", username_placeholder: "Áî®Êà∑Âêç", privacy_text: "ÂãæÈÄâÊ≠§È°πÂç≥Ë°®Á§∫ÊàëÊé•Âèó", privacy_link: "ÈöêÁßÅÊîøÁ≠ñ", register_btn: "ÂàõÂª∫Ë¥¶Êà∑", has_account: "Â∑≤ÊúâË¥¶Êà∑Ôºü", login_link: "ÁôªÂΩï", reset_title: "ÈáçÁΩÆÂØÜÁ†Å", reset_desc: "ËæìÂÖ•ÊÇ®ÁöÑÁîµÂ≠êÈÇÆ‰ª∂‰ª•Êé•Êî∂ÈìæÊé•„ÄÇ", send_link_btn: "ÂèëÈÄÅÈìæÊé•", back_login: "ËøîÂõûÁôªÂΩï", tab_following: "ÂÖ≥Ê≥®‰∏≠", tab_foryou: "Êé®Ëçê", nav_discover: "ÂèëÁé∞", search_placeholder: "ÊêúÁ¥¢Áî®Êà∑...", trending_title: "ÁÉ≠Èó®ËßÜÈ¢ë", inbox_title: "Êî∂‰ª∂ÁÆ±", tab_activities: "Âä®ÊÄÅ", tab_messages: "Ê∂àÊÅØ", profile_title: "‰∏™‰∫∫ËµÑÊñô", following: "ÂÖ≥Ê≥®", followers: "Á≤â‰∏ù", likes: "Ëé∑Ëµû", edit_profile: "ÁºñËæëËµÑÊñô", follow_btn: "ÂÖ≥Ê≥®", message_btn: "ÁßÅ‰ø°", privacy_modal_title: "ÈöêÁßÅÊîøÁ≠ñ", close_btn: "ÂÖ≥Èó≠", upload_title: "ÂèëÂ∏ÉÊñ∞Â∏ñ", select_video: "ÈÄâÊã©ËßÜÈ¢ë", desc_placeholder: "ÊèèËø∞ÊÇ®ÁöÑËßÜÈ¢ë... #ËØùÈ¢ò", publish_btn: "ÂèëÂ∏É", comments_title: "ËØÑËÆ∫", comment_placeholder: "Ê∑ªÂä†ËØÑËÆ∫...", options_share: "ÂàÜ‰∫´", options_download: "‰∏ãËΩΩ", options_report: "‰∏æÊä•", nav_home: "È¶ñÈ°µ", nav_inbox: "Êî∂‰ª∂ÁÆ±", nav_profile: "Êàë", offline_title: "Êó†ÁΩëÁªúËøûÊé•", offline_desc: "ËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•Âπ∂ÈáçËØï„ÄÇ", retry_btn: "ÈáçËØï", reply: "ÂõûÂ§ç"
            },
            ja: {
                app_created_by: "‰ΩúÊàêËÄÖ", studio_name: "\"Ralph Nyam√® Studio\". 2025", subtitle: "ÂãïÁîª„ÇΩ„Éº„Ç∑„É£„É´„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ", auth_success: "„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàêÂÆå‰∫ÜÔºÅ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", email_placeholder: "„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ", pass_placeholder: "„Éë„Çπ„ÉØ„Éº„Éâ", forgot_pass: "„Éë„Çπ„ÉØ„Éº„Éâ„Çí„ÅäÂøò„Çå„Åß„Åô„ÅãÔºü", login_btn: "„É≠„Ç∞„Ç§„É≥", no_account: "„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Å™„ÅÑ„Åß„Åô„ÅãÔºü", signup_link: "ÁôªÈå≤", username_placeholder: "„É¶„Éº„Ç∂„ÉºÂêç", privacy_text: "„Åì„Çå„ÇíÈÅ∏Êäû„Åô„Çã„Åì„Å®„Åß„ÄÅ‰ª•‰∏ã„Å´ÂêåÊÑè„Åó„Åæ„ÅôÔºö", privacy_link: "„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº", register_btn: "„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê", has_account: "„Åô„Åß„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Åô„ÅãÔºü", login_link: "„É≠„Ç∞„Ç§„É≥", reset_title: "„Éë„Çπ„ÉØ„Éº„Éâ„ÅÆ„É™„Çª„ÉÉ„Éà", reset_desc: "„É™„É≥„ÇØ„ÇíÂèó„ÅëÂèñ„Çã„Å´„ÅØ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", send_link_btn: "„É™„É≥„ÇØ„ÇíÈÄÅ‰ø°", back_login: "„É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã", tab_following: "„Éï„Ç©„É≠„Éº‰∏≠", tab_foryou: "„Åä„Åô„Åô„ÇÅ", nav_discover: "Áô∫Ë¶ã", search_placeholder: "„É¶„Éº„Ç∂„Éº„ÇíÊ§úÁ¥¢...", trending_title: "‰∫∫Ê∞óÂãïÁîª", inbox_title: "Âèó‰ø°ÁÆ±", tab_activities: "„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£", tab_messages: "„É°„ÉÉ„Çª„Éº„Ç∏", profile_title: "„Éó„É≠„Éï„Ç£„Éº„É´", following: "„Éï„Ç©„É≠„Éº‰∏≠", followers: "„Éï„Ç©„É≠„ÉØ„Éº", likes: "„ÅÑ„ÅÑ„Å≠", edit_profile: "„Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ", follow_btn: "„Éï„Ç©„É≠„Éº", message_btn: "„É°„ÉÉ„Çª„Éº„Ç∏", privacy_modal_title: "„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº", close_btn: "Èñâ„Åò„Çã", upload_title: "Êñ∞Ë¶èÊäïÁ®ø", select_video: "ÂãïÁîª„ÇíÈÅ∏Êäû", desc_placeholder: "ÂãïÁîª„ÅÆË™¨Êòé... #„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞", publish_btn: "ÊäïÁ®ø", comments_title: "„Ç≥„É°„É≥„Éà", comment_placeholder: "„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†...", options_share: "ÂÖ±Êúâ", options_download: "„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ", options_report: "ÈÄöÂ†±", nav_home: "„Éõ„Éº„É†", nav_inbox: "Âèó‰ø°ÁÆ±", nav_profile: "„Éó„É≠„Éï„Ç£„Éº„É´", offline_title: "„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„Åå„ÅÇ„Çä„Åæ„Åõ„Çì", offline_desc: "Êé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", retry_btn: "ÂÜçË©¶Ë°å", reply: "Ëøî‰ø°"
            },
            ko: {
                app_created_by: "Ïï± Ï†úÏûë:", studio_name: "\"Ralph Nyam√® Studio\". 2025", subtitle: "ÎπÑÎîîÏò§ ÏÜåÏÖú ÎÑ§Ìä∏ÏõåÌÅ¨", auth_success: "Í≥ÑÏ†ïÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§! Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.", email_placeholder: "Ïù¥Î©îÏùº", pass_placeholder: "ÎπÑÎ∞ÄÎ≤àÌò∏", forgot_pass: "ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûäÏúºÏÖ®ÎÇòÏöî?", login_btn: "Î°úÍ∑∏Ïù∏", no_account: "Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî?", signup_link: "Í∞ÄÏûÖÌïòÍ∏∞", username_placeholder: "ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ", privacy_text: "Ïù¥Í≤ÉÏùÑ Ï≤¥ÌÅ¨Ìï®ÏúºÎ°úÏç® ÎèôÏùòÌï©ÎãàÎã§:", privacy_link: "Í∞úÏù∏Ï†ïÎ≥¥ Ï≤òÎ¶¨Î∞©Ïπ®", register_btn: "Í≥ÑÏ†ï ÎßåÎì§Í∏∞", has_account: "Ïù¥ÎØ∏ Í≥ÑÏ†ïÏù¥ ÏûàÏúºÏã†Í∞ÄÏöî?", login_link: "Î°úÍ∑∏Ïù∏", reset_title: "ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï", reset_desc: "ÎßÅÌÅ¨Î•º Î∞õÏúºÎ†§Î©¥ Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.", send_link_btn: "ÎßÅÌÅ¨ Î≥¥ÎÇ¥Í∏∞", back_login: "Î°úÍ∑∏Ïù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞", tab_following: "ÌåîÎ°úÏûâ", tab_foryou: "Ï∂îÏ≤ú", nav_discover: "ÌÉêÏÉâ", search_placeholder: "ÏÇ¨Ïö©Ïûê Í≤ÄÏÉâ...", trending_title: "Ïù∏Í∏∞ ÎèôÏòÅÏÉÅ", inbox_title: "Î≥¥Í¥ÄÌï®", tab_activities: "ÌôúÎèô", tab_messages: "Î©îÏãúÏßÄ", profile_title: "ÌîÑÎ°úÌïÑ", following: "ÌåîÎ°úÏûâ", followers: "ÌåîÎ°úÏõå", likes: "Ï¢ãÏïÑÏöî", edit_profile: "ÌîÑÎ°úÌïÑ Ìé∏Ïßë", follow_btn: "ÌåîÎ°úÏö∞", message_btn: "Î©îÏãúÏßÄ", privacy_modal_title: "Í∞úÏù∏Ï†ïÎ≥¥ Ï≤òÎ¶¨Î∞©Ïπ®", close_btn: "Îã´Í∏∞", upload_title: "ÏÉà Í≤åÏãúÎ¨º", select_video: "ÎèôÏòÅÏÉÅ ÏÑ†ÌÉù", desc_placeholder: "ÎèôÏòÅÏÉÅÏùÑ ÏÑ§Î™ÖÌïòÏÑ∏Ïöî... #Ìï¥ÏãúÌÉúÍ∑∏", publish_btn: "Í≤åÏãú", comments_title: "ÎåìÍ∏Ä", comment_placeholder: "ÎåìÍ∏Ä Ï∂îÍ∞Ä...", options_share: "Í≥µÏú†", options_download: "Îã§Ïö¥Î°úÎìú", options_report: "Ïã†Í≥†", nav_home: "Ìôà", nav_inbox: "Î≥¥Í¥ÄÌï®", nav_profile: "ÌîÑÎ°úÌïÑ", offline_title: "Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ ÏóÜÏùå", offline_desc: "Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.", retry_btn: "Ïû¨ÏãúÎèÑ", reply: "ÎãµÏû•"
            }
        };

        window.changeLanguage = (lang) => {
            localStorage.setItem('rv_lang', lang);
            let t = translations[lang];
            // Default to EN for unsupported languages in this quick fix
            if (!t) t = translations['en']; 
            
            // Special fallback for FR if selected explicitly
            if (lang === 'fr') t = translations['fr'];

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.innerText = t[key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) el.placeholder = t[key];
            });
            
            // Sync selector UI
            const sel = document.getElementById('lang-selector');
            if(sel) sel.value = lang;
        };

        window.addEventListener('load', () => {
            const savedLang = localStorage.getItem('rv_lang') || 'fr';
            document.getElementById('lang-selector').value = savedLang;
            window.changeLanguage(savedLang);
            if(!navigator.onLine) {
                document.getElementById('splash-screen').classList.remove('active');
                document.getElementById('offline-screen').classList.add('active');
            }
        });
        
        lucide.createIcons();
    </script>
</body>
</html>